<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Parroquial - San Jos√©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-hover-effect { transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; }
        .card-hover-effect:hover { transform: translateY(-5px); }
        .hidden { display: none; }
        .btn-gradient {
            transition: all 0.3s ease-in-out;
        }
        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards;
        }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        /* Loading Spinner */
        #loader {
            background: rgba(0, 0, 0, 0.6);
        }
        /* Connection Status Banner */
        #connection-status {
            z-index: 200;
            transform: translateY(100%);
        }
        #connection-status.show {
            transform: translateY(0);
        }
        /* View Transitions */
        .view-container {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            will-change: opacity, transform;
        }
        .view-container:not(.visible) {
            opacity: 0;
            transform: translateY(15px);
        }
        .view-container.visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* Notification Bell */
        #notification-bell-container {
            position: relative;
        }
        #notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            background-color: #ef4444; /* red-500 */
            border-radius: 9999px;
            border: 2px solid white;
        }
        #reminders-panel {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <!-- LOADING OVERLAY -->
    <div id="loader" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-blue-500"></div>
    </div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container"></div>

    <!-- LOGIN VIEW -->
    <section id="login-view" class="flex items-center justify-center h-screen">
        <div class="w-full max-w-md bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg text-center">
            <h2 class="text-3xl font-bold mb-6">Acceso a Gesti√≥n Parroquial</h2>
            <div class="mb-6">
                <label for="password-input" class="block text-sm font-medium mb-2">Clave de Administrador</label>
                <input type="password" id="password-input" class="w-full p-3 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700 text-center">
            </div>
            <button id="login-btn" class="w-full btn-gradient bg-gradient-to-r from-blue-500 to-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline">Ingresar</button>
        </div>
    </section>

    <div id="app-container" class="hidden">
        <!-- NAVIGATION MENU -->
        <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold">Gesti√≥n Parroquial</h1>
                <div class="flex items-center gap-4">
                    <div id="notification-bell-container">
                        <button id="notification-bell-btn" class="text-slate-600 dark:text-slate-300 hover:text-blue-500 dark:hover:text-blue-400 focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            <div id="notification-badge" class="hidden"></div>
                        </button>
                        <div id="reminders-panel" class="hidden absolute right-0 mt-2 w-80 bg-white dark:bg-slate-700 rounded-lg shadow-xl p-4 origin-top-right">
                            <h4 class="font-bold text-md mb-2">Pr√≥ximos Recordatorios</h4>
                            <ul id="reminders-list" class="space-y-2 text-sm max-h-64 overflow-y-auto">
                               <!-- Reminders will be injected here -->
                            </ul>
                        </div>
                    </div>
                    <a href="#" id="back-to-panel-btn" class="btn-gradient bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">Volver al Panel</a>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-6">

            <!-- MAIN VIEW -->
            <main id="main-view" class="view-container">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- General Income and Expenses Block -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg flex flex-col">
                        <div class="text-6xl text-center mb-4">‚õ™</div>
                        <h2 class="text-2xl font-bold mb-4 text-center">Ingresos y Egresos Generales</h2>
                        <div class="grid grid-cols-1 gap-4 mb-6">
                            <button data-action="load-data" data-block="general" class="card-hover-effect btn-gradient bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl shadow-lg text-center">Cargar Datos</button>
                        </div>
                         <div class="mb-4">
                            <input type="text" id="search-general-input" placeholder="Buscar por fecha (dd/mm/aaaa)..." class="w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                        </div>
                        <div id="history-general-container" class="space-y-4 min-h-[24rem] flex-grow flex flex-col justify-between"></div>
                    </div>

                    <!-- Bank Block -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg flex flex-col">
                        <div class="text-6xl text-center mb-4">üè¶</div>
                        <h2 class="text-2xl font-bold mb-4 text-center">Banco</h2>
                        <div class="grid grid-cols-1 gap-4 mb-6">
                            <button data-action="load-data" data-block="banco" class="card-hover-effect btn-gradient bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl shadow-lg text-center">Cargar Datos</button>
                        </div>
                         <div class="mb-4">
                            <input type="text" id="search-banco-input" placeholder="Buscar por fecha (dd/mm/aaaa)..." class="w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                        </div>
                        <div id="history-banco-container" class="space-y-4 min-h-[24rem] flex-grow flex flex-col justify-between"></div>
                    </div>

                    <!-- Information Block -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg flex flex-col">
                        <div class="text-6xl text-center mb-4">‚ÑπÔ∏è</div>
                        <h2 class="text-2xl font-bold mb-4 text-center">Informaci√≥n y Configuraci√≥n</h2>
                        <div class="flex flex-col gap-4 mb-6 flex-grow justify-center">
                            <button id="envios-colectas-btn" class="card-hover-effect btn-gradient bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-4 rounded-xl shadow-lg text-center">Fecha de Env√≠os de Colectas</button>
                            <button id="aportes-btn" class="card-hover-effect btn-gradient bg-gradient-to-r from-teal-500 to-cyan-500 text-white p-4 rounded-xl shadow-lg text-center">Sueldos y Aportes</button>
                            <button id="manage-categories-btn" class="card-hover-effect btn-gradient bg-gradient-to-r from-slate-500 to-slate-600 text-white p-4 rounded-xl shadow-lg text-center">Gestionar Categor√≠as</button>
                            <button id="manage-reminders-btn" class="card-hover-effect btn-gradient bg-gradient-to-r from-amber-500 to-orange-500 text-white p-4 rounded-xl shadow-lg text-center">Gestionar Recordatorios</button>
                        </div>
                    </div>
                </div>

                <div class="mt-8 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4">Balance</h3>
                    <button id="balance-btn" class="w-full btn-gradient bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg hover:from-purple-700 hover:to-indigo-700">Ver Balance Completo</button>
                </div>

                 <div class="mt-8 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4">Reporte por Rango</h3>
                    <div class="flex flex-col md:flex-row gap-4 items-center">
                        <input type="date" id="start-date-filter" class="flex-1 p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                        <input type="date" id="end-date-filter" class="flex-1 p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                        <button id="search-range-btn" class="w-full md:w-auto btn-gradient bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:from-blue-700 hover:to-blue-800">Buscar</button>
                        <button id="download-range-pdf-btn" class="w-full md:w-auto btn-gradient bg-gradient-to-r from-red-600 to-red-700 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:from-red-700 hover:to-red-800">Descargar PDF</button>
                    </div>
                    <div id="range-results-container" class="mt-6 hidden">
                        <!-- Results will be injected here -->
                    </div>
                </div>
            </main>

            <!-- DATE PROMPT VIEW -->
            <section id="date-prompt-view" class="view-container hidden max-w-2xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
                <h2 id="date-prompt-title" class="text-3xl font-bold mb-6 text-center"></h2>
                <div class="mb-6">
                    <label for="entry-date-input" class="block text-sm font-medium text-center">Confirme la fecha de carga</label>
                    <input type="date" id="entry-date-input" required class="mt-1 mx-auto block w-full max-w-xs p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                </div>
                <div class="flex flex-col gap-4">
                    <button id="continue-to-form-btn" class="w-full btn-gradient bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:from-blue-600 hover:to-blue-700">Continuar</button>
                    <button id="back-from-date-prompt-btn" class="w-full btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
                </div>
            </section>

            <!-- DATA ENTRY VIEW -->
            <section id="data-entry-view" class="view-container hidden max-w-7xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
                <h2 id="data-entry-title" class="text-3xl font-bold mb-4 text-center"></h2>
                <div class="mb-6">
                    <label for="shared-date" class="block text-sm font-medium text-center">Fecha de Operaciones</label>
                    <input type="date" id="shared-date" required class="mt-1 mx-auto block w-full max-w-xs p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Ingreso Form -->
                    <div class="bg-gray-50 dark:bg-slate-700 p-6 rounded-xl">
                        <h3 class="text-2xl font-bold mb-4 text-green-500">Registrar Ingreso</h3>
                        <form id="ingreso-form" class="space-y-4">
                            <div>
                                <label for="ingreso-categoria" class="block text-sm font-medium">Categor√≠a</label>
                                <select id="ingreso-categoria" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600"></select>
                            </div>
                            <div>
                                <label for="ingreso-descripcion" class="block text-sm font-medium">Descripci√≥n</label>
                                <textarea id="ingreso-descripcion" rows="2" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600"></textarea>
                            </div>
                            <div>
                                <label for="ingreso-monto" class="block text-sm font-medium">Monto</label>
                                <input type="number" id="ingreso-monto" required min="0" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                            </div>
                            <button type="button" id="add-ingreso-btn" class="w-full btn-gradient bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold py-2 rounded-xl shadow-lg hover:from-green-600 hover:to-green-700">Confirmar y Cargar Otro</button>
                        </form>
                    </div>
                    <!-- Egreso Form -->
                    <div class="bg-gray-50 dark:bg-slate-700 p-6 rounded-xl">
                        <h3 class="text-2xl font-bold mb-4 text-red-500">Registrar Egreso</h3>
                        <form id="egreso-form" class="space-y-4">
                             <div>
                                <label for="egreso-categoria" class="block text-sm font-medium">Categor√≠a</label>
                                <select id="egreso-categoria" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600"></select>
                            </div>
                            <div>
                                <label for="egreso-descripcion" class="block text-sm font-medium">Descripci√≥n</label>
                                <textarea id="egreso-descripcion" rows="2" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600"></textarea>
                            </div>
                            <div>
                                <label for="egreso-monto" class="block text-sm font-medium">Monto</label>
                                <input type="number" id="egreso-monto" required min="0" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                            </div>
                            <button type="button" id="add-egreso-btn" class="w-full btn-gradient bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold py-2 rounded-xl shadow-lg hover:from-red-600 hover:to-red-700">Confirmar y Cargar Otro</button>
                        </form>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-2">Registros a Guardar</h3>
                    <div id="added-transactions-list" class="space-y-2 max-h-48 overflow-y-auto bg-gray-100 dark:bg-slate-900 p-4 rounded-lg"></div>
                </div>

                <div class="mt-8 flex flex-col md:flex-row gap-4 justify-end">
                    <button id="save-all-btn" class="btn-gradient bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:from-blue-700 hover:to-blue-800">Guardar los Datos</button>
                    <button id="back-from-form-btn" class="btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
                </div>
            </section>

            <!-- EDIT DAY VIEW -->
            <section id="edit-day-view" class="view-container hidden max-w-4xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
                <h2 id="edit-day-title" class="text-3xl font-bold mb-6 text-center"></h2>
                <div id="edit-day-list" class="space-y-3"></div>
                <button id="back-from-edit-day-btn" class="mt-8 w-full btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
            </section>
            
            <!-- COLLECTIONS VIEW -->
            <section id="envio-colectas-view" class="view-container hidden max-w-4xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">Fechas de Env√≠o de Colectas</h2>
                <div id="envio-colectas-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
                <div class="mt-6 pt-4 border-t border-gray-300 dark:border-slate-600">
                    <p class="text-xl font-bold text-right">Subtotal Enviado: <span id="envio-subtotal" class="text-green-500"></span></p>
                </div>
                 <button id="back-from-envios-btn" class="mt-6 w-full btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
            </section>

            <!-- APORTES VIEW -->
            <section id="aportes-view" class="view-container hidden max-w-4xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">Sueldos y Aportes</h2>
                <div id="aportes-container" class="space-y-6">
                    <div>
                        <h3 class="text-xl font-semibold border-b border-gray-300 dark:border-slate-600 pb-2 mb-3">SUELDOS</h3>
                        <div class="space-y-2 pl-4">
                            <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                                <span>CAMILA</span>
                                <div class="flex items-center gap-4">
                                    <span id="sueldo_camila" class="font-semibold w-32 text-right"></span>
                                    <button data-key="sueldo_camila" data-label="Sueldo Camila" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                                <span>JULIO</span>
                                <div class="flex items-center gap-4">
                                    <span id="sueldo_julio" class="font-semibold w-32 text-right"></span>
                                    <button data-key="sueldo_julio" data-label="Sueldo Julio" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                                <span>CARGAS SOCIALES</span>
                                <div class="flex items-center gap-4">
                                    <span id="cargas_sociales" class="font-semibold w-32 text-right"></span>
                                    <button data-key="cargas_sociales" data-label="Cargas Sociales" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold border-b border-gray-300 dark:border-slate-600 pb-2 mb-3">APORTE SACERDOTES</h3>
                        <h4 class="text-lg font-medium pl-4 mb-2">ASIGNACION</h4>
                        <div class="space-y-2 pl-8">
                            <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                                <span>P. JORGE</span>
                                <div class="flex items-center gap-4">
                                    <span id="asignacion_jorge" class="font-semibold w-32 text-right"></span>
                                    <button data-key="asignacion_jorge" data-label="Asignaci√≥n P. Jorge" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                                <span>P. ADAN</span>
                                <div class="flex items-center gap-4">
                                    <span id="asignacion_adan" class="font-semibold w-32 text-right"></span>
                                    <button data-key="asignacion_adan" data-label="Asignaci√≥n P. Adan" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                                <span>MUTUAL P. JORGE</span>
                                <div class="flex items-center gap-4">
                                    <span id="mutual_jorge" class="font-semibold w-32 text-right"></span>
                                    <button data-key="mutual_jorge" data-label="Mutual P. Jorge" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                                <span>MUTUAL P. ADAN</span>
                                <div class="flex items-center gap-4">
                                    <span id="mutual_adan" class="font-semibold w-32 text-right"></span>
                                    <button data-key="mutual_adan" data-label="Mutual P. Adan" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold border-b border-gray-300 dark:border-slate-600 pb-2 mb-3">APORTE POR SEMINARISTAS</h3>
                         <div class="space-y-2 pl-4">
                            <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                                <span>jun-25</span>
                                <div class="flex items-center gap-4">
                                    <span id="aporte_seminaristas_jun25" class="font-semibold w-32 text-right"></span>
                                    <button data-key="aporte_seminaristas_jun25" data-label="Aporte Seminaristas (jun-25)" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                                </div>
                            </div>
                             <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                                <span>DIVIDIDO POR 4 PARROQUIAS</span>
                                <div class="flex items-center gap-4">
                                    <span id="aporte_seminaristas_dividido" class="font-semibold w-32 text-right"></span>
                                    <button data-key="aporte_seminaristas_dividido" data-label="Aporte dividido" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                                </div>
                            </div>
                             <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                                <span>jul-25</span>
                                <div class="flex items-center gap-4">
                                    <span id="aporte_seminaristas_jul25" class="font-semibold w-32 text-right"></span>
                                    <button data-key="aporte_seminaristas_jul25" data-label="Aporte Seminaristas (jul-25)" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="back-from-aportes-btn" class="mt-8 w-full btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
            </section>

            <!-- CATEGORY MANAGEMENT VIEW -->
            <section id="category-management-view" class="view-container hidden max-w-7xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-8 text-center">Gesti√≥n de Categor√≠as</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                    <!-- General Categories -->
                    <div class="space-y-8">
                        <h3 class="text-2xl font-bold text-center border-b-2 border-blue-500 pb-2">Generales</h3>
                        <div id="category-general-ingreso-container"></div>
                        <div id="category-general-egreso-container"></div>
                    </div>
                    <!-- Bank Categories -->
                    <div class="space-y-8">
                        <h3 class="text-2xl font-bold text-center border-b-2 border-green-500 pb-2">Banco</h3>
                        <div id="category-banco-ingreso-container"></div>
                        <div id="category-banco-egreso-container"></div>
                    </div>
                </div>
                <button id="back-from-categories-btn" class="mt-12 w-full max-w-xs mx-auto block btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
            </section>

            <!-- REMINDERS MANAGEMENT VIEW -->
            <section id="reminders-management-view" class="view-container hidden max-w-4xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">Gesti√≥n de Recordatorios</h2>
                <div class="bg-gray-50 dark:bg-slate-700/50 p-6 rounded-xl mb-8">
                    <h3 class="text-xl font-bold mb-4">Nuevo Recordatorio</h3>
                    <form id="new-reminder-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-1">
                            <label for="reminder-title" class="block text-sm font-medium">T√≠tulo</label>
                            <input type="text" id="reminder-title" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                        </div>
                        <div>
                            <label for="reminder-date" class="block text-sm font-medium">Fecha</label>
                            <input type="date" id="reminder-date" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                        </div>
                        <button type="submit" class="w-full btn-gradient bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold py-2 rounded-xl shadow-lg hover:from-green-600 hover:to-green-700">Guardar</button>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Recordatorios Programados</h3>
                    <div id="reminders-list-container" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Reminder list will be injected here -->
                    </div>
                </div>
                <button id="back-from-reminders-btn" class="mt-8 w-full btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
            </section>

            <!-- BALANCE VIEW -->
            <section id="balance-view" class="view-container hidden max-w-7xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
                <h2 id="balance-title" class="text-3xl font-bold mb-2 text-center">Balance de la Parroquia San Jos√©</h2>
                <p id="balance-date-range" class="text-center text-gray-500 dark:text-gray-400 mb-6"></p>
                
                <div class="bg-gray-50 dark:bg-slate-700 p-4 rounded-lg mb-6">
                    <div class="flex flex-col md:flex-row gap-4 items-center">
                        <input type="date" id="balance-start-date" class="flex-1 p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                        <input type="date" id="balance-end-date" class="flex-1 p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                        <button id="filter-balance-btn" class="w-full md:w-auto btn-gradient bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:from-blue-700 hover:to-blue-800">Buscar</button>
                    </div>
                </div>

                <div id="balance-details-container" class="space-y-8">
                    <!-- Balance details will be injected here -->
                </div>

                <div class="mt-8 pt-6 border-t border-gray-300 dark:border-slate-600 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex gap-4">
                        <button id="download-balance-pdf-btn" class="btn-gradient bg-gradient-to-r from-red-600 to-red-700 text-white font-semibold py-2 px-6 rounded-xl shadow-lg hover:from-red-700 hover:to-red-800">Descargar PDF</button>
                        <button id="download-balance-excel-btn" class="btn-gradient bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold py-2 px-6 rounded-xl shadow-lg hover:from-green-700 hover:to-green-800">Descargar Excel</button>
                    </div>
                    <button id="back-from-balance-btn" class="w-full md:w-auto btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
                </div>
            </section>
        </div>
    </div>

    <!-- CONNECTION STATUS BANNER -->
    <div id="connection-status" class="hidden fixed bottom-0 left-0 right-0 p-4 text-white text-center transition-transform duration-500 translate-y-full">
        <p id="connection-status-text"></p>
    </div>

    <!-- MODALS -->
    <div id="save-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-auto text-center">
            <h3 class="text-xl font-bold mb-4">Confirmar Guardado</h3>
            <p id="save-confirm-text" class="mb-6">Se guardar√°n todos los datos cargados. ¬øDesea continuar?</p>
            <div class="flex justify-center gap-4">
                <button id="save-confirm-ok" class="btn-gradient bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-bold py-2 px-6 rounded-lg">S√≠, Guardar</button>
                <button id="save-confirm-cancel" class="btn-gradient bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-2 px-6 rounded-lg">No</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-auto text-center">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="confirm-modal-text" class="mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-ok" class="btn-gradient bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
                <button id="confirm-modal-cancel" class="btn-gradient bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>
    <!-- MODAL PARA EDITAR COLECTA -->
    <div id="edit-colecta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-auto">
            <h3 class="text-2xl font-bold mb-6 text-center">Editar Env√≠o de Colecta</h3>
            <form id="edit-colecta-form" class="space-y-4">
                <input type="hidden" id="edit-colecta-id">
                <div>
                    <label for="edit-colecta-descripcion" class="block text-sm font-medium">Descripci√≥n</label>
                    <input type="text" id="edit-colecta-descripcion" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                </div>
                <div>
                    <label for="edit-colecta-monto" class="block text-sm font-medium">Monto</label>
                    <input type="number" id="edit-colecta-monto" min="0" step="0.01" placeholder="Dejar en blanco si no aplica" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="edit-colecta-cancel-btn" class="btn-gradient bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button type="button" id="edit-colecta-save-btn" class="btn-gradient bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-bold py-2 px-6 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <!-- MODAL PARA EDITAR APORTE -->
    <div id="edit-aporte-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-auto">
            <h3 id="edit-aporte-title" class="text-xl font-bold mb-4 text-center"></h3>
            <form id="edit-aporte-form" class="space-y-4">
                <input type="hidden" id="edit-aporte-key">
                <div>
                    <label for="edit-aporte-value" class="block text-sm font-medium">Nuevo Valor</label>
                    <input type="number" id="edit-aporte-value" required min="0" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="edit-aporte-cancel-btn" class="btn-gradient bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button type="button" id="edit-aporte-save-btn" class="btn-gradient bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-bold py-2 px-6 rounded-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- MODAL PARA EDITAR CATEGOR√çA -->
    <div id="edit-category-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-auto">
            <h3 class="text-xl font-bold mb-4 text-center">Editar Categor√≠a</h3>
            <form id="edit-category-form" class="space-y-4">
                <input type="hidden" id="edit-category-id">
                <div>
                    <label for="edit-category-name" class="block text-sm font-medium">Nuevo Nombre</label>
                    <input type="text" id="edit-category-name" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="edit-category-cancel-btn" class="btn-gradient bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button type="button" id="edit-category-save-btn" class="btn-gradient bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-bold py-2 px-6 rounded-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- MODAL PARA EDITAR TRANSACCI√ìN INDIVIDUAL -->
    <div id="edit-transaction-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-auto">
            <h3 id="edit-transaction-title" class="text-2xl font-bold mb-6 text-center"></h3>
            <form id="edit-transaction-form" class="space-y-4">
                <input type="hidden" id="edit-transaction-id">
                <input type="hidden" id="edit-transaction-block">
                <div>
                    <label for="edit-transaction-categoria" class="block text-sm font-medium">Categor√≠a</label>
                    <select id="edit-transaction-categoria" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600"></select>
                </div>
                <div>
                    <label for="edit-transaction-descripcion" class="block text-sm font-medium">Descripci√≥n</label>
                    <textarea id="edit-transaction-descripcion" rows="3" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600"></textarea>
                </div>
                <div>
                    <label for="edit-transaction-monto" class="block text-sm font-medium">Monto</label>
                    <input type="number" id="edit-transaction-monto" required min="0" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="edit-transaction-cancel-btn" class="btn-gradient bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button type="button" id="edit-transaction-save-btn" class="btn-gradient bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-bold py-2 px-6 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <!-- MODAL PARA EDITAR RECORDATORIO -->
    <div id="edit-reminder-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-auto">
            <h3 class="text-2xl font-bold mb-6 text-center">Editar Recordatorio</h3>
            <form id="edit-reminder-form" class="space-y-4">
                <input type="hidden" id="edit-reminder-id">
                <div>
                    <label for="edit-reminder-title" class="block text-sm font-medium">T√≠tulo</label>
                    <input type="text" id="edit-reminder-title" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                </div>
                <div>
                    <label for="edit-reminder-date" class="block text-sm font-medium">Fecha</label>
                    <input type="date" id="edit-reminder-date" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="edit-reminder-cancel-btn" class="btn-gradient bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button type="button" id="edit-reminder-save-btn" class="btn-gradient bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-bold py-2 px-6 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, where, writeBatch, getDoc, setDoc, enableIndexedDbPersistence, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Main App Object
        const App = {
            // --- STATE ---
            state: {
                db: null,
                auth: null,
                userId: null,
                sharedUserId: "parroquia-san-jose-shared-data", // Shared ID for all admins
                isOnline: true,
                isAuthenticated: false,
                currentView: 'main-view',
                generalTransactions: [],
                bancoTransactions: [],
                envioColectas: [],
                reminders: [],
                categories: {
                    general: { ingreso: [], egreso: [] },
                    banco: { ingreso: [], egreso: [] }
                },
                currentTransactions: [], // For batch adding/editing
                editingId: null,
                pendingAction: null, // For modals
                isLoading: true,
                currentBlock: null, // To know which block we are loading data for
                generalCurrentPage: 1,
                bancoCurrentPage: 1,
                recordsPerPage: 3,
                currentEditDay: { date: null, block: null },
            },

            // --- DOM ELEMENTS ---
            dom: {},

            // --- INITIALIZATION ---
            init() {
                this.cacheDom();
                this.bindEvents();
                // Firebase will be initialized after successful login
            },

            cacheDom() {
                this.dom = {
                    loader: document.getElementById('loader'),
                    toastContainer: document.getElementById('toast-container'),
                    loginView: document.getElementById('login-view'),
                    appContainer: document.getElementById('app-container'),
                    passwordInput: document.getElementById('password-input'),
                    loginBtn: document.getElementById('login-btn'),
                    mainView: document.getElementById('main-view'),
                    dataEntryView: document.getElementById('data-entry-view'),
                    datePromptView: document.getElementById('date-prompt-view'),
                    editDayView: document.getElementById('edit-day-view'),
                    envioColectasView: document.getElementById('envio-colectas-view'),
                    aportesView: document.getElementById('aportes-view'),
                    balanceView: document.getElementById('balance-view'),
                    categoryManagementView: document.getElementById('category-management-view'),
                    remindersManagementView: document.getElementById('reminders-management-view'),
                    aportesContainer: document.getElementById('aportes-container'),
                    envioColectasList: document.getElementById('envio-colectas-list'),
                    envioSubtotal: document.getElementById('envio-subtotal'),
                    enviosColectasBtn: document.getElementById('envios-colectas-btn'),
                    aportesBtn: document.getElementById('aportes-btn'),
                    balanceBtn: document.getElementById('balance-btn'),
                    manageCategoriesBtn: document.getElementById('manage-categories-btn'),
                    manageRemindersBtn: document.getElementById('manage-reminders-btn'),
                    backToPanelBtn: document.getElementById('back-to-panel-btn'),
                    backFromEnviosBtn: document.getElementById('back-from-envios-btn'),
                    backFromAportesBtn: document.getElementById('back-from-aportes-btn'),
                    backFromBalanceBtn: document.getElementById('back-from-balance-btn'),
                    backFromFormBtn: document.getElementById('back-from-form-btn'),
                    backFromDatePromptBtn: document.getElementById('back-from-date-prompt-btn'),
                    backFromEditDayBtn: document.getElementById('back-from-edit-day-btn'),
                    backFromCategoriesBtn: document.getElementById('back-from-categories-btn'),
                    backFromRemindersBtn: document.getElementById('back-from-reminders-btn'),
                    datePromptTitle: document.getElementById('date-prompt-title'),
                    entryDateInput: document.getElementById('entry-date-input'),
                    continueToFormBtn: document.getElementById('continue-to-form-btn'),
                    dataEntryTitle: document.getElementById('data-entry-title'),
                    sharedDate: document.getElementById('shared-date'),
                    ingresoForm: document.getElementById('ingreso-form'),
                    egresoForm: document.getElementById('egreso-form'),
                    ingresoCategoria: document.getElementById('ingreso-categoria'),
                    ingresoDescripcion: document.getElementById('ingreso-descripcion'),
                    ingresoMonto: document.getElementById('ingreso-monto'),
                    egresoCategoria: document.getElementById('egreso-categoria'),
                    egresoDescripcion: document.getElementById('egreso-descripcion'),
                    egresoMonto: document.getElementById('egreso-monto'),
                    addIngresoBtn: document.getElementById('add-ingreso-btn'),
                    addEgresoBtn: document.getElementById('add-egreso-btn'),
                    addedTransactionsSummary: document.getElementById('added-transactions-summary'),
                    addedTransactionsList: document.getElementById('added-transactions-list'),
                    saveAllBtn: document.getElementById('save-all-btn'),
                    historyGeneralContainer: document.getElementById('history-general-container'),
                    historyBancoContainer: document.getElementById('history-banco-container'),
                    searchGeneralInput: document.getElementById('search-general-input'),
                    searchBancoInput: document.getElementById('search-banco-input'),
                    startDateFilter: document.getElementById('start-date-filter'),
                    endDateFilter: document.getElementById('end-date-filter'),
                    downloadRangePdfBtn: document.getElementById('download-range-pdf-btn'),
                    searchRangeBtn: document.getElementById('search-range-btn'),
                    rangeResultsContainer: document.getElementById('range-results-container'),
                    // Edit Day View
                    editDayTitle: document.getElementById('edit-day-title'),
                    editDayList: document.getElementById('edit-day-list'),
                    // Balance View
                    balanceTitle: document.getElementById('balance-title'),
                    balanceDateRange: document.getElementById('balance-date-range'),
                    balanceStartDate: document.getElementById('balance-start-date'),
                    balanceEndDate: document.getElementById('balance-end-date'),
                    filterBalanceBtn: document.getElementById('filter-balance-btn'),
                    balanceDetailsContainer: document.getElementById('balance-details-container'),
                    downloadBalancePdfBtn: document.getElementById('download-balance-pdf-btn'),
                    downloadBalanceExcelBtn: document.getElementById('download-balance-excel-btn'),
                    // Aportes Spans
                    sueldo_camila: document.getElementById('sueldo_camila'),
                    sueldo_julio: document.getElementById('sueldo_julio'),
                    cargas_sociales: document.getElementById('cargas_sociales'),
                    asignacion_jorge: document.getElementById('asignacion_jorge'),
                    asignacion_adan: document.getElementById('asignacion_adan'),
                    mutual_jorge: document.getElementById('mutual_jorge'),
                    mutual_adan: document.getElementById('mutual_adan'),
                    aporte_seminaristas_jun25: document.getElementById('aporte_seminaristas_jun25'),
                    aporte_seminaristas_dividido: document.getElementById('aporte_seminaristas_dividido'),
                    aporte_seminaristas_jul25: document.getElementById('aporte_seminaristas_jul25'),
                    // Category Management Containers
                    categoryGeneralIngresoContainer: document.getElementById('category-general-ingreso-container'),
                    categoryGeneralEgresoContainer: document.getElementById('category-general-egreso-container'),
                    categoryBancoIngresoContainer: document.getElementById('category-banco-ingreso-container'),
                    categoryBancoEgresoContainer: document.getElementById('category-banco-egreso-container'),
                    // Reminders Management
                    newReminderForm: document.getElementById('new-reminder-form'),
                    reminderTitle: document.getElementById('reminder-title'),
                    reminderDate: document.getElementById('reminder-date'),
                    remindersListContainer: document.getElementById('reminders-list-container'),
                    // Modals
                    saveConfirmModal: document.getElementById('save-confirm-modal'),
                    saveConfirmText: document.getElementById('save-confirm-text'),
                    saveConfirmOk: document.getElementById('save-confirm-ok'),
                    saveConfirmCancel: document.getElementById('save-confirm-cancel'),
                    confirmModal: document.getElementById('confirm-modal'),
                    confirmModalTitle: document.getElementById('confirm-modal-title'),
                    confirmModalText: document.getElementById('confirm-modal-text'),
                    confirmModalOk: document.getElementById('confirm-modal-ok'),
                    confirmModalCancel: document.getElementById('confirm-modal-cancel'),
                    // Edit Colecta Modal
                    editColectaModal: document.getElementById('edit-colecta-modal'),
                    editColectaForm: document.getElementById('edit-colecta-form'),
                    editColectaId: document.getElementById('edit-colecta-id'),
                    editColectaDescripcion: document.getElementById('edit-colecta-descripcion'),
                    editColectaMonto: document.getElementById('edit-colecta-monto'),
                    editColectaSaveBtn: document.getElementById('edit-colecta-save-btn'),
                    editColectaCancelBtn: document.getElementById('edit-colecta-cancel-btn'),
                    // Edit Aporte Modal
                    editAporteModal: document.getElementById('edit-aporte-modal'),
                    editAporteTitle: document.getElementById('edit-aporte-title'),
                    editAporteKey: document.getElementById('edit-aporte-key'),
                    editAporteValue: document.getElementById('edit-aporte-value'),
                    editAporteSaveBtn: document.getElementById('edit-aporte-save-btn'),
                    editAporteCancelBtn: document.getElementById('edit-aporte-cancel-btn'),
                    // Edit Category Modal
                    editCategoryModal: document.getElementById('edit-category-modal'),
                    editCategoryId: document.getElementById('edit-category-id'),
                    editCategoryName: document.getElementById('edit-category-name'),
                    editCategorySaveBtn: document.getElementById('edit-category-save-btn'),
                    editCategoryCancelBtn: document.getElementById('edit-category-cancel-btn'),
                    // Edit Transaction Modal
                    editTransactionModal: document.getElementById('edit-transaction-modal'),
                    editTransactionTitle: document.getElementById('edit-transaction-title'),
                    editTransactionForm: document.getElementById('edit-transaction-form'),
                    editTransactionId: document.getElementById('edit-transaction-id'),
                    editTransactionBlock: document.getElementById('edit-transaction-block'),
                    editTransactionCategoria: document.getElementById('edit-transaction-categoria'),
                    editTransactionDescripcion: document.getElementById('edit-transaction-descripcion'),
                    editTransactionMonto: document.getElementById('edit-transaction-monto'),
                    editTransactionSaveBtn: document.getElementById('edit-transaction-save-btn'),
                    editTransactionCancelBtn: document.getElementById('edit-transaction-cancel-btn'),
                    // Edit Reminder Modal
                    editReminderModal: document.getElementById('edit-reminder-modal'),
                    editReminderForm: document.getElementById('edit-reminder-form'),
                    editReminderId: document.getElementById('edit-reminder-id'),
                    editReminderTitle: document.getElementById('edit-reminder-title'),
                    editReminderDate: document.getElementById('edit-reminder-date'),
                    editReminderSaveBtn: document.getElementById('edit-reminder-save-btn'),
                    editReminderCancelBtn: document.getElementById('edit-reminder-cancel-btn'),
                    // Connection Status
                    connectionStatus: document.getElementById('connection-status'),
                    connectionStatusText: document.getElementById('connection-status-text'),
                    // Reminders
                    notificationBellBtn: document.getElementById('notification-bell-btn'),
                    notificationBadge: document.getElementById('notification-badge'),
                    remindersPanel: document.getElementById('reminders-panel'),
                    remindersList: document.getElementById('reminders-list'),
                };
            },
            
            handleLogin() {
                const adminPasswords = ['leandro', 'adan', 'jose'];
                const enteredPassword = this.dom.passwordInput.value.trim().toLowerCase();
                if (adminPasswords.includes(enteredPassword)) {
                    this.state.isAuthenticated = true;
                    this.dom.loginView.classList.add('hidden');
                    this.dom.appContainer.classList.remove('hidden');
                    this.initFirebase(); // Initialize Firebase after successful login
                } else {
                    this.showToast('Clave incorrecta.', 'error');
                    this.dom.passwordInput.value = '';
                }
            },

            // --- FIREBASE SETUP ---
            async initFirebase() {
                this.toggleLoader(true);
                
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config)
                    : {
                        apiKey: "AIzaSyCCpr9FqklSBzkedKGQyNQrTLB30Y-AhJI",
                        authDomain: "gestionparroquial-2fabc.firebaseapp.com",
                        projectId: "gestionparroquial-2fabc",
                        storageBucket: "gestionparroquial-2fabc.appspot.com",
                        messagingSenderId: "710289559218",
                        appId: "1:710289559218:web:26bf19a750914deb3a83ab"
                      };

                try {
                    const app = initializeApp(firebaseConfig);
                    this.state.db = getFirestore(app);
                    
                    await enableIndexedDbPersistence(this.state.db);
                    console.log("Firebase persistence enabled.");

                    this.state.auth = getAuth(app);
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    this.handleAuthentication(initialAuthToken);

                } catch (error) {
                    if (error.code == 'failed-precondition') {
                        console.warn("Persistence failed, likely due to multiple open tabs. App will work online.");
                        this.showToast("La persistencia offline no se pudo activar (posiblemente por tener m√∫ltiples pesta√±as abiertas).", "error");
                    } else if (error.code == 'unimplemented') {
                        console.warn("Persistence not supported in this browser.");
                        this.showToast("Su navegador no soporta la funcionalidad offline.", "error");
                    } else {
                         console.error("Error initializing Firebase:", error);
                         this.showToast("Error al conectar con la base de datos.", "error");
                    }
                    // Fallback to online-only mode
                    const app = initializeApp(firebaseConfig);
                    this.state.db = getFirestore(app);
                    this.state.auth = getAuth(app);
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    this.handleAuthentication(initialAuthToken);
                }
            },

            handleAuthentication(token) {
                const auth = this.state.auth;
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in.
                        if (!this.state.userId) { // Check to prevent re-running on token refresh
                            this.state.userId = user.uid; // Still useful for security rules
                            console.log("User authenticated with UID:", this.state.userId);
                            this.setupRealtimeListeners();
                        }
                    } else {
                        // User is signed out. Attempt to sign in.
                        (async () => {
                            try {
                                if (token) {
                                    await signInWithCustomToken(auth, token);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Authentication error:", error);
                                this.showToast("Error de autenticaci√≥n.", "error");
                                this.toggleLoader(false);
                            }
                        })();
                    }
                });
            },
            
            async setupRealtimeListeners() {
                if (!this.state.isAuthenticated) return;
                this.toggleLoader(true);
                try {
                    await this.checkAndSeedCategories();
                    await this.checkAndSeedEnvioColectas();
                    await this.checkAndSeedAportesData();

                    this.listenToTransactions('general');
                    this.listenToTransactions('banco');
                    this.listenToEnvioColectas();
                    this.listenToAportesData();
                    this.listenToCategories();
                    this.listenToReminders();
                } catch(error) {
                    console.error("Error setting up listeners:", error);
                    this.showToast("No se pudieron cargar los datos en tiempo real.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            // --- EVENT BINDING ---
            bindEvents() {
                 // Login
                this.dom.loginBtn.addEventListener('click', () => this.handleLogin());
                this.dom.passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleLogin();
                    }
                });
                
                // Connection status
                window.addEventListener('online', () => this.handleConnectionChange(true));
                window.addEventListener('offline', () => this.handleConnectionChange(false));

                this.dom.backToPanelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showMainView();
                });

                // Main view actions using event delegation
                this.dom.mainView.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    
                    const { action, block, date, page } = button.dataset;

                    if (action === 'load-data') {
                        this.showDatePromptView(block);
                    } else if (action === 'delete-date') {
                        this.confirmDeleteDate(date, block);
                    } else if (action === 'edit-day') {
                        this.showEditDayView(date, block);
                    } else if (action === 'paginate') {
                        this.handlePagination(block, parseInt(page));
                    }
                });
                
                // Other buttons
                this.dom.enviosColectasBtn.addEventListener('click', () => this.showEnvioColectasView());
                this.dom.aportesBtn.addEventListener('click', () => this.showAportesView());
                this.dom.balanceBtn.addEventListener('click', () => this.showBalanceView());
                this.dom.manageCategoriesBtn.addEventListener('click', () => this.showCategoryManagementView());
                this.dom.manageRemindersBtn.addEventListener('click', () => this.showRemindersManagementView());
                this.dom.backFromEnviosBtn.addEventListener('click', () => this.showMainView());
                this.dom.backFromAportesBtn.addEventListener('click', () => this.showMainView());
                this.dom.backFromBalanceBtn.addEventListener('click', () => this.showMainView());
                this.dom.backFromFormBtn.addEventListener('click', () => this.showMainView());
                this.dom.backFromDatePromptBtn.addEventListener('click', () => this.showMainView());
                this.dom.backFromEditDayBtn.addEventListener('click', () => this.showMainView());
                this.dom.backFromCategoriesBtn.addEventListener('click', () => this.showMainView());
                this.dom.backFromRemindersBtn.addEventListener('click', () => this.showMainView());
                this.dom.downloadRangePdfBtn.addEventListener('click', () => this.downloadDateRangePDF());
                this.dom.searchRangeBtn.addEventListener('click', () => this.showDateRangeResults());
                this.dom.continueToFormBtn.addEventListener('click', () => this.handleDatePromptContinue());

                // Balance view buttons
                this.dom.filterBalanceBtn.addEventListener('click', () => this.generateAndDisplayBalance());
                this.dom.downloadBalancePdfBtn.addEventListener('click', () => this.downloadBalancePDF());
                this.dom.downloadBalanceExcelBtn.addEventListener('click', () => this.downloadBalanceExcel());

                // Form view buttons
                this.dom.addIngresoBtn.addEventListener('click', () => this.addTransactionToList('ingreso'));
                this.dom.addEgresoBtn.addEventListener('click', () => this.addTransactionToList('egreso'));
                this.dom.saveAllBtn.addEventListener('click', () => this.showSaveConfirmation());
                
                // Search inputs
                this.dom.searchGeneralInput.addEventListener('input', () => { this.state.generalCurrentPage = 1; this.renderHistory('general'); });
                this.dom.searchBancoInput.addEventListener('input', () => { this.state.bancoCurrentPage = 1; this.renderHistory('banco'); });

                // Modals
                this.dom.saveConfirmOk.addEventListener('click', () => this.commitTransactions());
                this.dom.saveConfirmCancel.addEventListener('click', () => this.dom.saveConfirmModal.classList.add('hidden'));
                this.dom.confirmModalOk.addEventListener('click', () => this.handleConfirm());
                this.dom.confirmModalCancel.addEventListener('click', () => this.dom.confirmModal.classList.add('hidden'));
                
                // Edit Colecta Modal Buttons
                this.dom.editColectaSaveBtn.addEventListener('click', () => this.handleUpdateColecta());
                this.dom.editColectaCancelBtn.addEventListener('click', () => this.dom.editColectaModal.classList.add('hidden'));

                // Edit Aporte Modal Buttons
                this.dom.editAporteSaveBtn.addEventListener('click', () => this.handleUpdateAporte());
                this.dom.editAporteCancelBtn.addEventListener('click', () => this.dom.editAporteModal.classList.add('hidden'));

                // Edit Category Modal Buttons
                this.dom.editCategorySaveBtn.addEventListener('click', () => this.handleUpdateCategory());
                this.dom.editCategoryCancelBtn.addEventListener('click', () => this.dom.editCategoryModal.classList.add('hidden'));

                // Edit Day View Delegation
                this.dom.editDayList.addEventListener('click', e => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const { action, id, block } = button.dataset;
                    if (action === 'edit-transaction') {
                        this.showEditTransactionModal(id, block);
                    } else if (action === 'delete-transaction') {
                        this.handleDeleteSingleTransaction(id, block);
                    }
                });

                // Edit Transaction Modal Buttons
                this.dom.editTransactionSaveBtn.addEventListener('click', () => this.handleUpdateTransaction());
                this.dom.editTransactionCancelBtn.addEventListener('click', () => this.dom.editTransactionModal.classList.add('hidden'));

                // Collections view event delegation
                this.dom.envioColectasList.addEventListener('click', e => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const { action, id } = button.dataset;
                    if (action === 'save-monto') {
                        this.saveEnvioMonto(id);
                    } else if (action === 'edit-colecta') {
                        this.showEditColectaModal(id);
                    }
                });

                // Aportes view event delegation
                this.dom.aportesContainer.addEventListener('click', e => {
                    const button = e.target.closest('button[data-key]');
                    if (!button) return;
                    const { key, label } = button.dataset;
                    this.showEditAporteModal(key, label);
                });

                // Category management delegation
                this.dom.categoryManagementView.addEventListener('click', e => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const { action, block, type, id, name } = button.dataset;
                    if (action === 'add-category') {
                        this.handleAddCategory(block, type);
                    } else if (action === 'edit-category') {
                        this.showEditCategoryModal(id, name);
                    } else if (action === 'delete-category') {
                        this.handleDeleteCategory(id, name);
                    }
                });

                // Notification bell
                this.dom.notificationBellBtn.addEventListener('click', () => {
                    this.dom.remindersPanel.classList.toggle('hidden');
                });
                // Hide panel if clicked outside
                document.addEventListener('click', (e) => {
                    if (!this.dom.notificationBellBtn.contains(e.target) && !this.dom.remindersPanel.contains(e.target)) {
                        this.dom.remindersPanel.classList.add('hidden');
                    }
                });

                // Reminders Management
                this.dom.newReminderForm.addEventListener('submit', e => {
                    e.preventDefault();
                    this.handleAddReminder();
                });
                this.dom.remindersListContainer.addEventListener('click', e => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const { action, id } = button.dataset;
                    if (action === 'edit-reminder') {
                        this.showEditReminderModal(id);
                    } else if (action === 'delete-reminder') {
                        this.handleDeleteReminder(id);
                    }
                });
                this.dom.editReminderSaveBtn.addEventListener('click', () => this.handleUpdateReminder());
                this.dom.editReminderCancelBtn.addEventListener('click', () => this.dom.editReminderModal.classList.add('hidden'));
            },

            // --- DATA HANDLING & FIRESTORE ---
            getCollectionRef(name) {
                if (!this.state.isAuthenticated) {
                    console.error("User not authenticated, cannot get collection reference.");
                    return null;
                }
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Use the shared User ID for all data paths
                const path = `artifacts/${appId}/public/data/${name}`;
                return collection(this.state.db, path);
            },
            
            async checkAndSeedEnvioColectas() {
                const collRef = this.getCollectionRef("envio_colectas");
                if (!collRef) return;
                const snapshot = await getDocs(collRef);
                if (snapshot.empty) {
                    const initialData = [
                         { orden: 1, fecha: "4-5 ENERO", descripcion: "MISIONES DEL AFRICA", monto: 141400 },
                         { orden: 2, fecha: "11-12 ENERO", descripcion: "DIOCESIS", monto: 152500 },
                         { orden: 3, fecha: "1-2 FEBRERO", descripcion: "DIOCESIS", monto: 181720 },
                         { orden: 4, fecha: "1-2 MARZO", descripcion: "DIOCESIS", monto: 167300 },
                         { orden: 5, fecha: "5-6 ABRIL", descripcion: "DIOCESIS", monto: 195445 },
                         { orden: 6, fecha: "18 abril", descripcion: "TIERRA SANTA", monto: 118150 },
                         { orden: 7, fecha: "3-4 MAYO", descripcion: "DIOCESIS", monto: 160280 },
                         { orden: 8, fecha: "7-8 JUNIO", descripcion: "DIOCESIS", monto: null },
                         { orden: 9, fecha: "14-15 JUNIO", descripcion: "CARITAS", monto: null },
                         { orden: 10, fecha: "5-6 JULIO", descripcion: "OFRENDA UNIVERSAL", monto: 141865 },
                         { orden: 11, fecha: "12-13 JULIO", descripcion: "DIOCESIS", monto: 96070 },
                         { orden: 12, fecha: "2-3 AGOSTO", descripcion: "DIOCESIS", monto: null },
                         { orden: 13, fecha: "6-7 SEPTIEMBRE", descripcion: "MAS POR MENOS", monto: null },
                         { orden: 14, fecha: "13-14 SEPTIEMBRE", descripcion: "DIOCESIS", monto: null },
                         { orden: 15, fecha: "4-5 OCTUBRE", descripcion: "DIOCESIS", monto: null },
                         { orden: 16, fecha: "11-12 OCTUBRE", descripcion: "JORN. DE LAS MISIONES", monto: null },
                         { orden: 17, fecha: "1-2 NOVIEMBRE", descripcion: "DIOCESIS", monto: null },
                         { orden: 18, fecha: "6-7 DICIEMBRE", descripcion: "DIOCESIS", monto: null },
                         { orden: 19, fecha: "CONFIRMACION", descripcion: "CONFIRMACION", monto: null },
                         { orden: 20, fecha: "CAMPA√ëA TAE", descripcion: "CAMPA√ëA TAE", monto: null },
                    ];
                    const batch = writeBatch(this.state.db);
                    initialData.forEach(item => {
                        const docRef = doc(collRef);
                        batch.set(docRef, item);
                    });
                    await batch.commit();
                    this.showToast("Datos iniciales de colectas cargados.", "success");
                }
            },

            async checkAndSeedAportesData() {
                const docRef = doc(this.getCollectionRef("configuracion_financiera"), "valores");
                if (!docRef) return;
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    const initialData = {
                        sueldo_camila: 480000,
                        sueldo_julio: 480000,
                        cargas_sociales: 568199.33,
                        asignacion_jorge: 156000,
                        asignacion_adan: 156000,
                        mutual_jorge: 127050,
                        mutual_adan: 127050,
                        aporte_seminaristas_jun25: 73750,
                        aporte_seminaristas_dividido: 295,
                        aporte_seminaristas_jul25: 295,
                    };
                    await setDoc(docRef, initialData);
                    this.showToast("Datos iniciales de aportes cargados.", "success");
                }
            },

            listenToAportesData() {
                const docRef = doc(this.getCollectionRef("configuracion_financiera"), "valores");
                if (!docRef) return;
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        for (const key in data) {
                            if (this.dom[key]) {
                                this.dom[key].textContent = this.formatCurrency(data[key]);
                            }
                        }
                    } else {
                        console.log("No such document in configuracion_financiera!");
                    }
                });
            },

            listenToEnvioColectas() {
                const collRef = this.getCollectionRef("envio_colectas");
                if (!collRef) return;
                onSnapshot(collRef, (snapshot) => {
                    let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => a.orden - b.orden);
                    this.state.envioColectas = data;
                    this.renderEnvioColectas();
                    this.updateReminders();
                });
            },
            
            listenToTransactions(block) {
                const collectionName = block === 'general' ? 'gestion_general' : 'gestion_banco';
                const collRef = this.getCollectionRef(collectionName);
                if (!collRef) return;

                onSnapshot(collRef, (snapshot) => {
                    let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => b.fecha.localeCompare(a.fecha));
                    
                    if (block === 'general') {
                        this.state.generalTransactions = data;
                    } else {
                        this.state.bancoTransactions = data;
                    }
                    this.renderHistory(block);
                });
            },
            
            async commitTransactions() {
                this.dom.saveConfirmModal.classList.add('hidden');
                if (this.state.currentTransactions.length === 0) {
                    this.showToast("No hay registros nuevos para guardar.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const batch = writeBatch(this.state.db);
                    for (const trans of this.state.currentTransactions) {
                        const collectionRef = this.getCollectionRef(trans.block === 'general' ? 'gestion_general' : 'gestion_banco');
                        if (!collectionRef) throw new Error("Collection reference is null");
                        const newDocRef = doc(collectionRef);
                        const data = { ...trans };
                        delete data.id; // Not needed as Firestore generates it
                        batch.set(newDocRef, data);
                    }
                    await batch.commit();
                    this.showToast("Operaci√≥n guardada con √©xito.", "success");
                    this.state.currentTransactions = [];
                    // No need to reload data, onSnapshot will handle it.
                    this.showMainView();
                } catch (error) {
                    console.error("Error committing transactions:", error);
                    this.showToast("Error al guardar la operaci√≥n.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            
            async deleteDate(dateString, block) {
                this.toggleLoader(true);
                try {
                    const collectionRef = this.getCollectionRef(block === 'general' ? 'gestion_general' : 'gestion_banco');
                    if (!collectionRef) throw new Error("Collection reference is null");
                    const q = query(collectionRef, where("fecha", "==", dateString));
                    const snapshot = await getDocs(q);
                    
                    const batch = writeBatch(this.state.db);
                    snapshot.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();

                    this.showToast(`Registros del ${this.formatDate(dateString)} eliminados.`, "success");
                    // No need to reload data, onSnapshot will handle it.
                } catch (error) {
                    console.error("Error deleting date records:", error);
                    this.showToast("Error al eliminar los registros.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            async saveEnvioMonto(id) {
                const input = document.getElementById(`monto-input-${id}`);
                const monto = parseFloat(input.value);
                if (isNaN(monto) || monto <= 0) {
                    this.showToast("Por favor, ingresa un monto v√°lido.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef("envio_colectas");
                    if (!collRef) throw new Error("Collection reference is null");
                    const docRef = doc(collRef, id);
                    await updateDoc(docRef, { monto: monto });
                    this.showToast("Monto guardado.", "success");
                    // No need to reload data, onSnapshot will handle it.
                } catch (error) {
                    console.error("Error saving monto:", error);
                    this.showToast("Error al guardar el monto.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            // --- UI RENDERING ---
            renderHistory(block) {
                const container = block === 'general' ? this.dom.historyGeneralContainer : this.dom.historyBancoContainer;
                let currentPage = block === 'general' ? this.state.generalCurrentPage : this.state.bancoCurrentPage;
                const transactions = block === 'general' ? this.state.generalTransactions : this.state.bancoTransactions;
                const searchInput = block === 'general' ? this.dom.searchGeneralInput : this.dom.searchBancoInput;
                
                container.innerHTML = '';
                const searchTerm = searchInput.value;
                
                const groupedByDate = transactions.reduce((acc, trans) => {
                    const date = this.formatDate(trans.fecha);
                    if (!acc[date]) acc[date] = { rawDate: trans.fecha, transactions: [] };
                    acc[date].transactions.push(trans);
                    return acc;
                }, {});

                const filteredDates = Object.keys(groupedByDate).filter(date => date.includes(searchTerm));

                const listContainer = document.createElement('div');
                listContainer.className = 'space-y-4';

                if (filteredDates.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500">No se encontraron registros.</p>';
                    container.appendChild(listContainer);
                    return;
                }

                const totalPages = Math.ceil(filteredDates.length / this.state.recordsPerPage);
                if (currentPage > totalPages) currentPage = totalPages;
                
                const startIndex = (currentPage - 1) * this.state.recordsPerPage;
                const endIndex = startIndex + this.state.recordsPerPage;
                const paginatedDates = filteredDates.slice(startIndex, endIndex);

                paginatedDates.forEach(date => {
                    const { rawDate, transactions: dailyTransactions } = groupedByDate[date];
                    let totalIngresos = 0;
                    let totalEgresos = 0;
                    dailyTransactions.forEach(t => {
                        if (t.type === 'ingreso') totalIngresos += t.monto;
                        else totalEgresos += t.monto;
                    });
                    
                    const dateGroup = document.createElement('div');
                    dateGroup.className = 'bg-gray-50 dark:bg-slate-700 p-4 rounded-lg';
                    dateGroup.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg">${date}</h3>
                            <div class="flex gap-2">
                                <button data-action="edit-day" data-date="${rawDate}" data-block="${block}" class="text-xs btn-gradient bg-gradient-to-r from-blue-500 to-blue-600 text-white px-2 py-1 rounded hover:from-blue-600 hover:to-blue-700">Modificar D√≠a</button>
                                <button data-action="delete-date" data-date="${rawDate}" data-block="${block}" class="text-xs btn-gradient bg-gradient-to-r from-red-600 to-red-700 text-white px-2 py-1 rounded hover:from-red-700 hover:to-red-800">Eliminar D√≠a</button>
                            </div>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-green-500">Ingresos: ${this.formatCurrency(totalIngresos)}</span>
                            <span class="text-red-500">Egresos: ${this.formatCurrency(totalEgresos)}</span>
                            <span class="font-semibold">Saldo: ${this.formatCurrency(totalIngresos - totalEgresos)}</span>
                        </div>
                    `;
                    listContainer.appendChild(dateGroup);
                });

                container.appendChild(listContainer);

                // Pagination controls
                if (totalPages > 1) {
                    const paginationContainer = document.createElement('div');
                    paginationContainer.className = 'flex justify-between items-center mt-4';
                    
                    const prevDisabled = currentPage === 1 ? 'disabled' : '';
                    const nextDisabled = currentPage === totalPages ? 'disabled' : '';

                    paginationContainer.innerHTML = `
                        <button data-action="paginate" data-block="${block}" data-page="${currentPage - 1}" ${prevDisabled} class="text-sm btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white px-3 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
                        <span class="text-sm font-semibold">P√°gina ${currentPage} de ${totalPages}</span>
                        <button data-action="paginate" data-block="${block}" data-page="${currentPage + 1}" ${nextDisabled} class="text-sm btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white px-3 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed">Siguiente</button>
                    `;
                    container.appendChild(paginationContainer);
                }
            },
            
            renderEnvioColectas() {
                this.dom.envioColectasList.innerHTML = '';
                let subtotal = 0;
                this.state.envioColectas.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-3 bg-gray-50 dark:bg-slate-700 rounded-lg grid grid-cols-4 gap-4 items-center';
                    
                    let montoHtml = '';
                    if (item.monto !== null) {
                        montoHtml = `<span class="font-semibold">${this.formatCurrency(item.monto)}</span>`;
                        subtotal += item.monto;
                    } else {
                        montoHtml = `
                            <div class="flex gap-2">
                                <input type="number" placeholder="Monto" class="w-full p-1 border border-gray-300 dark:border-slate-600 rounded bg-white dark:bg-slate-600" id="monto-input-${item.id}">
                                <button data-action="save-monto" data-id="${item.id}" class="text-xs btn-gradient bg-gradient-to-r from-green-500 to-green-600 text-white px-2 py-1 rounded">Guardar</button>
                            </div>
                        `;
                    }

                    itemDiv.innerHTML = `
                        <div class="font-semibold">${item.fecha}</div>
                        <div>${item.descripcion}</div>
                        <div class="text-right col-span-1">${montoHtml}</div>
                        <div class="text-right">
                            <button data-action="edit-colecta" data-id="${item.id}" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-2 py-1 rounded">Editar</button>
                        </div>
                    `;
                    this.dom.envioColectasList.appendChild(itemDiv);
                });
                this.dom.envioSubtotal.textContent = this.formatCurrency(subtotal);
            },

            renderRangeTable(container, title, transactions) {
                let totalIngresos = 0;
                let totalEgresos = 0;
                transactions.forEach(t => {
                    if (t.type === 'ingreso') totalIngresos += t.monto;
                    else totalEgresos += t.monto;
                });

                const tableContainer = document.createElement('div');
                tableContainer.className = 'mb-8';

                let tableHTML = `
                    <h4 class="text-lg font-bold mb-2">${title}</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white dark:bg-slate-700 rounded-lg shadow">
                            <thead class="bg-gray-200 dark:bg-slate-600">
                                <tr>
                                    <th class="py-2 px-4 text-left">Fecha</th>
                                    <th class="py-2 px-4 text-left">Categor√≠a</th>
                                    <th class="py-2 px-4 text-left">Descripci√≥n</th>
                                    <th class="py-2 px-4 text-left">Tipo</th>
                                    <th class="py-2 px-4 text-right">Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                transactions.sort((a, b) => a.fecha.localeCompare(b.fecha)).forEach(t => {
                    tableHTML += `
                        <tr class="border-b border-gray-200 dark:border-slate-600">
                            <td class="py-2 px-4">${this.formatDate(t.fecha)}</td>
                            <td class="py-2 px-4">${t.categoria}</td>
                            <td class="py-2 px-4">${t.descripcion || '-'}</td>
                            <td class="py-2 px-4"><span class="${t.type === 'ingreso' ? 'text-green-500' : 'text-red-500'}">${t.type}</span></td>
                            <td class="py-2 px-4 text-right">${this.formatCurrency(t.monto)}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-gray-100 dark:bg-slate-600 rounded-lg flex justify-end gap-6 font-semibold">
                        <span>Ingresos: <span class="text-green-500">${this.formatCurrency(totalIngresos)}</span></span>
                        <span>Egresos: <span class="text-red-500">${this.formatCurrency(totalEgresos)}</span></span>
                        <span>Saldo: <span>${this.formatCurrency(totalIngresos - totalEgresos)}</span></span>
                    </div>
                `;
                
                tableContainer.innerHTML = tableHTML;
                container.appendChild(tableContainer);
            },

            // --- UI FLOW & VIEWS ---
            switchView(viewId) {
                const currentViewEl = document.getElementById(this.state.currentView);
                if (currentViewEl) {
                    currentViewEl.classList.remove('visible');
                }

                setTimeout(() => {
                    document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
                    
                    const newViewEl = document.getElementById(viewId);
                    if (newViewEl) {
                        newViewEl.classList.remove('hidden');
                        setTimeout(() => {
                            newViewEl.classList.add('visible');
                            this.state.currentView = viewId;
                        }, 20);
                    }
                }, 300);
            },

            showDataEntryView(date) {
                const block = this.state.currentBlock;
                this.switchView('data-entry-view');
                
                const title = block === 'general' ? 'Ingresos y Egresos Generales' : 'Banco';
                this.dom.dataEntryTitle.textContent = `Cargar Datos para: ${title}`;
                this.dom.sharedDate.value = date;
                this.state.currentTransactions = [];
                this.renderAddedTransactions();

                this.dom.ingresoCategoria.innerHTML = this.state.categories[block].ingreso.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
                this.dom.egresoCategoria.innerHTML = this.state.categories[block].egreso.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            },

            showMainView() {
                this.switchView('main-view');
                this.state.currentTransactions = [];
                this.state.currentBlock = null;
            },
            
            showEnvioColectasView() {
                this.switchView('envio-colectas-view');
            },

            showAportesView() {
                this.switchView('aportes-view');
            },

            showBalanceView() {
                this.switchView('balance-view');
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                this.dom.balanceStartDate.value = firstDay;
                this.dom.balanceEndDate.value = lastDay;
                this.generateAndDisplayBalance();
            },

            showDatePromptView(block) {
                this.state.currentBlock = block;
                this.switchView('date-prompt-view');
                const title = block === 'general' ? 'Ingresos y Egresos Generales' : 'Banco';
                this.dom.datePromptTitle.textContent = `Fecha para: ${title}`;
                this.dom.entryDateInput.valueAsDate = new Date();
            },
            
            showDateRangeResults() {
                const startDate = this.dom.startDateFilter.value;
                const endDate = this.dom.endDateFilter.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, selecciona un rango de fechas.", "error");
                    return;
                }

                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                
                this.dom.rangeResultsContainer.innerHTML = ''; // Clear previous results

                if (generalInRange.length === 0 && bancoInRange.length === 0) {
                    this.dom.rangeResultsContainer.innerHTML = '<p class="text-center text-gray-500">No se encontraron registros en el rango seleccionado.</p>';
                    this.dom.rangeResultsContainer.classList.remove('hidden');
                    return;
                }

                if (generalInRange.length > 0) {
                    this.renderRangeTable(this.dom.rangeResultsContainer, 'Resultados: Ingresos y Egresos Generales', generalInRange);
                }

                if (bancoInRange.length > 0) {
                    this.renderRangeTable(this.dom.rangeResultsContainer, 'Resultados: Movimientos de Banco', bancoInRange);
                }

                this.dom.rangeResultsContainer.classList.remove('hidden');
            },

            showEditDayView(date, block) {
                this.state.currentEditDay = { date, block };
                this.switchView('edit-day-view');

                const blockTitle = block === 'general' ? 'Generales' : 'Banco';
                this.dom.editDayTitle.textContent = `Editando Registros de ${blockTitle} - ${this.formatDate(date)}`;

                const transactions = block === 'general' ? this.state.generalTransactions : this.state.bancoTransactions;
                const dayTransactions = transactions.filter(t => t.fecha === date);
                
                this.dom.editDayList.innerHTML = '';
                if (dayTransactions.length === 0) {
                    this.dom.editDayList.innerHTML = '<p class="text-center text-gray-500">No hay registros para este d√≠a.</p>';
                    return;
                }

                dayTransactions.forEach(t => {
                    const item = document.createElement('div');
                    item.className = `flex justify-between items-center p-3 rounded-lg ${t.type === 'ingreso' ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`;
                    item.innerHTML = `
                        <div class="flex-1">
                            <p class="font-bold">${t.categoria}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${t.descripcion || 'Sin descripci√≥n'}</p>
                        </div>
                        <div class="font-semibold mx-4">${this.formatCurrency(t.monto)}</div>
                        <div class="flex gap-2">
                            <button data-action="edit-transaction" data-id="${t.id}" data-block="${block}" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded">Editar</button>
                            <button data-action="delete-transaction" data-id="${t.id}" data-block="${block}" class="text-xs btn-gradient bg-gradient-to-r from-red-600 to-red-700 text-white px-3 py-1 rounded">Eliminar</button>
                        </div>
                    `;
                    this.dom.editDayList.appendChild(item);
                });
            },

            showEditTransactionModal(id, block) {
                const transactions = block === 'general' ? this.state.generalTransactions : this.state.bancoTransactions;
                const transaction = transactions.find(t => t.id === id);

                if (!transaction) {
                    this.showToast("No se encontr√≥ la transacci√≥n.", "error");
                    return;
                }

                this.dom.editTransactionId.value = id;
                this.dom.editTransactionBlock.value = block;
                this.dom.editTransactionTitle.textContent = `Editar ${transaction.type === 'ingreso' ? 'Ingreso' : 'Egreso'}`;
                
                const categories = this.state.categories[block][transaction.type];
                this.dom.editTransactionCategoria.innerHTML = categories.map(cat => `<option value="${cat.name}" ${cat.name === transaction.categoria ? 'selected' : ''}>${cat.name}</option>`).join('');
                
                this.dom.editTransactionDescripcion.value = transaction.descripcion;
                this.dom.editTransactionMonto.value = transaction.monto;

                this.dom.editTransactionModal.classList.remove('hidden');
            },

            // --- FORM & MODAL LOGIC ---
            addTransactionToList(type) {
                const form = type === 'ingreso' ? this.dom.ingresoForm : this.dom.egresoForm;
                const categoria = document.getElementById(`${type}-categoria`).value;
                const descripcion = document.getElementById(`${type}-descripcion`).value;
                const monto = parseFloat(document.getElementById(`${type}-monto`).value);
                const fecha = this.dom.sharedDate.value;

                if (!fecha || !categoria || isNaN(monto) || monto <= 0) {
                    this.showToast("Por favor, complete la fecha, categor√≠a y un monto v√°lido.", "error");
                    return;
                }

                const transaction = {
                    id: Date.now(), // Temporary ID for list management
                    type: type,
                    block: this.state.currentBlock,
                    fecha: fecha,
                    categoria: categoria,
                    descripcion: descripcion,
                    monto: monto,
                };

                this.state.currentTransactions.push(transaction);
                this.renderAddedTransactions();
                form.reset();
                this.showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} a√±adido a la lista.`, "success");
            },

            renderAddedTransactions() {
                const list = this.dom.addedTransactionsList;
                list.innerHTML = '';
                if (this.state.currentTransactions.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-500">A√∫n no hay registros para guardar.</p>';
                    return;
                }
                this.state.currentTransactions.forEach(t => {
                    const item = document.createElement('div');
                    item.className = `flex justify-between items-center p-2 rounded-lg ${t.type === 'ingreso' ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900'}`;
                    item.innerHTML = `
                        <div>
                            <span class="font-bold">${t.categoria}</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">${t.descripcion ? ' - ' + t.descripcion : ''}</span>
                        </div>
                        <span class="font-semibold">${this.formatCurrency(t.monto)}</span>
                    `;
                    list.appendChild(item);
                });
            },

            showSaveConfirmation() {
                if (this.state.currentTransactions.length === 0) {
                    this.showToast("No hay registros nuevos para guardar.", "error");
                    return;
                }
                const ingresosCount = this.state.currentTransactions.filter(t => t.type === 'ingreso').length;
                const egresosCount = this.state.currentTransactions.filter(t => t.type === 'egreso').length;
                this.dom.saveConfirmText.textContent = `Se guardar√°n ${ingresosCount} ingreso(s) y ${egresosCount} egreso(s). ¬øDesea continuar?`;
                this.dom.saveConfirmModal.classList.remove('hidden');
            },
            
            handleDatePromptContinue() {
                const selectedDate = this.dom.entryDateInput.value;
                if (!selectedDate) {
                    this.showToast('Por favor, selecciona una fecha.', 'error');
                    return;
                }
                this.showDataEntryView(selectedDate);
            },
            
            confirmDeleteDate(dateString, block) {
                this.state.pendingAction = { type: 'delete-date', data: { dateString, block } };
                this.dom.confirmModalTitle.textContent = "Confirmar Eliminaci√≥n";
                this.dom.confirmModalText.textContent = `¬øEst√°s seguro de que quieres eliminar todos los registros del d√≠a ${this.formatDate(dateString)}? Esta acci√≥n no se puede deshacer.`;
                this.dom.confirmModal.classList.remove('hidden');
            },

            handleConfirm() {
                if (!this.state.pendingAction) return;

                const {type, data} = this.state.pendingAction;

                if (type === 'delete-date') {
                    this.deleteDate(data.dateString, data.block);
                } else if (type === 'delete-single-transaction') {
                    this.deleteSingleTransaction(data.id, data.block);
                } else if (type === 'delete-category') {
                    this.deleteCategory(data.id);
                } else if (type === 'delete-reminder') {
                    this.deleteReminder(data.id);
                }
                this.dom.confirmModal.classList.add('hidden');
                this.state.pendingAction = null;
            },

            showEditColectaModal(id) {
                const item = this.state.envioColectas.find(i => i.id === id);
                if (!item) {
                    this.showToast("No se encontr√≥ el registro.", "error");
                    return;
                }

                this.dom.editColectaId.value = item.id;
                this.dom.editColectaDescripcion.value = item.descripcion;
                this.dom.editColectaMonto.value = item.monto !== null ? item.monto : ''; 
                
                this.dom.editColectaModal.classList.remove('hidden');
            },

            async handleUpdateColecta() {
                const id = this.dom.editColectaId.value;
                const descripcion = this.dom.editColectaDescripcion.value.trim();
                const montoInput = this.dom.editColectaMonto.value;

                if (!id || !descripcion) {
                    this.showToast("La descripci√≥n no puede estar vac√≠a.", "error");
                    return;
                }

                const monto = montoInput === '' ? null : parseFloat(montoInput);
                if (montoInput !== '' && isNaN(monto)) {
                    this.showToast("El monto ingresado no es v√°lido.", "error");
                    return;
                }

                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef("envio_colectas");
                    if (!collRef) throw new Error("Collection reference is null");
                    const docRef = doc(collRef, id);
                    await updateDoc(docRef, { 
                        descripcion: descripcion,
                        monto: monto 
                    });
                    this.dom.editColectaModal.classList.add('hidden');
                    this.showToast("Registro actualizado con √©xito.", "success");
                    // No need to reload data, onSnapshot will handle it.
                } catch (error) {
                    console.error("Error updating colecta:", error);
                    this.showToast("Error al actualizar el registro.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            async handleUpdateAporte() {
                const key = this.dom.editAporteKey.value;
                const newValue = parseFloat(this.dom.editAporteValue.value);

                if (!key || isNaN(newValue)) {
                    this.showToast("Por favor, ingresa un valor num√©rico v√°lido.", "error");
                    return;
                }

                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("configuracion_financiera"), "valores");
                    await updateDoc(docRef, { [key]: newValue });
                    this.showToast(`Valor actualizado con √©xito.`, "success");
                    this.dom.editAporteModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error updating aporte:", error);
                    this.showToast("Error al actualizar el valor.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            showEditAporteModal(key, label) {
                const currentValueText = this.dom[key].textContent;
                const currentValue = parseFloat(currentValueText.replace(/[^0-9,-]+/g,"").replace(",", "."));
                
                this.dom.editAporteTitle.textContent = `Modificar ${label}`;
                this.dom.editAporteKey.value = key;
                this.dom.editAporteValue.value = currentValue || 0;
                this.dom.editAporteModal.classList.remove('hidden');
            },

            async handleUpdateTransaction() {
                const id = this.dom.editTransactionId.value;
                const block = this.dom.editTransactionBlock.value;
                const categoria = this.dom.editTransactionCategoria.value;
                const descripcion = this.dom.editTransactionDescripcion.value;
                const monto = parseFloat(this.dom.editTransactionMonto.value);

                if (!id || !block || !categoria || isNaN(monto) || monto <= 0) {
                    this.showToast("Por favor, complete todos los campos con valores v√°lidos.", "error");
                    return;
                }

                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef(block === 'general' ? 'gestion_general' : 'gestion_banco');
                    const docRef = doc(collRef, id);
                    await updateDoc(docRef, { categoria, descripcion, monto });
                    
                    this.dom.editTransactionModal.classList.add('hidden');
                    this.showToast("Transacci√≥n actualizada.", "success");
                    
                    // The view will update automatically via onSnapshot
                    this.showEditDayView(this.state.currentEditDay.date, this.state.currentEditDay.block);

                } catch (error) {
                    console.error("Error updating transaction:", error);
                    this.showToast("Error al actualizar la transacci√≥n.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            handleDeleteSingleTransaction(id, block) {
                this.state.pendingAction = { type: 'delete-single-transaction', data: { id, block } };
                this.dom.confirmModalTitle.textContent = "Confirmar Eliminaci√≥n";
                this.dom.confirmModalText.textContent = `¬øEst√°s seguro de que quieres eliminar esta transacci√≥n? Esta acci√≥n no se puede deshacer.`;
                this.dom.confirmModal.classList.remove('hidden');
            },

            async deleteSingleTransaction(id, block) {
                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef(block === 'general' ? 'gestion_general' : 'gestion_banco');
                    const docRef = doc(collRef, id);
                    await deleteDoc(docRef);

                    this.showToast("Transacci√≥n eliminada.", "success");

                    // View will update automatically, but we need to check if we should close the edit view
                    const transactions = block === 'general' ? this.state.generalTransactions : this.state.bancoTransactions;
                    const remaining = transactions.filter(t => t.fecha === this.state.currentEditDay.date && t.id !== id);
                    if (remaining.length > 0) {
                        this.showEditDayView(this.state.currentEditDay.date, this.state.currentEditDay.block);
                    } else {
                        this.showMainView();
                    }
                } catch (error) {
                    console.error("Error deleting transaction:", error);
                    this.showToast("Error al eliminar la transacci√≥n.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            // --- BALANCE LOGIC ---
            generateAndDisplayBalance() {
                const startDate = this.dom.balanceStartDate.value;
                const endDate = this.dom.balanceEndDate.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, selecciona un rango de fechas para el balance.", "error");
                    return;
                }
                this.dom.balanceDateRange.textContent = `del ${this.formatDate(startDate)} al ${this.formatDate(endDate)}`;

                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                
                this.dom.balanceDetailsContainer.innerHTML = ''; // Clear previous balance

                if (generalInRange.length === 0 && bancoInRange.length === 0) {
                    this.dom.balanceDetailsContainer.innerHTML = '<p class="text-center text-gray-500">No se encontraron registros para el balance en el rango seleccionado.</p>';
                    return;
                }

                const balanceData = {
                    general: { ingresos: 0, egresos: 0, transacciones: generalInRange },
                    banco: { ingresos: 0, egresos: 0, transacciones: bancoInRange },
                };

                generalInRange.forEach(t => {
                    if (t.type === 'ingreso') balanceData.general.ingresos += t.monto;
                    else balanceData.general.egresos += t.monto;
                });

                bancoInRange.forEach(t => {
                    if (t.type === 'ingreso') balanceData.banco.ingresos += t.monto;
                    else balanceData.banco.egresos += t.monto;
                });
                
                const totalIngresos = balanceData.general.ingresos + balanceData.banco.ingresos;
                const totalEgresos = balanceData.general.egresos + balanceData.banco.egresos;
                const saldoFinal = totalIngresos - totalEgresos;

                let html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            ${this.renderBalanceTable('Ingresos y Egresos Generales', balanceData.general.transacciones, balanceData.general.ingresos, balanceData.general.egresos)}
                        </div>
                        <div>
                            ${this.renderBalanceTable('Movimientos de Banco', balanceData.banco.transacciones, balanceData.banco.ingresos, balanceData.banco.egresos)}
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t-2 border-gray-300 dark:border-slate-600 text-right font-bold text-xl">
                        <p class="mb-2">Total Ingresos: <span class="text-green-500">${this.formatCurrency(totalIngresos)}</span></p>
                        <p class="mb-2">Total Egresos: <span class="text-red-500">${this.formatCurrency(totalEgresos)}</span></p>
                        <p class="text-2xl">Saldo Final: <span class="${saldoFinal >= 0 ? 'text-green-600' : 'text-red-600'}">${this.formatCurrency(saldoFinal)}</span></p>
                    </div>
                `;

                this.dom.balanceDetailsContainer.innerHTML = html;
            },

            renderBalanceTable(title, transactions, totalIngresos, totalEgresos) {
                let rowsHtml = transactions.length > 0 ? transactions.sort((a,b) => a.fecha.localeCompare(b.fecha)).map(t => `
                    <tr class="border-b border-gray-200 dark:border-slate-700">
                        <td class="py-2 px-3">${this.formatDate(t.fecha)}</td>
                        <td class="py-2 px-3">${t.categoria}</td>
                        <td class="py-2 px-3 text-right">${t.type === 'ingreso' ? this.formatCurrency(t.monto) : '-'}</td>
                        <td class="py-2 px-3 text-right">${t.type === 'egreso' ? this.formatCurrency(t.monto) : '-'}</td>
                    </tr>
                `).join('') : '<tr><td colspan="4" class="text-center py-4">No hay movimientos</td></tr>';

                return `
                    <h3 class="text-xl font-semibold mb-3">${title}</h3>
                    <div class="overflow-auto max-h-96 rounded-lg shadow">
                        <table class="min-w-full bg-white dark:bg-slate-700">
                            <thead class="bg-gray-200 dark:bg-slate-600 sticky top-0">
                                <tr>
                                    <th class="py-2 px-3 text-left">Fecha</th>
                                    <th class="py-2 px-3 text-left">Categor√≠a</th>
                                    <th class="py-2 px-3 text-right">Ingreso</th>
                                    <th class="py-2 px-3 text-right">Egreso</th>
                                </tr>
                            </thead>
                            <tbody>${rowsHtml}</tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-3 bg-gray-100 dark:bg-slate-600 rounded-lg flex justify-between font-semibold">
                        <span>Subtotal Ingresos: <span class="text-green-500">${this.formatCurrency(totalIngresos)}</span></span>
                        <span>Subtotal Egresos: <span class="text-red-500">${this.formatCurrency(totalEgresos)}</span></span>
                    </div>
                `;
            },

            downloadBalancePDF() {
                const startDate = this.dom.balanceStartDate.value;
                const endDate = this.dom.balanceEndDate.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, filtra un rango de fechas primero.", "error");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.text(`Balance de la Parroquia San Jos√©`, 14, 20);
                doc.setFontSize(12);
                doc.text(`Periodo: ${this.formatDate(startDate)} al ${this.formatDate(endDate)}`, 14, 28);

                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);

                let finalY = 40;
                let totalIngresos = 0;
                let totalEgresos = 0;

                if (generalInRange.length > 0) {
                    doc.setFontSize(14);
                    doc.text("Ingresos y Egresos Generales", 14, finalY);
                    const body = generalInRange.sort((a,b) => a.fecha.localeCompare(b.fecha)).map(t => {
                        if (t.type === 'ingreso') totalIngresos += t.monto;
                        else totalEgresos += t.monto;
                        return [this.formatDate(t.fecha), t.categoria, t.type === 'ingreso' ? this.formatCurrency(t.monto) : '-', t.type === 'egreso' ? this.formatCurrency(t.monto) : '-'];
                    });
                    doc.autoTable({ startY: finalY + 5, head: [['Fecha', 'Categor√≠a', 'Ingreso', 'Egreso']], body });
                    finalY = doc.autoTable.previous.finalY;
                }

                if (bancoInRange.length > 0) {
                    finalY += 15;
                    doc.setFontSize(14);
                    doc.text("Movimientos de Banco", 14, finalY);
                    const body = bancoInRange.sort((a,b) => a.fecha.localeCompare(b.fecha)).map(t => {
                        if (t.type === 'ingreso') totalIngresos += t.monto;
                        else totalEgresos += t.monto;
                        return [this.formatDate(t.fecha), t.categoria, t.type === 'ingreso' ? this.formatCurrency(t.monto) : '-', t.type === 'egreso' ? this.formatCurrency(t.monto) : '-'];
                    });
                    doc.autoTable({ startY: finalY + 5, head: [['Fecha', 'Categor√≠a', 'Ingreso', 'Egreso']], body });
                    finalY = doc.autoTable.previous.finalY;
                }

                finalY += 15;
                doc.setFontSize(12);
                doc.text(`Total Ingresos: ${this.formatCurrency(totalIngresos)}`, 14, finalY);
                doc.text(`Total Egresos: ${this.formatCurrency(totalEgresos)}`, 14, finalY + 7);
                doc.setFontSize(14);
                doc.text(`Saldo Final: ${this.formatCurrency(totalIngresos - totalEgresos)}`, 14, finalY + 14);

                doc.save(`Balance_Parroquial_${startDate}_a_${endDate}.pdf`);
            },

            downloadBalanceExcel() {
                const startDate = this.dom.balanceStartDate.value;
                const endDate = this.dom.endDateFilter.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, filtra un rango de fechas primero.", "error");
                    return;
                }

                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Tipo de Registro,Fecha,Categoria,Descripcion,Ingreso,Egreso\r\n";

                let totalIngresos = 0;
                let totalEgresos = 0;

                const processTransactions = (label, transactions) => {
                    transactions.sort((a,b) => a.fecha.localeCompare(b.fecha)).forEach(t => {
                        const ingreso = t.type === 'ingreso' ? t.monto : 0;
                        const egreso = t.type === 'egreso' ? t.monto : 0;
                        totalIngresos += ingreso;
                        totalEgresos += egreso;
                        const row = [label, t.fecha, t.categoria, `"${t.descripcion || ''}"`, ingreso, egreso].join(",");
                        csvContent += row + "\r\n";
                    });
                };
                
                processTransactions("General", generalInRange);
                processTransactions("Banco", bancoInRange);
                
                csvContent += "\r\n";
                csvContent += `,,,Total Ingresos,${totalIngresos}\r\n`;
                csvContent += `,,,Total Egresos,${totalEgresos}\r\n`;
                csvContent += `,,,Saldo Final,${totalIngresos - totalEgresos}\r\n`;

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `Balance_Parroquial_${startDate}_a_${endDate}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            // --- UTILITIES ---
            toggleLoader(show) {
                this.dom.loader.classList.toggle('hidden', !show);
            },

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                this.dom.toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            },

            handleConnectionChange(isOnline) {
                this.state.isOnline = isOnline;
                const banner = this.dom.connectionStatus;
                const text = this.dom.connectionStatusText;

                banner.classList.remove('bg-red-600', 'bg-yellow-500', 'bg-green-600');

                if (!isOnline) {
                    banner.classList.add('bg-red-600');
                    text.textContent = "Est√° trabajando sin conexi√≥n. Los datos se guardar√°n cuando recupere la conexi√≥n.";
                    banner.classList.remove('hidden');
                    banner.classList.add('show');
                } else {
                    banner.classList.add('bg-yellow-500');
                    text.textContent = "Conexi√≥n recuperada. Sincronizando datos...";
                    banner.classList.add('show');

                    setTimeout(() => {
                        banner.classList.remove('bg-yellow-500');
                        banner.classList.add('bg-green-600');
                        text.textContent = "¬°Conexi√≥n recuperada! Sus datos est√°n guardados en la nube.";
                        setTimeout(() => {
                            banner.classList.remove('show');
                        }, 4000);
                    }, 2000);
                }
            },

            downloadDateRangePDF() {
                const startDate = this.dom.startDateFilter.value;
                const endDate = this.dom.endDateFilter.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, selecciona un rango de fechas.", "error");
                    return;
                }

                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);

                if (generalInRange.length === 0 && bancoInRange.length === 0) {
                    this.showToast("No hay datos para el rango seleccionado.", "error");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.text(`Reporte Parroquial del ${this.formatDate(startDate)} al ${this.formatDate(endDate)}`, 14, 20);

                let finalY = 30;

                if(generalInRange.length > 0) {
                    doc.text("Ingresos y Egresos Generales", 14, finalY);
                    const generalBody = generalInRange.sort((a,b) => a.fecha.localeCompare(b.fecha)).map(t => [this.formatDate(t.fecha), t.categoria, t.descripcion, t.type, this.formatCurrency(t.monto)]);
                    doc.autoTable({
                        startY: finalY + 5,
                        head: [['Fecha', 'Categor√≠a', 'Descripci√≥n', 'Tipo', 'Monto']],
                        body: generalBody,
                    });
                    finalY = doc.autoTable.previous.finalY;
                }

                if(bancoInRange.length > 0) {
                    doc.text("Movimientos de Banco", 14, finalY + 15);
                     const bancoBody = bancoInRange.sort((a,b) => a.fecha.localeCompare(b.fecha)).map(t => [this.formatDate(t.fecha), t.categoria, t.descripcion, t.type, this.formatCurrency(t.monto)]);
                    doc.autoTable({
                        startY: finalY + 20,
                        head: [['Fecha', 'Categor√≠a', 'Descripci√≥n', 'Tipo', 'Monto']],
                        body: bancoBody,
                    });
                }
                
                doc.save(`reporte_${startDate}_${endDate}.pdf`);
            },

            formatCurrency(amount) {
                if (typeof amount !== 'number') return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(0);
                return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(amount);
            },

            formatDate(dateString) {
                if (!dateString || !dateString.includes('-')) return dateString;
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            },

            // --- CATEGORY MANAGEMENT ---
            async checkAndSeedCategories() {
                const collRef = this.getCollectionRef("categorias");
                if (!collRef) return;
                const snapshot = await getDocs(collRef);
                if (snapshot.empty) {
                    console.log("Seeding default categories...");
                    const defaultCategories = {
                        general: {
                            ingreso: ["COLECTAS IMPERADAS", "COLECTAS PARROQUIA", "DONACIONES", "BENEFICIOS", "ESTIPENDOS", "OTRO"],
                            egreso: ["DEUDA OBISPADO", "SUELDO CAMILA", "SUELDO JULIO", "CARGAS SOCIALES EMPLEADOS", "ASIGNACION P.ADAN", "ASIGNACION P.JORGE", "MUTUAL DE LOS SACERDOTES", "COMBUSTIBLE", "LITURGIA", "EMPLEADA DE LA CASA PARROQUIAL", "SEGUROS DE LOS AUTOS", "APORTE PARA SEMINARIO", "MANTEMIENTO VEHICULOS", "MANTENIMIENTO DE LA CASA", "COMESTIBLE CASA PARROQUIAL", "SERVICIOS DE INTERNET", "OTRO"]
                        },
                        banco: {
                            ingreso: ["DEPOSITO CAPILLA BONPLAND", "DEPOSITO DE COLECTAS", "OTRO"],
                            egreso: ["DEBITO AUTOMATICO", "EXTRACCION", "OTRO"]
                        }
                    };
                    const batch = writeBatch(this.state.db);
                    for (const block in defaultCategories) {
                        for (const type in defaultCategories[block]) {
                            defaultCategories[block][type].forEach(name => {
                                const newDocRef = doc(collRef);
                                batch.set(newDocRef, { name, block, type });
                            });
                        }
                    }
                    await batch.commit();
                }
            },

            listenToCategories() {
                const collRef = this.getCollectionRef("categorias");
                if (!collRef) return;
                onSnapshot(collRef, (snapshot) => {
                    const loadedCategories = {
                        general: { ingreso: [], egreso: [] },
                        banco: { ingreso: [], egreso: [] }
                    };
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        loadedCategories[data.block][data.type].push({ id: doc.id, ...data });
                    });
                    for (const block in loadedCategories) {
                        for (const type in loadedCategories[block]) {
                            loadedCategories[block][type].sort((a, b) => a.name.localeCompare(b.name));
                        }
                    }
                    this.state.categories = loadedCategories;
                    if (this.state.currentView === 'category-management-view') {
                        this.renderCategoryLists();
                    }
                });
            },

            showCategoryManagementView() {
                this.switchView('category-management-view');
                this.renderCategoryLists();
            },

            renderCategoryLists() {
                this.dom.categoryGeneralIngresoContainer.innerHTML = this.createCategorySectionHTML('general', 'ingreso', 'Ingresos', 'green');
                this.dom.categoryGeneralEgresoContainer.innerHTML = this.createCategorySectionHTML('general', 'egreso', 'Egresos', 'red');
                this.dom.categoryBancoIngresoContainer.innerHTML = this.createCategorySectionHTML('banco', 'ingreso', 'Ingresos', 'green');
                this.dom.categoryBancoEgresoContainer.innerHTML = this.createCategorySectionHTML('banco', 'egreso', 'Egresos', 'red');
            },

            createCategorySectionHTML(block, type, title, color) {
                const categories = this.state.categories[block][type];
                let listItems = categories.map(cat => `
                    <li class="flex justify-between items-center p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md">
                        <span>${cat.name}</span>
                        <div class="flex gap-2">
                            <button data-action="edit-category" data-id="${cat.id}" data-name="${cat.name}" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                            <button data-action="delete-category" data-id="${cat.id}" data-name="${cat.name}" class="text-xs btn-gradient bg-gradient-to-r from-red-600 to-red-700 text-white px-3 py-1 rounded-md">Eliminar</button>
                        </div>
                    </li>
                `).join('');

                return `
                    <div class="bg-gray-50 dark:bg-slate-700/50 p-4 rounded-xl">
                        <h4 class="text-xl font-semibold mb-3 text-${color}-500">${title}</h4>
                        <ul class="space-y-2 mb-4 h-48 overflow-y-auto pr-2">${listItems}</ul>
                        <div class="flex gap-2">
                            <input type="text" id="new-category-${block}-${type}" placeholder="Nueva categor√≠a..." class="flex-grow p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                            <button data-action="add-category" data-block="${block}" data-type="${type}" class="btn-gradient bg-gradient-to-r from-${color}-500 to-${color}-600 text-white font-semibold px-4 py-2 rounded-lg">A√±adir</button>
                        </div>
                    </div>
                `;
            },

            async handleAddCategory(block, type) {
                const input = document.getElementById(`new-category-${block}-${type}`);
                const name = input.value.trim();
                if (!name) {
                    this.showToast("El nombre de la categor√≠a no puede estar vac√≠o.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef("categorias");
                    await addDoc(collRef, { name, block, type });
                    input.value = '';
                    this.showToast("Categor√≠a a√±adida.", "success");
                } catch (error) {
                    console.error("Error adding category:", error);
                    this.showToast("No se pudo a√±adir la categor√≠a.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            
            showEditCategoryModal(id, currentName) {
                this.dom.editCategoryId.value = id;
                this.dom.editCategoryName.value = currentName;
                this.dom.editCategoryModal.classList.remove('hidden');
            },

            async handleUpdateCategory() {
                const id = this.dom.editCategoryId.value;
                const newName = this.dom.editCategoryName.value.trim();
                if (!newName) {
                    this.showToast("El nombre no puede estar vac√≠o.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("categorias"), id);
                    await updateDoc(docRef, { name: newName });
                    this.dom.editCategoryModal.classList.add('hidden');
                    this.showToast("Categor√≠a actualizada.", "success");
                } catch (error) {
                    console.error("Error updating category:", error);
                    this.showToast("No se pudo actualizar la categor√≠a.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            handleDeleteCategory(id, name) {
                this.state.pendingAction = { type: 'delete-category', data: { id } };
                this.dom.confirmModalTitle.textContent = "Confirmar Eliminaci√≥n";
                this.dom.confirmModalText.textContent = `¬øSeguro que quieres eliminar la categor√≠a "${name}"? Esta acci√≥n no se puede deshacer.`;
                this.dom.confirmModal.classList.remove('hidden');
            },

            async deleteCategory(id) {
                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("categorias"), id);
                    await deleteDoc(docRef);
                    this.showToast("Categor√≠a eliminada.", "success");
                } catch (error) {
                    console.error("Error deleting category:", error);
                    this.showToast("No se pudo eliminar la categor√≠a.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

             // --- REMINDERS MANAGEMENT ---
            showRemindersManagementView() {
                this.switchView('reminders-management-view');
                this.renderRemindersList();
            },

            listenToReminders() {
                const collRef = this.getCollectionRef("recordatorios");
                if (!collRef) return;
                onSnapshot(collRef, (snapshot) => {
                    this.state.reminders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(this.state.currentView === 'reminders-management-view') {
                        this.renderRemindersList();
                    }
                    this.updateReminders();
                });
            },

            renderRemindersList() {
                const container = this.dom.remindersListContainer;
                container.innerHTML = '';
                if (this.state.reminders.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">No hay recordatorios personalizados.</p>';
                    return;
                }
                const sortedReminders = [...this.state.reminders].sort((a,b) => a.fecha.localeCompare(b.fecha));

                sortedReminders.forEach(reminder => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-3 bg-gray-100 dark:bg-slate-700 rounded-lg';
                    item.innerHTML = `
                        <div>
                            <p class="font-bold">${reminder.titulo}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${this.formatDate(reminder.fecha)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button data-action="edit-reminder" data-id="${reminder.id}" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                            <button data-action="delete-reminder" data-id="${reminder.id}" class="text-xs btn-gradient bg-gradient-to-r from-red-600 to-red-700 text-white px-3 py-1 rounded-md">Eliminar</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            },

            async handleAddReminder() {
                const title = this.dom.reminderTitle.value.trim();
                const date = this.dom.reminderDate.value;
                if (!title || !date) {
                    this.showToast("El t√≠tulo y la fecha son obligatorios.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef("recordatorios");
                    await addDoc(collRef, { titulo: title, fecha: date });
                    this.dom.newReminderForm.reset();
                    this.showToast("Recordatorio a√±adido.", "success");
                } catch (error) {
                    console.error("Error adding reminder:", error);
                    this.showToast("No se pudo a√±adir el recordatorio.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            
            showEditReminderModal(id) {
                const reminder = this.state.reminders.find(r => r.id === id);
                if (!reminder) return;
                this.dom.editReminderId.value = id;
                this.dom.editReminderTitle.value = reminder.titulo;
                this.dom.editReminderDate.value = reminder.fecha;
                this.dom.editReminderModal.classList.remove('hidden');
            },

            async handleUpdateReminder() {
                const id = this.dom.editReminderId.value;
                const titulo = this.dom.editReminderTitle.value.trim();
                const fecha = this.dom.editReminderDate.value;
                if (!titulo || !fecha) {
                    this.showToast("El t√≠tulo y la fecha no pueden estar vac√≠os.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("recordatorios"), id);
                    await updateDoc(docRef, { titulo, fecha });
                    this.dom.editReminderModal.classList.add('hidden');
                    this.showToast("Recordatorio actualizado.", "success");
                } catch (error) {
                    console.error("Error updating reminder:", error);
                    this.showToast("No se pudo actualizar.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            handleDeleteReminder(id) {
                this.state.pendingAction = { type: 'delete-reminder', data: { id } };
                this.dom.confirmModalTitle.textContent = "Confirmar Eliminaci√≥n";
                this.dom.confirmModalText.textContent = `¬øSeguro que quieres eliminar este recordatorio?`;
                this.dom.confirmModal.classList.remove('hidden');
            },

            async deleteReminder(id) {
                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("recordatorios"), id);
                    await deleteDoc(docRef);
                    this.showToast("Recordatorio eliminado.", "success");
                } catch (error) {
                    console.error("Error deleting reminder:", error);
                    this.showToast("No se pudo eliminar.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

             // --- NOTIFICATIONS ---
            updateReminders() {
                const notifications = this.getUpcomingNotifications();
                this.dom.notificationBadge.classList.toggle('hidden', notifications.length === 0);
                
                if (notifications.length > 0) {
                    this.dom.remindersList.innerHTML = notifications.map(n => `
                        <li class="border-b border-gray-200 dark:border-slate-600 pb-2">
                            <p class="font-semibold">${n.title}</p>
                            <p class="text-slate-500 dark:text-slate-400">${n.dateText} (${n.daysAway === 0 ? 'Hoy' : `en ${n.daysAway} d√≠a(s)`})</p>
                        </li>
                    `).join('');
                } else {
                    this.dom.remindersList.innerHTML = '<li><p class="text-slate-500 dark:text-slate-400">No hay recordatorios pr√≥ximos.</p></li>';
                }
            },

            getUpcomingNotifications() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const upcoming = [];
                const reminderDays = 15;
                const monthMap = { "ENERO": 0, "FEBRERO": 1, "MARZO": 2, "ABRIL": 3, "MAYO": 4, "JUNIO": 5, "JULIO": 6, "AGOSTO": 7, "SEPTIEMBRE": 8, "OCTUBRE": 9, "NOVIEMBRE": 10, "DICIEMBRE": 11 };

                // Process static collections
                this.state.envioColectas.forEach(colecta => {
                    const dateString = colecta.fecha.toUpperCase();
                    const parts = dateString.split(' ');
                    const dayPart = parts[0].split('-')[0];
                    const monthPart = parts[parts.length - 1];
                    
                    if (dayPart && monthMap[monthPart] !== undefined) {
                        const day = parseInt(dayPart);
                        const month = monthMap[monthPart];
                        const year = today.getFullYear();
                        const colectaDate = new Date(year, month, day);
                        
                        const timeDiff = colectaDate.getTime() - today.getTime();
                        const daysAway = Math.ceil(timeDiff / (1000 * 3600 * 24));

                        if (daysAway >= 0 && daysAway <= reminderDays) {
                            upcoming.push({ title: `Colecta: ${colecta.descripcion}`, dateText: colecta.fecha, daysAway });
                        }
                    }
                });

                // Process dynamic reminders
                this.state.reminders.forEach(reminder => {
                    const [year, month, day] = reminder.fecha.split('-').map(Number);
                    const reminderDate = new Date(year, month - 1, day);
                    const timeDiff = reminderDate.getTime() - today.getTime();
                    const daysAway = Math.ceil(timeDiff / (1000 * 3600 * 24));

                    if (daysAway >= 0 && daysAway <= reminderDays) {
                        upcoming.push({ title: reminder.titulo, dateText: this.formatDate(reminder.fecha), daysAway });
                    }
                });

                return upcoming.sort((a,b) => a.daysAway - b.daysAway);
            },
        };

        // Start the application
        App.init();

    </script>
</body>
</html>
