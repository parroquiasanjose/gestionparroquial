<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Parroquial - San Jos√©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-hover-effect { transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; }
        .card-hover-effect:hover { transform: translateY(-5px); }
        .hidden { display: none; }
        .btn-gradient {
            transition: all 0.3s ease-in-out;
        }
        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards;
        }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        /* Loading Spinner */
        #loader {
            background: rgba(0, 0, 0, 0.6);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <!-- LOADING OVERLAY -->
    <div id="loader" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-blue-500"></div>
    </div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container"></div>

    <!-- NAVIGATION MENU -->
    <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Gesti√≥n Parroquial</h1>
            <a href="./index.html" class="btn-gradient bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">Volver al Panel</a>
        </div>
    </nav>

    <div class="container mx-auto p-6">

        <!-- MAIN VIEW -->
        <main id="main-view">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- General Income and Expenses Block -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg flex flex-col">
                    <div class="text-6xl text-center mb-4">‚õ™</div>
                    <h2 class="text-2xl font-bold mb-4 text-center">Ingresos y Egresos Generales</h2>
                    <div class="grid grid-cols-1 gap-4 mb-6">
                        <button data-action="load-data" data-block="general" class="card-hover-effect btn-gradient bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl shadow-lg text-center">Cargar Datos</button>
                    </div>
                     <div class="mb-4">
                        <input type="text" id="search-general-input" placeholder="Buscar por fecha (dd/mm/aaaa)..." class="w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                    </div>
                    <div id="history-general-container" class="space-y-4 min-h-[24rem] flex-grow flex flex-col justify-between"></div>
                </div>

                <!-- Bank Block -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg flex flex-col">
                    <div class="text-6xl text-center mb-4">üè¶</div>
                    <h2 class="text-2xl font-bold mb-4 text-center">Banco</h2>
                    <div class="grid grid-cols-1 gap-4 mb-6">
                        <button data-action="load-data" data-block="banco" class="card-hover-effect btn-gradient bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl shadow-lg text-center">Cargar Datos</button>
                    </div>
                     <div class="mb-4">
                        <input type="text" id="search-banco-input" placeholder="Buscar por fecha (dd/mm/aaaa)..." class="w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                    </div>
                    <div id="history-banco-container" class="space-y-4 min-h-[24rem] flex-grow flex flex-col justify-between"></div>
                </div>

                <!-- Information Block -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg flex flex-col">
                    <div class="text-6xl text-center mb-4">‚ÑπÔ∏è</div>
                    <h2 class="text-2xl font-bold mb-4 text-center">Informaci√≥n</h2>
                    <div class="flex flex-col gap-4 mb-6 flex-grow justify-center">
                        <button id="envios-colectas-btn" class="card-hover-effect btn-gradient bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-4 rounded-xl shadow-lg text-center">Fecha de Env√≠os de Colectas</button>
                        <button id="aportes-btn" class="card-hover-effect btn-gradient bg-gradient-to-r from-teal-500 to-cyan-500 text-white p-4 rounded-xl shadow-lg text-center">Sueldos y Aportes</button>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-bold mb-4">Balance</h3>
                <button id="balance-btn" class="w-full btn-gradient bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg hover:from-purple-700 hover:to-indigo-700">Ver Balance Completo</button>
            </div>

             <div class="mt-8 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-bold mb-4">Reporte por Rango</h3>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <input type="date" id="start-date-filter" class="flex-1 p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                    <input type="date" id="end-date-filter" class="flex-1 p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                    <button id="search-range-btn" class="w-full md:w-auto btn-gradient bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:from-blue-700 hover:to-blue-800">Buscar</button>
                    <button id="download-range-pdf-btn" class="w-full md:w-auto btn-gradient bg-gradient-to-r from-red-600 to-red-700 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:from-red-700 hover:to-red-800">Descargar PDF</button>
                </div>
                <div id="range-results-container" class="mt-6 hidden">
                    <!-- Results will be injected here -->
                </div>
            </div>
        </main>

        <!-- DATE PROMPT VIEW -->
        <section id="date-prompt-view" class="hidden max-w-2xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
            <h2 id="date-prompt-title" class="text-3xl font-bold mb-6 text-center"></h2>
            <div class="mb-6">
                <label for="entry-date-input" class="block text-sm font-medium text-center">Confirme la fecha de carga</label>
                <input type="date" id="entry-date-input" required class="mt-1 mx-auto block w-full max-w-xs p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
            </div>
            <div class="flex flex-col gap-4">
                <button id="continue-to-form-btn" class="w-full btn-gradient bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:from-blue-600 hover:to-blue-700">Continuar</button>
                <button id="back-from-date-prompt-btn" class="w-full btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
            </div>
        </section>

        <!-- DATA ENTRY VIEW -->
        <section id="data-entry-view" class="hidden max-w-7xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
            <h2 id="data-entry-title" class="text-3xl font-bold mb-4 text-center"></h2>
            <div class="mb-6">
                <label for="shared-date" class="block text-sm font-medium text-center">Fecha de Operaciones</label>
                <input type="date" id="shared-date" required class="mt-1 mx-auto block w-full max-w-xs p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Ingreso Form -->
                <div class="bg-gray-50 dark:bg-slate-700 p-6 rounded-xl">
                    <h3 class="text-2xl font-bold mb-4 text-green-500">Registrar Ingreso</h3>
                    <form id="ingreso-form" class="space-y-4">
                        <div>
                            <label for="ingreso-categoria" class="block text-sm font-medium">Categor√≠a</label>
                            <select id="ingreso-categoria" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600"></select>
                        </div>
                        <div>
                            <label for="ingreso-descripcion" class="block text-sm font-medium">Descripci√≥n</label>
                            <textarea id="ingreso-descripcion" rows="2" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600"></textarea>
                        </div>
                        <div>
                            <label for="ingreso-monto" class="block text-sm font-medium">Monto</label>
                            <input type="number" id="ingreso-monto" required min="0" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                        </div>
                        <button type="button" id="add-ingreso-btn" class="w-full btn-gradient bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold py-2 rounded-xl shadow-lg hover:from-green-600 hover:to-green-700">Confirmar y Cargar Otro</button>
                    </form>
                </div>
                <!-- Egreso Form -->
                <div class="bg-gray-50 dark:bg-slate-700 p-6 rounded-xl">
                    <h3 class="text-2xl font-bold mb-4 text-red-500">Registrar Egreso</h3>
                    <form id="egreso-form" class="space-y-4">
                         <div>
                            <label for="egreso-categoria" class="block text-sm font-medium">Categor√≠a</label>
                            <select id="egreso-categoria" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600"></select>
                        </div>
                        <div>
                            <label for="egreso-descripcion" class="block text-sm font-medium">Descripci√≥n</label>
                            <textarea id="egreso-descripcion" rows="2" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600"></textarea>
                        </div>
                        <div>
                            <label for="egreso-monto" class="block text-sm font-medium">Monto</label>
                            <input type="number" id="egreso-monto" required min="0" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                        </div>
                        <button type="button" id="add-egreso-btn" class="w-full btn-gradient bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold py-2 rounded-xl shadow-lg hover:from-red-600 hover:to-red-700">Confirmar y Cargar Otro</button>
                    </form>
                </div>
            </div>

            <div class="mt-8">
                <h3 class="text-xl font-bold mb-2">Registros a Guardar</h3>
                <div id="added-transactions-list" class="space-y-2 max-h-48 overflow-y-auto bg-gray-100 dark:bg-slate-900 p-4 rounded-lg"></div>
            </div>

            <div class="mt-8 flex flex-col md:flex-row gap-4 justify-end">
                <button id="save-all-btn" class="btn-gradient bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:from-blue-700 hover:to-blue-800">Guardar los Datos</button>
                <button id="back-from-form-btn" class="btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
            </div>
        </section>

        <!-- EDIT DAY VIEW -->
        <section id="edit-day-view" class="hidden max-w-4xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
            <h2 id="edit-day-title" class="text-3xl font-bold mb-6 text-center"></h2>
            <div id="edit-day-list" class="space-y-3"></div>
            <button id="back-from-edit-day-btn" class="mt-8 w-full btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
        </section>
        
        <!-- COLLECTIONS VIEW -->
        <section id="envio-colectas-view" class="hidden max-w-4xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
            <h2 class="text-3xl font-bold mb-6 text-center">Fechas de Env√≠o de Colectas</h2>
            <div id="envio-colectas-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
            <div class="mt-6 pt-4 border-t border-gray-300 dark:border-slate-600">
                <p class="text-xl font-bold text-right">Subtotal Enviado: <span id="envio-subtotal" class="text-green-500"></span></p>
            </div>
             <button id="back-from-envios-btn" class="mt-6 w-full btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
        </section>

        <!-- APORTES VIEW -->
        <section id="aportes-view" class="hidden max-w-4xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
            <h2 class="text-3xl font-bold mb-6 text-center">Sueldos y Aportes</h2>
            <div id="aportes-container" class="space-y-6">
                <div>
                    <h3 class="text-xl font-semibold border-b border-gray-300 dark:border-slate-600 pb-2 mb-3">SUELDOS</h3>
                    <div class="space-y-2 pl-4">
                        <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                            <span>CAMILA</span>
                            <div class="flex items-center gap-4">
                                <span id="sueldo_camila" class="font-semibold w-32 text-right"></span>
                                <button data-key="sueldo_camila" data-label="Sueldo Camila" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                            <span>JULIO</span>
                            <div class="flex items-center gap-4">
                                <span id="sueldo_julio" class="font-semibold w-32 text-right"></span>
                                <button data-key="sueldo_julio" data-label="Sueldo Julio" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                            <span>CARGAS SOCIALES</span>
                            <div class="flex items-center gap-4">
                                <span id="cargas_sociales" class="font-semibold w-32 text-right"></span>
                                <button data-key="cargas_sociales" data-label="Cargas Sociales" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold border-b border-gray-300 dark:border-slate-600 pb-2 mb-3">APORTE SACERDOTES</h3>
                    <h4 class="text-lg font-medium pl-4 mb-2">ASIGNACION</h4>
                    <div class="space-y-2 pl-8">
                        <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                            <span>P. JORGE</span>
                            <div class="flex items-center gap-4">
                                <span id="asignacion_jorge" class="font-semibold w-32 text-right"></span>
                                <button data-key="asignacion_jorge" data-label="Asignaci√≥n P. Jorge" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                            <span>P. ADAN</span>
                            <div class="flex items-center gap-4">
                                <span id="asignacion_adan" class="font-semibold w-32 text-right"></span>
                                <button data-key="asignacion_adan" data-label="Asignaci√≥n P. Adan" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                            <span>MUTUAL P. JORGE</span>
                            <div class="flex items-center gap-4">
                                <span id="mutual_jorge" class="font-semibold w-32 text-right"></span>
                                <button data-key="mutual_jorge" data-label="Mutual P. Jorge" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                            <span>MUTUAL P. ADAN</span>
                            <div class="flex items-center gap-4">
                                <span id="mutual_adan" class="font-semibold w-32 text-right"></span>
                                <button data-key="mutual_adan" data-label="Mutual P. Adan" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold border-b border-gray-300 dark:border-slate-600 pb-2 mb-3">APORTE POR SEMINARISTAS</h3>
                     <div class="space-y-2 pl-4">
                        <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                            <span>jun-25</span>
                            <div class="flex items-center gap-4">
                                <span id="aporte_seminaristas_jun25" class="font-semibold w-32 text-right"></span>
                                <button data-key="aporte_seminaristas_jun25" data-label="Aporte Seminaristas (jun-25)" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                            </div>
                        </div>
                         <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                            <span>DIVIDIDO POR 4 PARROQUIAS</span>
                            <div class="flex items-center gap-4">
                                <span id="aporte_seminaristas_dividido" class="font-semibold w-32 text-right"></span>
                                <button data-key="aporte_seminaristas_dividido" data-label="Aporte dividido" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                            </div>
                        </div>
                         <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg">
                            <span>jul-25</span>
                            <div class="flex items-center gap-4">
                                <span id="aporte_seminaristas_jul25" class="font-semibold w-32 text-right"></span>
                                <button data-key="aporte_seminaristas_jul25" data-label="Aporte Seminaristas (jul-25)" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-md">Editar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button id="back-from-aportes-btn" class="mt-8 w-full btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
        </section>

        <!-- BALANCE VIEW -->
        <section id="balance-view" class="hidden max-w-7xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
            <h2 id="balance-title" class="text-3xl font-bold mb-2 text-center">Balance de la Parroquia San Jos√©</h2>
            <p id="balance-date-range" class="text-center text-gray-500 dark:text-gray-400 mb-6"></p>
            
            <div class="bg-gray-50 dark:bg-slate-700 p-4 rounded-lg mb-6">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <input type="date" id="balance-start-date" class="flex-1 p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                    <input type="date" id="balance-end-date" class="flex-1 p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                    <button id="filter-balance-btn" class="w-full md:w-auto btn-gradient bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:from-blue-700 hover:to-blue-800">Buscar</button>
                </div>
            </div>

            <div id="balance-details-container" class="space-y-8">
                <!-- Balance details will be injected here -->
            </div>

            <div class="mt-8 pt-6 border-t border-gray-300 dark:border-slate-600 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex gap-4">
                    <button id="download-balance-pdf-btn" class="btn-gradient bg-gradient-to-r from-red-600 to-red-700 text-white font-semibold py-2 px-6 rounded-xl shadow-lg hover:from-red-700 hover:to-red-800">Descargar PDF</button>
                    <button id="download-balance-excel-btn" class="btn-gradient bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold py-2 px-6 rounded-xl shadow-lg hover:from-green-700 hover:to-green-800">Descargar Excel</button>
                </div>
                <button id="back-from-balance-btn" class="w-full md:w-auto btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700">Volver</button>
            </div>
        </section>
    </div>

    <!-- MODALS -->
    <div id="save-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-auto text-center">
            <h3 class="text-xl font-bold mb-4">Confirmar Guardado</h3>
            <p id="save-confirm-text" class="mb-6">Se guardar√°n todos los datos cargados. ¬øDesea continuar?</p>
            <div class="flex justify-center gap-4">
                <button id="save-confirm-ok" class="btn-gradient bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-bold py-2 px-6 rounded-lg">S√≠, Guardar</button>
                <button id="save-confirm-cancel" class="btn-gradient bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-2 px-6 rounded-lg">No</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-auto text-center">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="confirm-modal-text" class="mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-ok" class="btn-gradient bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
                <button id="confirm-modal-cancel" class="btn-gradient bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>
    <!-- MODAL PARA EDITAR COLECTA -->
    <div id="edit-colecta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-auto">
            <h3 class="text-2xl font-bold mb-6 text-center">Editar Env√≠o de Colecta</h3>
            <form id="edit-colecta-form" class="space-y-4">
                <input type="hidden" id="edit-colecta-id">
                <div>
                    <label for="edit-colecta-descripcion" class="block text-sm font-medium">Descripci√≥n</label>
                    <input type="text" id="edit-colecta-descripcion" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                </div>
                <div>
                    <label for="edit-colecta-monto" class="block text-sm font-medium">Monto</label>
                    <input type="number" id="edit-colecta-monto" min="0" step="0.01" placeholder="Dejar en blanco si no aplica" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="edit-colecta-cancel-btn" class="btn-gradient bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button type="button" id="edit-colecta-save-btn" class="btn-gradient bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-bold py-2 px-6 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <!-- MODAL PARA EDITAR TRANSACCI√ìN INDIVIDUAL -->
    <div id="edit-transaction-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-auto">
            <h3 id="edit-transaction-title" class="text-2xl font-bold mb-6 text-center"></h3>
            <form id="edit-transaction-form" class="space-y-4">
                <input type="hidden" id="edit-transaction-id">
                <input type="hidden" id="edit-transaction-block">
                <div>
                    <label for="edit-transaction-categoria" class="block text-sm font-medium">Categor√≠a</label>
                    <select id="edit-transaction-categoria" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600"></select>
                </div>
                <div>
                    <label for="edit-transaction-descripcion" class="block text-sm font-medium">Descripci√≥n</label>
                    <textarea id="edit-transaction-descripcion" rows="3" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600"></textarea>
                </div>
                <div>
                    <label for="edit-transaction-monto" class="block text-sm font-medium">Monto</label>
                    <input type="number" id="edit-transaction-monto" required min="0" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-600">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="edit-transaction-cancel-btn" class="btn-gradient bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button type="button" id="edit-transaction-save-btn" class="btn-gradient bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-bold py-2 px-6 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, where, writeBatch, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Main App Object
        const App = {
            // --- STATE ---
            state: {
                db: null,
                auth: null,
                userId: null,
                generalTransactions: [],
                bancoTransactions: [],
                envioColectas: [],
                currentTransactions: [], // For batch adding/editing
                editingId: null,
                pendingAction: null, // For modals
                isLoading: true,
                currentBlock: null, // To know which block we are loading data for
                generalCurrentPage: 1,
                bancoCurrentPage: 1,
                recordsPerPage: 3,
                currentEditDay: { date: null, block: null },
            },

            // --- DOM ELEMENTS ---
            dom: {},

            // --- INITIALIZATION ---
            init() {
                this.cacheDom();
                this.bindEvents();
                this.initFirebase();
            },

            cacheDom() {
                this.dom = {
                    loader: document.getElementById('loader'),
                    toastContainer: document.getElementById('toast-container'),
                    mainView: document.getElementById('main-view'),
                    dataEntryView: document.getElementById('data-entry-view'),
                    datePromptView: document.getElementById('date-prompt-view'),
                    editDayView: document.getElementById('edit-day-view'),
                    envioColectasView: document.getElementById('envio-colectas-view'),
                    aportesView: document.getElementById('aportes-view'),
                    balanceView: document.getElementById('balance-view'),
                    aportesContainer: document.getElementById('aportes-container'),
                    envioColectasList: document.getElementById('envio-colectas-list'),
                    envioSubtotal: document.getElementById('envio-subtotal'),
                    enviosColectasBtn: document.getElementById('envios-colectas-btn'),
                    aportesBtn: document.getElementById('aportes-btn'),
                    balanceBtn: document.getElementById('balance-btn'),
                    backFromEnviosBtn: document.getElementById('back-from-envios-btn'),
                    backFromAportesBtn: document.getElementById('back-from-aportes-btn'),
                    backFromBalanceBtn: document.getElementById('back-from-balance-btn'),
                    backFromFormBtn: document.getElementById('back-from-form-btn'),
                    backFromDatePromptBtn: document.getElementById('back-from-date-prompt-btn'),
                    backFromEditDayBtn: document.getElementById('back-from-edit-day-btn'),
                    datePromptTitle: document.getElementById('date-prompt-title'),
                    entryDateInput: document.getElementById('entry-date-input'),
                    continueToFormBtn: document.getElementById('continue-to-form-btn'),
                    dataEntryTitle: document.getElementById('data-entry-title'),
                    sharedDate: document.getElementById('shared-date'),
                    ingresoForm: document.getElementById('ingreso-form'),
                    egresoForm: document.getElementById('egreso-form'),
                    ingresoCategoria: document.getElementById('ingreso-categoria'),
                    ingresoDescripcion: document.getElementById('ingreso-descripcion'),
                    ingresoMonto: document.getElementById('ingreso-monto'),
                    egresoCategoria: document.getElementById('egreso-categoria'),
                    egresoDescripcion: document.getElementById('egreso-descripcion'),
                    egresoMonto: document.getElementById('egreso-monto'),
                    addIngresoBtn: document.getElementById('add-ingreso-btn'),
                    addEgresoBtn: document.getElementById('add-egreso-btn'),
                    addedTransactionsSummary: document.getElementById('added-transactions-summary'),
                    addedTransactionsList: document.getElementById('added-transactions-list'),
                    saveAllBtn: document.getElementById('save-all-btn'),
                    historyGeneralContainer: document.getElementById('history-general-container'),
                    historyBancoContainer: document.getElementById('history-banco-container'),
                    searchGeneralInput: document.getElementById('search-general-input'),
                    searchBancoInput: document.getElementById('search-banco-input'),
                    startDateFilter: document.getElementById('start-date-filter'),
                    endDateFilter: document.getElementById('end-date-filter'),
                    downloadRangePdfBtn: document.getElementById('download-range-pdf-btn'),
                    searchRangeBtn: document.getElementById('search-range-btn'),
                    rangeResultsContainer: document.getElementById('range-results-container'),
                    // Edit Day View
                    editDayTitle: document.getElementById('edit-day-title'),
                    editDayList: document.getElementById('edit-day-list'),
                    // Balance View
                    balanceTitle: document.getElementById('balance-title'),
                    balanceDateRange: document.getElementById('balance-date-range'),
                    balanceStartDate: document.getElementById('balance-start-date'),
                    balanceEndDate: document.getElementById('balance-end-date'),
                    filterBalanceBtn: document.getElementById('filter-balance-btn'),
                    balanceDetailsContainer: document.getElementById('balance-details-container'),
                    downloadBalancePdfBtn: document.getElementById('download-balance-pdf-btn'),
                    downloadBalanceExcelBtn: document.getElementById('download-balance-excel-btn'),
                    // Aportes Spans
                    sueldo_camila: document.getElementById('sueldo_camila'),
                    sueldo_julio: document.getElementById('sueldo_julio'),
                    cargas_sociales: document.getElementById('cargas_sociales'),
                    asignacion_jorge: document.getElementById('asignacion_jorge'),
                    asignacion_adan: document.getElementById('asignacion_adan'),
                    mutual_jorge: document.getElementById('mutual_jorge'),
                    mutual_adan: document.getElementById('mutual_adan'),
                    aporte_seminaristas_jun25: document.getElementById('aporte_seminaristas_jun25'),
                    aporte_seminaristas_dividido: document.getElementById('aporte_seminaristas_dividido'),
                    aporte_seminaristas_jul25: document.getElementById('aporte_seminaristas_jul25'),
                    // Modals
                    saveConfirmModal: document.getElementById('save-confirm-modal'),
                    saveConfirmText: document.getElementById('save-confirm-text'),
                    saveConfirmOk: document.getElementById('save-confirm-ok'),
                    saveConfirmCancel: document.getElementById('save-confirm-cancel'),
                    confirmModal: document.getElementById('confirm-modal'),
                    confirmModalTitle: document.getElementById('confirm-modal-title'),
                    confirmModalText: document.getElementById('confirm-modal-text'),
                    confirmModalOk: document.getElementById('confirm-modal-ok'),
                    confirmModalCancel: document.getElementById('confirm-modal-cancel'),
                    // Edit Colecta Modal
                    editColectaModal: document.getElementById('edit-colecta-modal'),
                    editColectaForm: document.getElementById('edit-colecta-form'),
                    editColectaId: document.getElementById('edit-colecta-id'),
                    editColectaDescripcion: document.getElementById('edit-colecta-descripcion'),
                    editColectaMonto: document.getElementById('edit-colecta-monto'),
                    editColectaSaveBtn: document.getElementById('edit-colecta-save-btn'),
                    editColectaCancelBtn: document.getElementById('edit-colecta-cancel-btn'),
                    // Edit Transaction Modal
                    editTransactionModal: document.getElementById('edit-transaction-modal'),
                    editTransactionTitle: document.getElementById('edit-transaction-title'),
                    editTransactionForm: document.getElementById('edit-transaction-form'),
                    editTransactionId: document.getElementById('edit-transaction-id'),
                    editTransactionBlock: document.getElementById('edit-transaction-block'),
                    editTransactionCategoria: document.getElementById('edit-transaction-categoria'),
                    editTransactionDescripcion: document.getElementById('edit-transaction-descripcion'),
                    editTransactionMonto: document.getElementById('edit-transaction-monto'),
                    editTransactionSaveBtn: document.getElementById('edit-transaction-save-btn'),
                    editTransactionCancelBtn: document.getElementById('edit-transaction-cancel-btn'),
                };
            },

            // --- FIREBASE SETUP ---
            initFirebase() {
                this.toggleLoader(true);
                
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config)
                    : {
                        apiKey: "AIzaSyCCpr9FqklSBzkedKGQyNQrTLB30Y-AhJI",
                        authDomain: "gestionparroquial-2fabc.firebaseapp.com",
                        projectId: "gestionparroquial-2fabc",
                        storageBucket: "gestionparroquial-2fabc.appspot.com",
                        messagingSenderId: "710289559218",
                        appId: "1:710289559218:web:26bf19a750914deb3a83ab"
                      };

                try {
                    const app = initializeApp(firebaseConfig);
                    this.state.db = getFirestore(app);
                    this.state.auth = getAuth(app);
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    this.handleAuthentication(initialAuthToken);
                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    this.showToast("Error al conectar con la base de datos.", "error");
                    this.toggleLoader(false);
                }
            },

            handleAuthentication(token) {
                onAuthStateChanged(this.state.auth, async (user) => {
                    if (user) {
                        this.state.userId = user.uid;
                        console.log("User authenticated with UID:", this.state.userId);
                        await this.loadInitialData();
                    } else if (token) {
                        try {
                            await signInWithCustomToken(this.state.auth, token);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            this.showToast("Error de autenticaci√≥n.", "error");
                            this.toggleLoader(false);
                        }
                    } else {
                        try {
                            console.log("No user or token, attempting anonymous sign-in.");
                            await signInAnonymously(this.state.auth);
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                            this.showToast("Error de autenticaci√≥n an√≥nima. Verifique la configuraci√≥n de Firebase.", "error");
                            this.toggleLoader(false);
                        }
                    }
                });
            },
            
            async loadInitialData() {
                if (!this.state.userId) return;
                this.toggleLoader(true);
                try {
                    await Promise.all([
                        this.loadAllTransactions(),
                        this.checkAndSeedEnvioColectas(),
                        this.checkAndSeedAportesData()
                    ]);
                } catch(error) {
                    console.error("Error loading initial data:", error);
                    this.showToast("No se pudieron cargar los datos.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            // --- EVENT BINDING ---
            bindEvents() {
                // Main view actions using event delegation
                this.dom.mainView.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    
                    const { action, block, date, page } = button.dataset;

                    if (action === 'load-data') {
                        this.showDatePromptView(block);
                    } else if (action === 'delete-date') {
                        this.confirmDeleteDate(date, block);
                    } else if (action === 'edit-day') {
                        this.showEditDayView(date, block);
                    } else if (action === 'paginate') {
                        this.handlePagination(block, parseInt(page));
                    }
                });
                
                // Other buttons
                this.dom.enviosColectasBtn.addEventListener('click', () => this.showEnvioColectasView());
                this.dom.aportesBtn.addEventListener('click', () => this.showAportesView());
                this.dom.balanceBtn.addEventListener('click', () => this.showBalanceView());
                this.dom.backFromEnviosBtn.addEventListener('click', () => this.showMainView());
                this.dom.backFromAportesBtn.addEventListener('click', () => this.showMainView());
                this.dom.backFromBalanceBtn.addEventListener('click', () => this.showMainView());
                this.dom.backFromFormBtn.addEventListener('click', () => this.showMainView());
                this.dom.backFromDatePromptBtn.addEventListener('click', () => this.showMainView());
                this.dom.backFromEditDayBtn.addEventListener('click', () => this.showMainView());
                this.dom.downloadRangePdfBtn.addEventListener('click', () => this.downloadDateRangePDF());
                this.dom.searchRangeBtn.addEventListener('click', () => this.showDateRangeResults());
                this.dom.continueToFormBtn.addEventListener('click', () => this.handleDatePromptContinue());

                // Balance view buttons
                this.dom.filterBalanceBtn.addEventListener('click', () => this.generateAndDisplayBalance());
                this.dom.downloadBalancePdfBtn.addEventListener('click', () => this.downloadBalancePDF());
                this.dom.downloadBalanceExcelBtn.addEventListener('click', () => this.downloadBalanceExcel());

                // Form view buttons
                this.dom.addIngresoBtn.addEventListener('click', () => this.addTransactionToList('ingreso'));
                this.dom.addEgresoBtn.addEventListener('click', () => this.addTransactionToList('egreso'));
                this.dom.saveAllBtn.addEventListener('click', () => this.showSaveConfirmation());
                
                // Search inputs
                this.dom.searchGeneralInput.addEventListener('input', () => { this.state.generalCurrentPage = 1; this.renderHistory('general'); });
                this.dom.searchBancoInput.addEventListener('input', () => { this.state.bancoCurrentPage = 1; this.renderHistory('banco'); });

                // Modals
                this.dom.saveConfirmOk.addEventListener('click', () => this.commitTransactions());
                this.dom.saveConfirmCancel.addEventListener('click', () => this.dom.saveConfirmModal.classList.add('hidden'));
                this.dom.confirmModalOk.addEventListener('click', () => this.handleConfirm());
                this.dom.confirmModalCancel.addEventListener('click', () => this.dom.confirmModal.classList.add('hidden'));
                
                // Edit Colecta Modal Buttons
                this.dom.editColectaSaveBtn.addEventListener('click', () => this.handleUpdateColecta());
                this.dom.editColectaCancelBtn.addEventListener('click', () => this.dom.editColectaModal.classList.add('hidden'));

                // Edit Day View Delegation
                this.dom.editDayList.addEventListener('click', e => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const { action, id, block } = button.dataset;
                    if (action === 'edit-transaction') {
                        this.showEditTransactionModal(id, block);
                    } else if (action === 'delete-transaction') {
                        this.handleDeleteSingleTransaction(id, block);
                    }
                });

                // Edit Transaction Modal Buttons
                this.dom.editTransactionSaveBtn.addEventListener('click', () => this.handleUpdateTransaction());
                this.dom.editTransactionCancelBtn.addEventListener('click', () => this.dom.editTransactionModal.classList.add('hidden'));


                // Collections view event delegation
                this.dom.envioColectasList.addEventListener('click', e => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const { action, id } = button.dataset;
                    if (action === 'save-monto') {
                        this.saveEnvioMonto(id);
                    } else if (action === 'edit-colecta') {
                        this.showEditColectaModal(id);
                    }
                });

                // Aportes view event delegation
                this.dom.aportesContainer.addEventListener('click', e => {
                    const button = e.target.closest('button[data-key]');
                    if (!button) return;
                    const { key, label } = button.dataset;
                    this.handleEditAporte(key, label);
                });
            },

            // --- DATA HANDLING & FIRESTORE ---
            getCollectionRef(name) {
                if (!this.state.userId) {
                    console.error("User not authenticated, cannot get collection reference.");
                    return null;
                }
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // This path structure is required for the environment's security rules.
                const path = `artifacts/${appId}/users/${this.state.userId}/${name}`;
                return collection(this.state.db, path);
            },
            
            async checkAndSeedEnvioColectas() {
                const collRef = this.getCollectionRef("envio_colectas");
                if (!collRef) return;
                const snapshot = await getDocs(collRef);
                if (snapshot.empty) {
                    const initialData = [
                         { orden: 1, fecha: "4-5 ENERO", descripcion: "MISIONES DEL AFRICA", monto: 141400 },
                         { orden: 2, fecha: "11-12 ENERO", descripcion: "DIOCESIS", monto: 152500 },
                         { orden: 3, fecha: "1-2 FEBRERO", descripcion: "DIOCESIS", monto: 181720 },
                         { orden: 4, fecha: "1-2 MARZO", descripcion: "DIOCESIS", monto: 167300 },
                         { orden: 5, fecha: "5-6 ABRIL", descripcion: "DIOCESIS", monto: 195445 },
                         { orden: 6, fecha: "18 abril", descripcion: "TIERRA SANTA", monto: 118150 },
                         { orden: 7, fecha: "3-4 MAYO", descripcion: "DIOCESIS", monto: 160280 },
                         { orden: 8, fecha: "7-8 JUNIO", descripcion: "DIOCESIS", monto: null },
                         { orden: 9, fecha: "14-15 JUNIO", descripcion: "CARITAS", monto: null },
                         { orden: 10, fecha: "5-6 JULIO", descripcion: "OFRENDA UNIVERSAL", monto: 141865 },
                         { orden: 11, fecha: "12-13 JULIO", descripcion: "DIOCESIS", monto: 96070 },
                         { orden: 12, fecha: "2-3 AGOSTO", descripcion: "DIOCESIS", monto: null },
                         { orden: 13, fecha: "6-7 SEPTIEMBRE", descripcion: "MAS POR MENOS", monto: null },
                         { orden: 14, fecha: "13-14 SEPTIEMBRE", descripcion: "DIOCESIS", monto: null },
                         { orden: 15, fecha: "4-5 OCTUBRE", descripcion: "DIOCESIS", monto: null },
                         { orden: 16, fecha: "11-12 OCTUBRE", descripcion: "JORN. DE LAS MISIONES", monto: null },
                         { orden: 17, fecha: "1-2 NOVIEMBRE", descripcion: "DIOCESIS", monto: null },
                         { orden: 18, fecha: "6-7 DICIEMBRE", descripcion: "DIOCESIS", monto: null },
                         { orden: 19, fecha: "CONFIRMACION", descripcion: "CONFIRMACION", monto: null },
                         { orden: 20, fecha: "CAMPA√ëA TAE", descripcion: "CAMPA√ëA TAE", monto: null },
                    ];
                    const batch = writeBatch(this.state.db);
                    initialData.forEach(item => {
                        const docRef = doc(collRef);
                        batch.set(docRef, item);
                    });
                    await batch.commit();
                    this.showToast("Datos iniciales de colectas cargados.", "success");
                }
                await this.loadEnvioColectas();
            },

            async checkAndSeedAportesData() {
                const docRef = doc(this.getCollectionRef("configuracion_financiera"), "valores");
                if (!docRef) return;
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    const initialData = {
                        sueldo_camila: 480000,
                        sueldo_julio: 480000,
                        cargas_sociales: 568199.33,
                        asignacion_jorge: 156000,
                        asignacion_adan: 156000,
                        mutual_jorge: 127050,
                        mutual_adan: 127050,
                        aporte_seminaristas_jun25: 73750,
                        aporte_seminaristas_dividido: 295,
                        aporte_seminaristas_jul25: 295,
                    };
                    await setDoc(docRef, initialData);
                    this.showToast("Datos iniciales de aportes cargados.", "success");
                }
                await this.loadAportesData();
            },

            async loadAportesData() {
                const docRef = doc(this.getCollectionRef("configuracion_financiera"), "valores");
                if (!docRef) return;
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    for (const key in data) {
                        if (this.dom[key]) {
                            this.dom[key].textContent = this.formatCurrency(data[key]);
                        }
                    }
                } else {
                    console.log("No such document in configuracion_financiera!");
                }
            },

            async loadEnvioColectas() {
                const collRef = this.getCollectionRef("envio_colectas");
                if (!collRef) return;
                const snapshot = await getDocs(collRef);
                let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                data.sort((a, b) => a.orden - b.orden); // Sort by order
                this.state.envioColectas = data;
                this.renderEnvioColectas();
            },
            
            async loadAllTransactions() {
                const generalCollRef = this.getCollectionRef("gestion_general");
                const bancoCollRef = this.getCollectionRef("gestion_banco");
                if (!generalCollRef || !bancoCollRef) return;

                const [generalSnapshot, bancoSnapshot] = await Promise.all([getDocs(generalCollRef), getDocs(bancoCollRef)]);
                
                let generalData = generalSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                let bancoData = bancoSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Sort client-side
                this.state.generalTransactions = generalData.sort((a, b) => b.fecha.localeCompare(a.fecha));
                this.state.bancoTransactions = bancoData.sort((a, b) => b.fecha.localeCompare(a.fecha));
                
                this.renderHistory('general');
                this.renderHistory('banco');
            },
            
            async commitTransactions() {
                this.dom.saveConfirmModal.classList.add('hidden');
                if (this.state.currentTransactions.length === 0) {
                    this.showToast("No hay registros nuevos para guardar.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const batch = writeBatch(this.state.db);
                    for (const trans of this.state.currentTransactions) {
                        const collectionRef = this.getCollectionRef(trans.block === 'general' ? 'gestion_general' : 'gestion_banco');
                        if (!collectionRef) throw new Error("Collection reference is null");
                        const newDocRef = doc(collectionRef);
                        const data = { ...trans };
                        delete data.id; // Not needed as Firestore generates it
                        batch.set(newDocRef, data);
                    }
                    await batch.commit();
                    this.showToast("Operaci√≥n guardada con √©xito.", "success");
                    this.state.currentTransactions = [];
                    await this.loadAllTransactions();
                    this.showMainView();
                } catch (error) {
                    console.error("Error committing transactions:", error);
                    this.showToast("Error al guardar la operaci√≥n.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            
            async deleteDate(dateString, block) {
                this.toggleLoader(true);
                try {
                    const collectionRef = this.getCollectionRef(block === 'general' ? 'gestion_general' : 'gestion_banco');
                    if (!collectionRef) throw new Error("Collection reference is null");
                    const q = query(collectionRef, where("fecha", "==", dateString));
                    const snapshot = await getDocs(q);
                    
                    const batch = writeBatch(this.state.db);
                    snapshot.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();

                    this.showToast(`Registros del ${this.formatDate(dateString)} eliminados.`, "success");
                    await this.loadAllTransactions();
                } catch (error) {
                    console.error("Error deleting date records:", error);
                    this.showToast("Error al eliminar los registros.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            async saveEnvioMonto(id) {
                const input = document.getElementById(`monto-input-${id}`);
                const monto = parseFloat(input.value);
                if (isNaN(monto) || monto <= 0) {
                    this.showToast("Por favor, ingresa un monto v√°lido.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef("envio_colectas");
                    if (!collRef) throw new Error("Collection reference is null");
                    const docRef = doc(collRef, id);
                    await updateDoc(docRef, { monto: monto });
                    this.showToast("Monto guardado.", "success");
                    await this.loadEnvioColectas();
                } catch (error) {
                    console.error("Error saving monto:", error);
                    this.showToast("Error al guardar el monto.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            // --- UI RENDERING ---
            renderHistory(block) {
                const container = block === 'general' ? this.dom.historyGeneralContainer : this.dom.historyBancoContainer;
                let currentPage = block === 'general' ? this.state.generalCurrentPage : this.state.bancoCurrentPage;
                const transactions = block === 'general' ? this.state.generalTransactions : this.state.bancoTransactions;
                const searchInput = block === 'general' ? this.dom.searchGeneralInput : this.dom.searchBancoInput;
                
                container.innerHTML = '';
                const searchTerm = searchInput.value;
                
                const groupedByDate = transactions.reduce((acc, trans) => {
                    const date = this.formatDate(trans.fecha);
                    if (!acc[date]) acc[date] = { rawDate: trans.fecha, transactions: [] };
                    acc[date].transactions.push(trans);
                    return acc;
                }, {});

                const filteredDates = Object.keys(groupedByDate).filter(date => date.includes(searchTerm));

                const listContainer = document.createElement('div');
                listContainer.className = 'space-y-4';

                if (filteredDates.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500">No se encontraron registros.</p>';
                    container.appendChild(listContainer);
                    return;
                }

                const totalPages = Math.ceil(filteredDates.length / this.state.recordsPerPage);
                if (currentPage > totalPages) currentPage = totalPages;
                
                const startIndex = (currentPage - 1) * this.state.recordsPerPage;
                const endIndex = startIndex + this.state.recordsPerPage;
                const paginatedDates = filteredDates.slice(startIndex, endIndex);

                paginatedDates.forEach(date => {
                    const { rawDate, transactions: dailyTransactions } = groupedByDate[date];
                    let totalIngresos = 0;
                    let totalEgresos = 0;
                    dailyTransactions.forEach(t => {
                        if (t.type === 'ingreso') totalIngresos += t.monto;
                        else totalEgresos += t.monto;
                    });
                    
                    const dateGroup = document.createElement('div');
                    dateGroup.className = 'bg-gray-50 dark:bg-slate-700 p-4 rounded-lg';
                    dateGroup.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg">${date}</h3>
                            <div class="flex gap-2">
                                <button data-action="edit-day" data-date="${rawDate}" data-block="${block}" class="text-xs btn-gradient bg-gradient-to-r from-blue-500 to-blue-600 text-white px-2 py-1 rounded hover:from-blue-600 hover:to-blue-700">Modificar D√≠a</button>
                                <button data-action="delete-date" data-date="${rawDate}" data-block="${block}" class="text-xs btn-gradient bg-gradient-to-r from-red-600 to-red-700 text-white px-2 py-1 rounded hover:from-red-700 hover:to-red-800">Eliminar D√≠a</button>
                            </div>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-green-500">Ingresos: ${this.formatCurrency(totalIngresos)}</span>
                            <span class="text-red-500">Egresos: ${this.formatCurrency(totalEgresos)}</span>
                            <span class="font-semibold">Saldo: ${this.formatCurrency(totalIngresos - totalEgresos)}</span>
                        </div>
                    `;
                    listContainer.appendChild(dateGroup);
                });

                container.appendChild(listContainer);

                // Pagination controls
                if (totalPages > 1) {
                    const paginationContainer = document.createElement('div');
                    paginationContainer.className = 'flex justify-between items-center mt-4';
                    
                    const prevDisabled = currentPage === 1 ? 'disabled' : '';
                    const nextDisabled = currentPage === totalPages ? 'disabled' : '';

                    paginationContainer.innerHTML = `
                        <button data-action="paginate" data-block="${block}" data-page="${currentPage - 1}" ${prevDisabled} class="text-sm btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white px-3 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
                        <span class="text-sm font-semibold">P√°gina ${currentPage} de ${totalPages}</span>
                        <button data-action="paginate" data-block="${block}" data-page="${currentPage + 1}" ${nextDisabled} class="text-sm btn-gradient bg-gradient-to-r from-gray-500 to-gray-600 text-white px-3 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed">Siguiente</button>
                    `;
                    container.appendChild(paginationContainer);
                }
            },
            
            renderEnvioColectas() {
                this.dom.envioColectasList.innerHTML = '';
                let subtotal = 0;
                this.state.envioColectas.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-3 bg-gray-50 dark:bg-slate-700 rounded-lg grid grid-cols-4 gap-4 items-center';
                    
                    let montoHtml = '';
                    if (item.monto !== null) {
                        montoHtml = `<span class="font-semibold">${this.formatCurrency(item.monto)}</span>`;
                        subtotal += item.monto;
                    } else {
                        montoHtml = `
                            <div class="flex gap-2">
                                <input type="number" placeholder="Monto" class="w-full p-1 border border-gray-300 dark:border-slate-600 rounded bg-white dark:bg-slate-600" id="monto-input-${item.id}">
                                <button data-action="save-monto" data-id="${item.id}" class="text-xs btn-gradient bg-gradient-to-r from-green-500 to-green-600 text-white px-2 py-1 rounded">Guardar</button>
                            </div>
                        `;
                    }

                    itemDiv.innerHTML = `
                        <div class="font-semibold">${item.fecha}</div>
                        <div>${item.descripcion}</div>
                        <div class="text-right col-span-1">${montoHtml}</div>
                        <div class="text-right">
                            <button data-action="edit-colecta" data-id="${item.id}" class="text-xs btn-gradient bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-2 py-1 rounded">Editar</button>
                        </div>
                    `;
                    this.dom.envioColectasList.appendChild(itemDiv);
                });
                this.dom.envioSubtotal.textContent = this.formatCurrency(subtotal);
            },

            renderRangeTable(container, title, transactions) {
                let totalIngresos = 0;
                let totalEgresos = 0;
                transactions.forEach(t => {
                    if (t.type === 'ingreso') totalIngresos += t.monto;
                    else totalEgresos += t.monto;
                });

                const tableContainer = document.createElement('div');
                tableContainer.className = 'mb-8';

                let tableHTML = `
                    <h4 class="text-lg font-bold mb-2">${title}</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white dark:bg-slate-700 rounded-lg shadow">
                            <thead class="bg-gray-200 dark:bg-slate-600">
                                <tr>
                                    <th class="py-2 px-4 text-left">Fecha</th>
                                    <th class="py-2 px-4 text-left">Categor√≠a</th>
                                    <th class="py-2 px-4 text-left">Descripci√≥n</th>
                                    <th class="py-2 px-4 text-left">Tipo</th>
                                    <th class="py-2 px-4 text-right">Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                transactions.sort((a, b) => a.fecha.localeCompare(b.fecha)).forEach(t => {
                    tableHTML += `
                        <tr class="border-b border-gray-200 dark:border-slate-600">
                            <td class="py-2 px-4">${this.formatDate(t.fecha)}</td>
                            <td class="py-2 px-4">${t.categoria}</td>
                            <td class="py-2 px-4">${t.descripcion || '-'}</td>
                            <td class="py-2 px-4"><span class="${t.type === 'ingreso' ? 'text-green-500' : 'text-red-500'}">${t.type}</span></td>
                            <td class="py-2 px-4 text-right">${this.formatCurrency(t.monto)}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-gray-100 dark:bg-slate-600 rounded-lg flex justify-end gap-6 font-semibold">
                        <span>Ingresos: <span class="text-green-500">${this.formatCurrency(totalIngresos)}</span></span>
                        <span>Egresos: <span class="text-red-500">${this.formatCurrency(totalEgresos)}</span></span>
                        <span>Saldo: <span>${this.formatCurrency(totalIngresos - totalEgresos)}</span></span>
                    </div>
                `;
                
                tableContainer.innerHTML = tableHTML;
                container.appendChild(tableContainer);
            },

            // --- UI FLOW & VIEWS ---
            showDataEntryView(date) {
                const block = this.state.currentBlock;
                this.dom.datePromptView.classList.add('hidden');
                this.dom.dataEntryView.classList.remove('hidden');
                
                const title = block === 'general' ? 'Ingresos y Egresos Generales' : 'Banco';
                this.dom.dataEntryTitle.textContent = `Cargar Datos para: ${title}`;
                this.dom.sharedDate.value = date;
                this.state.currentTransactions = [];
                this.renderAddedTransactions();

                const categories = {
                    general: {
                        ingreso: ["COLECTAS IMPERADAS", "COLECTAS PARROQUIA", "DONACIONES", "BENEFICIOS", "ESTIPENDOS", "OTRO"],
                        egreso: ["DEUDA OBISPADO", "SUELDO CAMILA", "SUELDO JULIO", "CARGAS SOCIALES EMPLEADOS", "ASIGNACION P.ADAN", "ASIGNACION P.JORGE", "MUTUAL DE LOS SACERDOTES", "COMBUSTIBLE", "LITURGIA", "EMPLEADA DE LA CASA PARROQUIAL", "SEGUROS DE LOS AUTOS", "APORTE PARA SEMINARIO", "MANTEMIENTO VEHICULOS", "MANTENIMIENTO DE LA CASA", "COMESTIBLE CASA PARROQUIAL", "SERVICIOS DE INTERNET", "OTRO"]
                    },
                    banco: {
                        ingreso: ["DEPOSITO CAPILLA BONPLAND", "DEPOSITO DE COLECTAS", "OTRO"],
                        egreso: ["DEBITO AUTOMATICO", "EXTRACCION", "OTRO"]
                    }
                };

                this.dom.ingresoCategoria.innerHTML = categories[block].ingreso.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                this.dom.egresoCategoria.innerHTML = categories[block].egreso.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            },

            showMainView() {
                document.querySelectorAll('main, section').forEach(el => el.classList.add('hidden'));
                this.dom.mainView.classList.remove('hidden');
                this.state.currentTransactions = [];
                this.state.currentBlock = null;
            },
            
            showEnvioColectasView() {
                document.querySelectorAll('main, section').forEach(el => el.classList.add('hidden'));
                this.dom.envioColectasView.classList.remove('hidden');
            },

            showAportesView() {
                document.querySelectorAll('main, section').forEach(el => el.classList.add('hidden'));
                this.dom.aportesView.classList.remove('hidden');
            },

            showBalanceView() {
                document.querySelectorAll('main, section').forEach(el => el.classList.add('hidden'));
                this.dom.balanceView.classList.remove('hidden');
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                this.dom.balanceStartDate.value = firstDay;
                this.dom.balanceEndDate.value = lastDay;
                this.generateAndDisplayBalance();
            },

            showDatePromptView(block) {
                this.state.currentBlock = block;
                document.querySelectorAll('main, section').forEach(el => el.classList.add('hidden'));
                this.dom.datePromptView.classList.remove('hidden');
                const title = block === 'general' ? 'Ingresos y Egresos Generales' : 'Banco';
                this.dom.datePromptTitle.textContent = `Fecha para: ${title}`;
                this.dom.entryDateInput.valueAsDate = new Date();
            },
            
            showDateRangeResults() {
                const startDate = this.dom.startDateFilter.value;
                const endDate = this.dom.endDateFilter.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, selecciona un rango de fechas.", "error");
                    return;
                }

                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                
                this.dom.rangeResultsContainer.innerHTML = ''; // Clear previous results

                if (generalInRange.length === 0 && bancoInRange.length === 0) {
                    this.dom.rangeResultsContainer.innerHTML = '<p class="text-center text-gray-500">No se encontraron registros en el rango seleccionado.</p>';
                    this.dom.rangeResultsContainer.classList.remove('hidden');
                    return;
                }

                if (generalInRange.length > 0) {
                    this.renderRangeTable(this.dom.rangeResultsContainer, 'Resultados: Ingresos y Egresos Generales', generalInRange);
                }

                if (bancoInRange.length > 0) {
                    this.renderRangeTable(this.dom.rangeResultsContainer, 'Resultados: Movimientos de Banco', bancoInRange);
                }

                this.dom.rangeResultsContainer.classList.remove('hidden');
            },

            // --- FORM & MODAL LOGIC ---
            addTransactionToList(type) {
                const form = type === 'ingreso' ? this.dom.ingresoForm : this.dom.egresoForm;
                const categoria = document.getElementById(`${type}-categoria`).value;
                const descripcion = document.getElementById(`${type}-descripcion`).value;
                const monto = parseFloat(document.getElementById(`${type}-monto`).value);
                const fecha = this.dom.sharedDate.value;

                if (!fecha || !categoria || isNaN(monto) || monto <= 0) {
                    this.showToast("Por favor, complete la fecha, categor√≠a y un monto v√°lido.", "error");
                    return;
                }

                const transaction = {
                    id: Date.now(), // Temporary ID for list management
                    type: type,
                    block: this.state.currentBlock,
                    fecha: fecha,
                    categoria: categoria,
                    descripcion: descripcion,
                    monto: monto,
                };

                this.state.currentTransactions.push(transaction);
                this.renderAddedTransactions();
                form.reset();
                this.showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} a√±adido a la lista.`, "success");
            },

            renderAddedTransactions() {
                const list = this.dom.addedTransactionsList;
                list.innerHTML = '';
                if (this.state.currentTransactions.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-500">A√∫n no hay registros para guardar.</p>';
                    return;
                }
                this.state.currentTransactions.forEach(t => {
                    const item = document.createElement('div');
                    item.className = `flex justify-between items-center p-2 rounded-lg ${t.type === 'ingreso' ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900'}`;
                    item.innerHTML = `
                        <div>
                            <span class="font-bold">${t.categoria}</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">${t.descripcion ? ' - ' + t.descripcion : ''}</span>
                        </div>
                        <span class="font-semibold">${this.formatCurrency(t.monto)}</span>
                    `;
                    list.appendChild(item);
                });
            },

            showSaveConfirmation() {
                if (this.state.currentTransactions.length === 0) {
                    this.showToast("No hay registros nuevos para guardar.", "error");
                    return;
                }
                const ingresosCount = this.state.currentTransactions.filter(t => t.type === 'ingreso').length;
                const egresosCount = this.state.currentTransactions.filter(t => t.type === 'egreso').length;
                this.dom.saveConfirmText.textContent = `Se guardar√°n ${ingresosCount} ingreso(s) y ${egresosCount} egreso(s). ¬øDesea continuar?`;
                this.dom.saveConfirmModal.classList.remove('hidden');
            },
            
            handleDatePromptContinue() {
                const selectedDate = this.dom.entryDateInput.value;
                if (!selectedDate) {
                    this.showToast('Por favor, selecciona una fecha.', 'error');
                    return;
                }
                this.showDataEntryView(selectedDate);
            },
            
            confirmDeleteDate(dateString, block) {
                this.state.pendingAction = { type: 'delete-date', data: { dateString, block } };
                this.dom.confirmModalTitle.textContent = "Confirmar Eliminaci√≥n";
                this.dom.confirmModalText.textContent = `¬øEst√°s seguro de que quieres eliminar todos los registros del d√≠a ${this.formatDate(dateString)} para ${block}? Esta acci√≥n no se puede deshacer.`;
                this.dom.confirmModal.classList.remove('hidden');
            },
            
            handleConfirm() {
                if (this.state.pendingAction && this.state.pendingAction.type === 'delete-date') {
                    const { dateString, block } = this.state.pendingAction.data;
                    this.deleteDate(dateString, block);
                }
                this.dom.confirmModal.classList.add('hidden');
                this.state.pendingAction = null;
            },

            showEditColectaModal(id) {
                const item = this.state.envioColectas.find(i => i.id === id);
                if (!item) {
                    this.showToast("No se encontr√≥ el registro.", "error");
                    return;
                }

                this.dom.editColectaId.value = item.id;
                this.dom.editColectaDescripcion.value = item.descripcion;
                this.dom.editColectaMonto.value = item.monto !== null ? item.monto : ''; 
                
                this.dom.editColectaModal.classList.remove('hidden');
            },

            async handleUpdateColecta() {
                const id = this.dom.editColectaId.value;
                const descripcion = this.dom.editColectaDescripcion.value.trim();
                const montoInput = this.dom.editColectaMonto.value;

                if (!id || !descripcion) {
                    this.showToast("La descripci√≥n no puede estar vac√≠a.", "error");
                    return;
                }

                const monto = montoInput === '' ? null : parseFloat(montoInput);
                if (montoInput !== '' && isNaN(monto)) {
                    this.showToast("El monto ingresado no es v√°lido.", "error");
                    return;
                }

                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef("envio_colectas");
                    if (!collRef) throw new Error("Collection reference is null");
                    const docRef = doc(collRef, id);
                    await updateDoc(docRef, { 
                        descripcion: descripcion,
                        monto: monto 
                    });
                    this.dom.editColectaModal.classList.add('hidden');
                    this.showToast("Registro actualizado con √©xito.", "success");
                    await this.loadEnvioColectas();
                } catch (error) {
                    console.error("Error updating colecta:", error);
                    this.showToast("Error al actualizar el registro.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            async handleEditAporte(key, label) {
                const currentValueText = this.dom[key].textContent;
                const currentValue = parseFloat(currentValueText.replace(/[^0-9,-]+/g,"").replace(",", "."));

                const newValueText = prompt(`Modificar ${label}:`, currentValue);
                
                if (newValueText === null) return;

                const newValue = parseFloat(newValueText);
                if (isNaN(newValue)) {
                    this.showToast("Por favor, ingresa un n√∫mero v√°lido.", "error");
                    return;
                }

                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("configuracion_financiera"), "valores");
                    await updateDoc(docRef, { [key]: newValue });
                    this.showToast(`${label} actualizado.`, "success");
                    await this.loadAportesData();
                } catch (error) {
                    console.error("Error updating aporte:", error);
                    this.showToast("Error al actualizar el valor.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            // --- BALANCE LOGIC ---
            generateAndDisplayBalance() {
                const startDate = this.dom.balanceStartDate.value;
                const endDate = this.dom.balanceEndDate.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, selecciona un rango de fechas para el balance.", "error");
                    return;
                }
                this.dom.balanceDateRange.textContent = `del ${this.formatDate(startDate)} al ${this.formatDate(endDate)}`;

                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                
                this.dom.balanceDetailsContainer.innerHTML = ''; // Clear previous balance

                if (generalInRange.length === 0 && bancoInRange.length === 0) {
                    this.dom.balanceDetailsContainer.innerHTML = '<p class="text-center text-gray-500">No se encontraron registros para el balance en el rango seleccionado.</p>';
                    return;
                }

                const balanceData = {
                    general: { ingresos: 0, egresos: 0, transacciones: generalInRange },
                    banco: { ingresos: 0, egresos: 0, transacciones: bancoInRange },
                };

                generalInRange.forEach(t => {
                    if (t.type === 'ingreso') balanceData.general.ingresos += t.monto;
                    else balanceData.general.egresos += t.monto;
                });

                bancoInRange.forEach(t => {
                    if (t.type === 'ingreso') balanceData.banco.ingresos += t.monto;
                    else balanceData.banco.egresos += t.monto;
                });
                
                const totalIngresos = balanceData.general.ingresos + balanceData.banco.ingresos;
                const totalEgresos = balanceData.general.egresos + balanceData.banco.egresos;
                const saldoFinal = totalIngresos - totalEgresos;

                let html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            ${this.renderBalanceTable('Ingresos y Egresos Generales', balanceData.general.transacciones, balanceData.general.ingresos, balanceData.general.egresos)}
                        </div>
                        <div>
                            ${this.renderBalanceTable('Movimientos de Banco', balanceData.banco.transacciones, balanceData.banco.ingresos, balanceData.banco.egresos)}
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t-2 border-gray-300 dark:border-slate-600 text-right font-bold text-xl">
                        <p class="mb-2">Total Ingresos: <span class="text-green-500">${this.formatCurrency(totalIngresos)}</span></p>
                        <p class="mb-2">Total Egresos: <span class="text-red-500">${this.formatCurrency(totalEgresos)}</span></p>
                        <p class="text-2xl">Saldo Final: <span class="${saldoFinal >= 0 ? 'text-green-600' : 'text-red-600'}">${this.formatCurrency(saldoFinal)}</span></p>
                    </div>
                `;

                this.dom.balanceDetailsContainer.innerHTML = html;
            },

            renderBalanceTable(title, transactions, totalIngresos, totalEgresos) {
                let rowsHtml = transactions.length > 0 ? transactions.map(t => `
                    <tr class="border-b border-gray-200 dark:border-slate-700">
                        <td class="py-2 px-3">${this.formatDate(t.fecha)}</td>
                        <td class="py-2 px-3">${t.categoria}</td>
                        <td class="py-2 px-3">${t.type === 'ingreso' ? this.formatCurrency(t.monto) : '-'}</td>
                        <td class="py-2 px-3">${t.type === 'egreso' ? this.formatCurrency(t.monto) : '-'}</td>
                    </tr>
                `).join('') : '<tr><td colspan="4" class="text-center py-4">No hay movimientos</td></tr>';

                return `
                    <h3 class="text-xl font-semibold mb-3">${title}</h3>
                    <div class="overflow-auto max-h-96 rounded-lg shadow">
                        <table class="min-w-full bg-white dark:bg-slate-700">
                            <thead class="bg-gray-200 dark:bg-slate-600 sticky top-0">
                                <tr>
                                    <th class="py-2 px-3 text-left">Fecha</th>
                                    <th class="py-2 px-3 text-left">Categor√≠a</th>
                                    <th class="py-2 px-3 text-left">Ingreso</th>
                                    <th class="py-2 px-3 text-left">Egreso</th>
                                </tr>
                            </thead>
                            <tbody>${rowsHtml}</tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-3 bg-gray-100 dark:bg-slate-600 rounded-lg flex justify-between font-semibold">
                        <span>Subtotal Ingresos: <span class="text-green-500">${this.formatCurrency(totalIngresos)}</span></span>
                        <span>Subtotal Egresos: <span class="text-red-500">${this.formatCurrency(totalEgresos)}</span></span>
                    </div>
                `;
            },

            downloadBalancePDF() {
                const startDate = this.dom.balanceStartDate.value;
                const endDate = this.dom.balanceEndDate.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, filtra un rango de fechas primero.", "error");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.text(`Balance de la Parroquia San Jos√©`, 14, 20);
                doc.setFontSize(12);
                doc.text(`Periodo: ${this.formatDate(startDate)} al ${this.formatDate(endDate)}`, 14, 28);

                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);

                let finalY = 40;
                let totalIngresos = 0;
                let totalEgresos = 0;

                if (generalInRange.length > 0) {
                    doc.setFontSize(14);
                    doc.text("Ingresos y Egresos Generales", 14, finalY);
                    const body = generalInRange.map(t => {
                        if (t.type === 'ingreso') totalIngresos += t.monto;
                        else totalEgresos += t.monto;
                        return [this.formatDate(t.fecha), t.categoria, t.type, this.formatCurrency(t.monto)];
                    });
                    doc.autoTable({ startY: finalY + 5, head: [['Fecha', 'Categor√≠a', 'Tipo', 'Monto']], body });
                    finalY = doc.autoTable.previous.finalY;
                }

                if (bancoInRange.length > 0) {
                    finalY += 15;
                    doc.setFontSize(14);
                    doc.text("Movimientos de Banco", 14, finalY);
                    const body = bancoInRange.map(t => {
                        if (t.type === 'ingreso') totalIngresos += t.monto;
                        else totalEgresos += t.monto;
                        return [this.formatDate(t.fecha), t.categoria, t.type, this.formatCurrency(t.monto)];
                    });
                    doc.autoTable({ startY: finalY + 5, head: [['Fecha', 'Categor√≠a', 'Tipo', 'Monto']], body });
                    finalY = doc.autoTable.previous.finalY;
                }

                finalY += 15;
                doc.setFontSize(12);
                doc.text(`Total Ingresos: ${this.formatCurrency(totalIngresos)}`, 14, finalY);
                doc.text(`Total Egresos: ${this.formatCurrency(totalEgresos)}`, 14, finalY + 7);
                doc.setFontSize(14);
                doc.text(`Saldo Final: ${this.formatCurrency(totalIngresos - totalEgresos)}`, 14, finalY + 14);

                doc.save(`Balance_Parroquial_${startDate}_a_${endDate}.pdf`);
            },

            downloadBalanceExcel() {
                const startDate = this.dom.balanceStartDate.value;
                const endDate = this.dom.balanceEndDate.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, filtra un rango de fechas primero.", "error");
                    return;
                }

                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Tipo de Registro,Fecha,Categoria,Descripcion,Ingreso,Egreso\r\n";

                let totalIngresos = 0;
                let totalEgresos = 0;

                const processTransactions = (label, transactions) => {
                    transactions.forEach(t => {
                        const ingreso = t.type === 'ingreso' ? t.monto : 0;
                        const egreso = t.type === 'egreso' ? t.monto : 0;
                        totalIngresos += ingreso;
                        totalEgresos += egreso;
                        const row = [label, t.fecha, t.categoria, `"${t.descripcion || ''}"`, ingreso, egreso].join(",");
                        csvContent += row + "\r\n";
                    });
                };
                
                processTransactions("General", generalInRange);
                processTransactions("Banco", bancoInRange);
                
                csvContent += "\r\n";
                csvContent += `,,,Total Ingresos,${totalIngresos}\r\n`;
                csvContent += `,,,Total Egresos,${totalEgresos}\r\n`;
                csvContent += `,,,Saldo Final,${totalIngresos - totalEgresos}\r\n`;

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `Balance_Parroquial_${startDate}_a_${endDate}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            // --- UTILITIES ---
            toggleLoader(show) {
                this.dom.loader.classList.toggle('hidden', !show);
            },

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                this.dom.toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            },

            downloadDateRangePDF() {
                const startDate = this.dom.startDateFilter.value;
                const endDate = this.dom.endDateFilter.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, selecciona un rango de fechas.", "error");
                    return;
                }

                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);

                if (generalInRange.length === 0 && bancoInRange.length === 0) {
                    this.showToast("No hay datos para el rango seleccionado.", "error");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.text(`Reporte Parroquial del ${this.formatDate(startDate)} al ${this.formatDate(endDate)}`, 14, 20);

                let finalY = 30;

                if(generalInRange.length > 0) {
                    doc.text("Ingresos y Egresos Generales", 14, finalY);
                    const generalBody = generalInRange.map(t => [this.formatDate(t.fecha), t.categoria, t.descripcion, t.type, this.formatCurrency(t.monto)]);
                    doc.autoTable({
                        startY: finalY + 5,
                        head: [['Fecha', 'Categor√≠a', 'Descripci√≥n', 'Tipo', 'Monto']],
                        body: generalBody,
                    });
                    finalY = doc.autoTable.previous.finalY;
                }

                if(bancoInRange.length > 0) {
                    doc.text("Movimientos de Banco", 14, finalY + 15);
                     const bancoBody = bancoInRange.map(t => [this.formatDate(t.fecha), t.categoria, t.descripcion, t.type, this.formatCurrency(t.monto)]);
                    doc.autoTable({
                        startY: finalY + 20,
                        head: [['Fecha', 'Categor√≠a', 'Descripci√≥n', 'Tipo', 'Monto']],
                        body: bancoBody,
                    });
                }
                
                doc.save(`reporte_${startDate}_${endDate}.pdf`);
            },

            formatCurrency(amount) {
                if (typeof amount !== 'number') return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(0);
                return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(amount);
            },

            formatDate(dateString) {
                // Handles YYYY-MM-DD format
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            },
        };

        // Start the application
        App.init();

    </script>
</body>
</html>
