<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Parroquial - San José</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }

        /* --- View Transitions --- */
        .view-container {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            will-change: opacity, transform;
        }
        .view-container:not(.visible) {
            opacity: 0;
            transform: translateY(15px);
            pointer-events: none;
        }
        .view-container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- Toast Notification Styles --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            margin-bottom: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards;
        }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }

        /* --- Loading Spinner & Skeletons --- */
        #loader {
            background: rgba(255, 255, 255, 0.7);
        }
        .skeleton-loader {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }

        /* --- Unified Modal Styling --- */
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-backdrop.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-backdrop.hidden .modal-content {
            transform: translateY(-20px) scale(0.95);
        }

        /* --- Notification Bell --- */
        #notification-bell-container { position: relative; }
        #notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            background-color: #ef4444; /* red-500 */
            border-radius: 9999px;
            border: 2px solid white;
        }
        #reminders-panel {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* --- Highlight Animation for new items --- */
        @keyframes highlight-green {
            from { background-color: #6ee7b7; }
            to { background-color: transparent; }
        }
        @keyframes highlight-red {
            from { background-color: #fca5a5; }
            to { background-color: transparent; }
        }
        .new-ingreso { animation: highlight-green 1.5s ease-out; }
        .new-egreso { animation: highlight-red 1.5s ease-out; }
        
        /* --- Colectas Calculator View Scrolling --- */
        #colectas-calculator-view {
            overflow-y: auto;
        }
        
        /* --- Notification Ticker --- */
        #notification-ticker {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-slate-800">

    <!-- LOADING OVERLAY -->
    <div id="loader" class="fixed inset-0 z-[1100] flex items-center justify-center hidden">
        <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-blue-500"></div>
    </div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container"></div>

    <!-- LOGIN VIEW -->
    <section id="login-view" class="hidden flex items-center justify-center h-screen">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl">
            <h2 class="text-3xl font-bold mb-2 text-center">Gestión Parroquial</h2>
            <p class="text-center text-slate-500 mb-6">Inicia sesión para continuar</p>
            <div class="space-y-4">
                <div>
                    <input type="email" id="email-input" placeholder="Correo Electrónico" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-center">
                </div>
                <div>
                    <input type="password" id="password-input" placeholder="Contraseña" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-center">
                </div>
            </div>
            <div id="auth-error-container" class="text-red-500 text-sm mt-4 text-center h-5"></div>
            <div class="mt-4 flex justify-center">
                <button id="login-btn" class="w-full sm:w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-all duration-300 transform active:scale-95">Ingresar</button>
            </div>
        </div>
    </section>

    <div id="app-container" class="hidden">
        <!-- NAVIGATION MENU -->
        <nav class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold">Gestión Parroquial</h1>
                <div class="flex items-center gap-4">
                    <!-- NEW: Notification Ticker -->
                    <div id="notification-ticker-container" class="relative h-8 w-64 overflow-hidden rounded-full bg-slate-100 hidden">
                        <div id="notification-ticker" class="absolute inset-0 flex items-center px-4 text-sm text-slate-600 whitespace-nowrap">
                            <!-- Ticker items will be injected here -->
                        </div>
                    </div>
                    <div id="notification-bell-container">
                        <button id="notification-bell-btn" class="text-slate-600 hover:text-blue-500 focus:outline-none p-2 rounded-full hover:bg-slate-100 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            <div id="notification-badge" class="hidden"></div>
                        </button>
                        <div id="reminders-panel" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl p-4 origin-top-right">
                            <h4 class="font-bold text-md mb-2">Alertas Pendientes</h4>
                            <ul id="reminders-list" class="space-y-3 text-sm max-h-64 overflow-y-auto">
                                <!-- Reminders will be injected here -->
                            </ul>
                        </div>
                    </div>
                    <a href="#" id="back-to-panel-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">Volver al Panel</a>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all">Cerrar Sesión</button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-6">

            <!-- MAIN VIEW -->
            <main id="main-view" class="view-container">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- General Income and Expenses Block -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col">
                        <div class="flex items-center mb-4">
                            <div class="bg-blue-100 p-3 rounded-lg mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold">Caja General</h2>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="search-general-input" placeholder="Buscar por fecha (dd/mm/aaaa)..." class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        </div>
                        <div id="history-general-container" class="space-y-4 min-h-[24rem] flex-grow flex flex-col justify-between"></div>
                         <div class="mt-auto pt-4">
                            <button data-action="load-data" data-block="general" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl shadow-lg transition-all transform active:scale-95">
                                + Cargar Nuevo Día
                            </button>
                        </div>
                    </div>

                    <!-- Bank Block -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col">
                        <div class="flex items-center mb-4">
                            <div class="bg-green-100 p-3 rounded-lg mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold">Banco</h2>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="search-banco-input" placeholder="Buscar por fecha (dd/mm/aaaa)..." class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-green-500 focus:border-transparent transition">
                        </div>
                        <div id="history-banco-container" class="space-y-4 min-h-[24rem] flex-grow flex flex-col justify-between"></div>
                         <div class="mt-auto pt-4">
                            <button data-action="load-data" data-block="banco" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-xl shadow-lg transition-all transform active:scale-95">
                                + Cargar Movimiento
                            </button>
                        </div>
                    </div>

                    <!-- Information Block -->
                     <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col">
                        <div class="flex items-center mb-4">
                            <div class="bg-indigo-100 p-3 rounded-lg mr-4">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold">Información</h2>
                        </div>
                        <div class="flex flex-col gap-4 mb-6 flex-grow justify-center">
                            <button id="colectas-calculator-btn" class="bg-white hover:bg-slate-50 p-4 rounded-xl shadow-md text-left transition-all flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-lime-500" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 00-1 1v1a1 1 0 001 1h6a1 1 0 001-1V5a1 1 0 00-1-1H7zM6 9a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                                </svg>
                                Calculadora de Colectas
                            </button>
                            <button id="colectas-online-btn" class="bg-white hover:bg-slate-50 p-4 rounded-xl shadow-md text-left transition-all flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-cyan-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                </svg>
                                Colectas
                            </button>
                            <button id="envios-colectas-btn" class="bg-white hover:bg-slate-50 p-4 rounded-xl shadow-md text-left transition-all flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-indigo-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                                Fecha de Envíos de Colectas
                            </button>
                            <button id="aportes-btn" class="bg-white hover:bg-slate-50 p-4 rounded-xl shadow-md text-left transition-all flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-teal-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                Sueldos y Aportes
                            </button>
                            <button id="manage-categories-btn" class="bg-white hover:bg-slate-50 p-4 rounded-xl shadow-md text-left transition-all flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                                Gestionar Categorías
                            </button>
                            <button id="manage-reminders-btn" class="bg-white hover:bg-slate-50 p-4 rounded-xl shadow-md text-left transition-all flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-amber-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                                Gestionar Alertas
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4">Balances y Reportes</h3>
                    <button id="balance-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition-all transform active:scale-95">Ver Balances</button>
                </div>

                <div class="mt-8 bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4">Reporte Detallado por Rango</h3>
                    <div class="flex flex-col md:flex-row gap-4 items-center">
                        <input type="date" id="start-date-filter" class="flex-1 p-2 border border-gray-300 rounded-lg bg-gray-50">
                        <input type="date" id="end-date-filter" class="flex-1 p-2 border border-gray-300 rounded-lg bg-gray-50">
                        <button id="search-range-btn" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-xl shadow-lg transition-all">Buscar</button>
                        <button id="download-range-pdf-btn" class="w-full md:w-auto bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-xl shadow-lg transition-all">Descargar PDF</button>
                    </div>
                    <div id="range-results-container" class="mt-6 hidden">
                        <!-- Results will be injected here -->
                    </div>
                </div>
            </main>

            <!-- DATE PROMPT VIEW -->
            <section id="date-prompt-view" class="view-container hidden max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                <h2 id="date-prompt-title" class="text-3xl font-bold mb-6 text-center"></h2>
                <div class="mb-6">
                    <label for="entry-date-input" class="block text-sm font-medium text-center">Confirme la fecha de carga</label>
                    <input type="date" id="entry-date-input" required class="mt-1 mx-auto block w-full max-w-xs p-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                <div class="flex flex-col gap-4">
                    <button id="continue-to-form-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl shadow-lg transition-all">Continuar</button>
                    <button id="back-from-date-prompt-btn" class="w-full bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 rounded-xl shadow-lg transition-all">Volver</button>
                </div>
            </section>

            <!-- DATA ENTRY VIEW -->
            <section id="data-entry-view" class="view-container hidden max-w-7xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                <h2 id="data-entry-title" class="text-3xl font-bold mb-4 text-center"></h2>
                <div class="mb-6">
                    <label for="shared-date" class="block text-sm font-medium text-center">Fecha de Operaciones</label>
                    <input type="date" id="shared-date" required class="mt-1 mx-auto block w-full max-w-xs p-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Ingreso Form -->
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h3 class="text-2xl font-bold mb-4 text-green-500">Registrar Ingreso</h3>
                        <form id="ingreso-form" class="space-y-4">
                            <div>
                                <label for="ingreso-categoria" class="block text-sm font-medium">Categoría</label>
                                <select id="ingreso-categoria" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white"></select>
                            </div>
                            <div>
                                <label for="ingreso-descripcion" class="block text-sm font-medium">Descripción</label>
                                <textarea id="ingreso-descripcion" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white"></textarea>
                            </div>
                            <div>
                                <label for="ingreso-monto" class="block text-sm font-medium">Monto</label>
                                <input type="text" inputmode="numeric" id="ingreso-monto" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                            </div>
                            <button type="button" id="add-ingreso-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-xl shadow-lg transition-all">Cargar Otro</button>
                        </form>
                    </div>
                    <!-- Egreso Form -->
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h3 class="text-2xl font-bold mb-4 text-red-500">Registrar Egreso</h3>
                        <form id="egreso-form" class="space-y-4">
                            <div>
                                <label for="egreso-categoria" class="block text-sm font-medium">Categoría</label>
                                <select id="egreso-categoria" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white"></select>
                            </div>
                            <div>
                                <label for="egreso-descripcion" class="block text-sm font-medium">Descripción</label>
                                <textarea id="egreso-descripcion" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white"></textarea>
                            </div>
                            <div>
                                <label for="egreso-monto" class="block text-sm font-medium">Monto</label>
                                <input type="text" inputmode="numeric" id="egreso-monto" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                            </div>
                            <button type="button" id="add-egreso-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-xl shadow-lg transition-all">Cargar Otro</button>
                        </form>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-2">Registros a Guardar</h3>
                    <div id="added-transactions-list" class="space-y-2 max-h-48 overflow-y-auto bg-gray-100 p-4 rounded-lg"></div>
                </div>

                <div class="mt-8 flex flex-col md:flex-row gap-4 justify-end">
                    <button id="back-from-form-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all">Volver</button>
                    <button id="save-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all">Guardar los Datos</button>
                </div>
            </section>

            <!-- EDIT DAY VIEW -->
            <section id="edit-day-view" class="view-container hidden max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                <h2 id="edit-day-title" class="text-3xl font-bold mb-6 text-center"></h2>
                <div id="edit-day-list" class="space-y-3"></div>
                <button id="back-from-edit-day-btn" class="mt-8 w-full bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 rounded-xl shadow-lg transition-all">Volver</button>
            </section>
            
            <!-- COLLECTIONS VIEW -->
            <section id="envio-colectas-view" class="view-container hidden max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">Fechas de Envío de Colectas</h2>
                <div id="envio-colectas-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
                <div class="mt-6 pt-4 border-t border-gray-300">
                    <p class="text-xl font-bold text-right">Subtotal Enviado: <span id="envio-subtotal" class="text-green-500"></span></p>
                </div>
                <button id="back-from-envios-btn" class="mt-6 w-full bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 rounded-xl shadow-lg transition-all">Volver</button>
            </section>

            <!-- APORTES VIEW -->
            <section id="aportes-view" class="view-container hidden max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">Sueldos y Aportes</h2>
                <div id="aportes-container" class="space-y-6">
                    <!-- Content injected by JS -->
                </div>
                <button id="back-from-aportes-btn" class="mt-8 w-full bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 rounded-xl shadow-lg transition-all">Volver</button>
            </section>

            <!-- CATEGORY MANAGEMENT VIEW -->
            <section id="category-management-view" class="view-container hidden max-w-7xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-8 text-center">Gestión de Categorías</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                    <!-- General Categories -->
                    <div class="space-y-8">
                        <h3 class="text-2xl font-bold text-center border-b-2 border-blue-500 pb-2">Generales</h3>
                        <div id="category-general-ingreso-container"></div>
                        <div id="category-general-egreso-container"></div>
                    </div>
                    <!-- Bank Categories -->
                    <div class="space-y-8">
                        <h3 class="text-2xl font-bold text-center border-b-2 border-green-500 pb-2">Banco</h3>
                        <div id="category-banco-ingreso-container"></div>
                        <div id="category-banco-egreso-container"></div>
                    </div>
                </div>
                <button id="back-from-categories-btn" class="mt-12 w-full max-w-xs mx-auto block bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 rounded-xl shadow-lg transition-all">Volver</button>
            </section>

            <!-- REMINDERS MANAGEMENT VIEW -->
            <section id="reminders-management-view" class="view-container hidden max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">Gestión de Alertas</h2>
                <div class="bg-gray-50 p-6 rounded-xl mb-8">
                    <h3 class="text-xl font-bold mb-4">Nueva Alerta</h3>
                    <form id="new-reminder-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                        <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="reminder-title" class="block text-sm font-medium">Título</label>
                                <input type="text" id="reminder-title" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                            </div>
                            <div>
                                <label for="reminder-date" class="block text-sm font-medium">Fecha</label>
                                <input type="date" id="reminder-date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                            </div>
                        </div>
                        <div class="md:col-span-2">
                             <label for="reminder-description" class="block text-sm font-medium">Descripción</label>
                             <textarea id="reminder-description" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-xl shadow-lg transition-all">Guardar Alerta</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Alertas Programadas</h3>
                    <div id="reminders-list-container" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Reminder list will be injected here -->
                    </div>
                </div>
                <button id="back-from-reminders-btn" class="mt-8 w-full bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 rounded-xl shadow-lg transition-all">Volver</button>
            </section>

            <!-- BALANCE VIEW -->
            <section id="balance-view" class="view-container hidden max-w-7xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                <h2 id="balance-title" class="text-3xl font-bold mb-2 text-center">Balances de la Parroquia San José</h2>
                <p id="balance-date-range" class="text-center text-gray-500 mb-6"></p>
                
                <div class="bg-gray-50 p-4 rounded-lg mb-8">
                    <div class="flex flex-col md:flex-row gap-4 items-center">
                        <label for="balance-start-date" class="font-semibold">Desde:</label>
                        <input type="date" id="balance-start-date" class="flex-1 p-2 border border-gray-300 rounded-lg bg-white">
                        <label for="balance-end-date" class="font-semibold">Hasta:</label>
                        <input type="date" id="balance-end-date" class="flex-1 p-2 border border-gray-300 rounded-lg bg-white">
                        <button id="filter-balance-btn" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-xl shadow-lg transition-all">Filtrar</button>
                        <button id="back-from-balance-filter-btn" class="hidden w-full md:w-auto bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-xl shadow-lg transition-all">Volver al Panel</button>
                    </div>
                </div>

                <!-- Summarized General Balance -->
                <div class="mb-12">
                    <h3 class="text-2xl font-bold mb-4 text-center border-b-2 pb-2 border-indigo-500">Balance General Resumido</h3>
                    <p class="text-center text-sm text-gray-500 mb-4">(Solo Ingresos y Egresos Generales)</p>
                    <!-- NEW: Chart Container -->
                    <div class="max-w-md mx-auto my-6 h-64">
                         <canvas id="summary-chart"></canvas>
                    </div>
                    <div id="summary-balance-container">
                        <!-- Summarized balance will be injected here -->
                    </div>
                    <div class="mt-4 flex justify-center gap-4">
                        <button id="download-summary-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-xl shadow-lg transition-all">Descargar PDF Resumido</button>
                        <button id="download-summary-excel-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-xl shadow-lg transition-all">Descargar Excel Resumido</button>
                    </div>
                </div>

                <!-- Detailed Complete Balance -->
                <div>
                    <h3 class="text-2xl font-bold mb-4 text-center border-b-2 pb-2 border-purple-500">Balance Completo Detallado</h3>
                    <p class="text-center text-sm text-gray-500 mb-4">(Incluye Generales y Banco)</p>
                    <div id="balance-details-container" class="space-y-8">
                        <!-- Detailed balance will be injected here -->
                    </div>
                    <div class="mt-4 flex justify-center gap-4">
                        <button id="download-detailed-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-xl shadow-lg transition-all">Descargar PDF Detallado</button>
                        <button id="download-detailed-excel-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-xl shadow-lg transition-all">Descargar Excel Detallado</button>
                    </div>
                </div>


                <div class="mt-12 pt-6 border-t border-gray-300 flex justify-center">
                    <button id="back-from-balance-btn" class="w-full md:w-auto bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all">Volver al Panel Principal</button>
                </div>
            </section>
        </div>
    </div>

    <!-- COLECTAS ONLINE VIEW (FULLSCREEN OVERLAY) -->
    <section id="colectas-online-view" class="fixed inset-0 z-[1000] bg-gray-100 p-6 flex flex-col hidden">
        <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-300">
            <h2 class="text-3xl font-bold">Colectas</h2>
            <button id="back-from-colectas-online-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-6 rounded-xl shadow-lg transition-all">Volver</button>
        </div>
        <div class="flex-grow">
             <iframe id="colectas-iframe" src="https://parroquiasanjose.github.io/Colectas-Parroquia-San-Jose/" class="w-full h-full border-2 border-slate-300 rounded-lg"></iframe>
        </div>
    </section>

    <!-- NEW: COLECTAS CALCULATOR VIEW (FULLSCREEN OVERLAY) -->
    <section id="colectas-calculator-view" class="fixed inset-0 z-[1000] bg-gray-100 p-6 flex-col hidden">
         <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-300">
            <h2 class="text-3xl font-bold">Calculadora de Colectas</h2>
            <div class="flex items-center gap-4">
                <button id="back-from-colectas-calculator-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-6 rounded-xl shadow-lg transition-all">Volver</button>
            </div>
        </div>
        <div class="flex-grow flex items-center justify-center">
            <div class="w-full max-w-xl bg-white p-8 rounded-2xl shadow-2xl space-y-6">
                <div>
                    <label for="colectas-imperadas-input" class="block text-lg font-medium mb-2">Colectas Imperadas</label>
                    <input type="text" inputmode="numeric" id="colectas-imperadas-input" placeholder="Ingrese importe..." class="w-full p-4 border border-gray-300 rounded-lg bg-gray-50 text-2xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                 <div>
                    <label for="colectas-imperadas-result" class="block text-lg font-medium mb-2">Resultado (50%)</label>
                    <input type="text" id="colectas-imperadas-result" readonly class="w-full p-4 border border-gray-300 rounded-lg bg-gray-200 text-2xl font-bold text-green-600">
                </div>
                 <div>
                    <label for="colectas-parroquia-input" class="block text-lg font-medium mb-2">Colectas Parroquia</label>
                    <input type="text" inputmode="numeric" id="colectas-parroquia-input" placeholder="Ingrese importe..." class="w-full p-4 border border-gray-300 rounded-lg bg-gray-50 text-2xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                 <div class="pt-4 border-t-2 border-slate-300">
                    <label for="colectas-total" class="block text-xl font-bold mb-2">TOTAL</label>
                    <input type="text" id="colectas-total" readonly class="w-full p-4 border border-gray-300 rounded-lg bg-gray-200 text-3xl font-extrabold text-blue-600">
                </div>
            </div>
        </div>
    </section>

    <!-- MODALS (with unified design) -->
    <div id="generic-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-[1000] modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-auto modal-content">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-200">
                <h3 id="modal-title" class="text-xl font-bold"></h3>
                <button id="modal-close-btn" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="mb-6 text-slate-600">
                <!-- Content injected by JS -->
            </div>
            <div id="modal-footer" class="flex justify-end gap-4">
                <!-- Buttons injected by JS -->
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, where, writeBatch, getDoc, setDoc, enableIndexedDbPersistence, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Main App Object
        const App = {
            // --- STATE ---
            state: {
                db: null,
                auth: null,
                userId: null,
                isAuthenticated: false,
                currentView: 'main-view',
                generalTransactions: [],
                bancoTransactions: [],
                envioColectas: [],
                reminders: [],
                aportes: null,
                categories: {
                    general: { ingreso: [], egreso: [] },
                    banco: { ingreso: [], egreso: [] }
                },
                currentTransactions: [],
                pendingAction: null,
                isLoading: true,
                currentBlock: null,
                generalCurrentPage: 1,
                bancoCurrentPage: 1,
                recordsPerPage: 3,
                currentEditDay: { date: null, block: null },
                summaryChartInstance: null,
                tickerInterval: null,
                currentTickerIndex: 0,
            },

            // --- DOM ELEMENTS ---
            dom: {},

            // --- INITIALIZATION ---
            init() {
                for (const key in this) {
                    if (typeof this[key] === 'function' && key !== 'init') {
                        this[key] = this[key].bind(this);
                    }
                }
                this.cacheDom();
                this.bindEvents();
                this.initFirebase();
            },

            cacheDom() {
                this.dom = {
                    // Existing elements
                    loader: document.getElementById('loader'),
                    toastContainer: document.getElementById('toast-container'),
                    loginView: document.getElementById('login-view'),
                    appContainer: document.getElementById('app-container'),
                    emailInput: document.getElementById('email-input'),
                    passwordInput: document.getElementById('password-input'),
                    loginBtn: document.getElementById('login-btn'),
                    authErrorContainer: document.getElementById('auth-error-container'),
                    logoutBtn: document.getElementById('logout-btn'),
                    mainView: document.getElementById('main-view'),
                    dataEntryView: document.getElementById('data-entry-view'),
                    datePromptView: document.getElementById('date-prompt-view'),
                    editDayView: document.getElementById('edit-day-view'),
                    envioColectasView: document.getElementById('envio-colectas-view'),
                    aportesView: document.getElementById('aportes-view'),
                    balanceView: document.getElementById('balance-view'),
                    categoryManagementView: document.getElementById('category-management-view'),
                    remindersManagementView: document.getElementById('reminders-management-view'),
                    colectasOnlineView: document.getElementById('colectas-online-view'),
                    aportesContainer: document.getElementById('aportes-container'),
                    envioColectasList: document.getElementById('envio-colectas-list'),
                    envioSubtotal: document.getElementById('envio-subtotal'),
                    enviosColectasBtn: document.getElementById('envios-colectas-btn'),
                    aportesBtn: document.getElementById('aportes-btn'),
                    balanceBtn: document.getElementById('balance-btn'),
                    manageCategoriesBtn: document.getElementById('manage-categories-btn'),
                    manageRemindersBtn: document.getElementById('manage-reminders-btn'),
                    colectasOnlineBtn: document.getElementById('colectas-online-btn'),
                    backToPanelBtn: document.getElementById('back-to-panel-btn'),
                    backFromEnviosBtn: document.getElementById('back-from-envios-btn'),
                    backFromAportesBtn: document.getElementById('back-from-aportes-btn'),
                    backFromBalanceBtn: document.getElementById('back-from-balance-btn'),
                    backFromFormBtn: document.getElementById('back-from-form-btn'),
                    backFromDatePromptBtn: document.getElementById('back-from-date-prompt-btn'),
                    backFromEditDayBtn: document.getElementById('back-from-edit-day-btn'),
                    backFromCategoriesBtn: document.getElementById('back-from-categories-btn'),
                    backFromRemindersBtn: document.getElementById('back-from-reminders-btn'),
                    backFromColectasOnlineBtn: document.getElementById('back-from-colectas-online-btn'),
                    backFromBalanceFilterBtn: document.getElementById('back-from-balance-filter-btn'),
                    datePromptTitle: document.getElementById('date-prompt-title'),
                    entryDateInput: document.getElementById('entry-date-input'),
                    continueToFormBtn: document.getElementById('continue-to-form-btn'),
                    dataEntryTitle: document.getElementById('data-entry-title'),
                    sharedDate: document.getElementById('shared-date'),
                    ingresoForm: document.getElementById('ingreso-form'),
                    egresoForm: document.getElementById('egreso-form'),
                    ingresoCategoria: document.getElementById('ingreso-categoria'),
                    ingresoDescripcion: document.getElementById('ingreso-descripcion'),
                    ingresoMonto: document.getElementById('ingreso-monto'),
                    egresoCategoria: document.getElementById('egreso-categoria'),
                    egresoDescripcion: document.getElementById('egreso-descripcion'),
                    egresoMonto: document.getElementById('egreso-monto'),
                    addIngresoBtn: document.getElementById('add-ingreso-btn'),
                    addEgresoBtn: document.getElementById('add-egreso-btn'),
                    saveAllBtn: document.getElementById('save-all-btn'),
                    addedTransactionsList: document.getElementById('added-transactions-list'),
                    historyGeneralContainer: document.getElementById('history-general-container'),
                    historyBancoContainer: document.getElementById('history-banco-container'),
                    searchGeneralInput: document.getElementById('search-general-input'),
                    searchBancoInput: document.getElementById('search-banco-input'),
                    startDateFilter: document.getElementById('start-date-filter'),
                    endDateFilter: document.getElementById('end-date-filter'),
                    downloadRangePdfBtn: document.getElementById('download-range-pdf-btn'),
                    searchRangeBtn: document.getElementById('search-range-btn'),
                    rangeResultsContainer: document.getElementById('range-results-container'),
                    editDayTitle: document.getElementById('edit-day-title'),
                    editDayList: document.getElementById('edit-day-list'),
                    balanceTitle: document.getElementById('balance-title'),
                    balanceDateRange: document.getElementById('balance-date-range'),
                    balanceStartDate: document.getElementById('balance-start-date'),
                    balanceEndDate: document.getElementById('balance-end-date'),
                    filterBalanceBtn: document.getElementById('filter-balance-btn'),
                    summaryBalanceContainer: document.getElementById('summary-balance-container'),
                    balanceDetailsContainer: document.getElementById('balance-details-container'),
                    downloadSummaryPdfBtn: document.getElementById('download-summary-pdf-btn'),
                    downloadSummaryExcelBtn: document.getElementById('download-summary-excel-btn'),
                    downloadDetailedPdfBtn: document.getElementById('download-detailed-pdf-btn'),
                    downloadDetailedExcelBtn: document.getElementById('download-detailed-excel-btn'),
                    summaryChart: document.getElementById('summary-chart'),
                    newReminderForm: document.getElementById('new-reminder-form'),
                    reminderTitle: document.getElementById('reminder-title'),
                    reminderDate: document.getElementById('reminder-date'),
                    reminderDescription: document.getElementById('reminder-description'),
                    remindersListContainer: document.getElementById('reminders-list-container'),
                    genericModal: document.getElementById('generic-modal'),
                    modalTitle: document.getElementById('modal-title'),
                    modalBody: document.getElementById('modal-body'),
                    modalFooter: document.getElementById('modal-footer'),
                    modalCloseBtn: document.getElementById('modal-close-btn'),
                    notificationBellBtn: document.getElementById('notification-bell-btn'),
                    notificationBadge: document.getElementById('notification-badge'),
                    remindersPanel: document.getElementById('reminders-panel'),
                    remindersList: document.getElementById('reminders-list'),
                    categoryGeneralIngresoContainer: document.getElementById('category-general-ingreso-container'),
                    categoryGeneralEgresoContainer: document.getElementById('category-general-egreso-container'),
                    categoryBancoIngresoContainer: document.getElementById('category-banco-ingreso-container'),
                    categoryBancoEgresoContainer: document.getElementById('category-banco-egreso-container'),
                    notificationTickerContainer: document.getElementById('notification-ticker-container'),
                    notificationTicker: document.getElementById('notification-ticker'),

                    // New elements for Colectas Calculator
                    colectasCalculatorView: document.getElementById('colectas-calculator-view'),
                    colectasCalculatorBtn: document.getElementById('colectas-calculator-btn'),
                    backFromColectasCalculatorBtn: document.getElementById('back-from-colectas-calculator-btn'),
                    colectasImperadasInput: document.getElementById('colectas-imperadas-input'),
                    colectasImperadasResult: document.getElementById('colectas-imperadas-result'),
                    colectasParroquiaInput: document.getElementById('colectas-parroquia-input'),
                    colectasTotal: document.getElementById('colectas-total'),
                };
            },
            
            // --- FIREBASE SETUP ---
            async initFirebase() {
                const firebaseConfig = {
                    apiKey: "AIzaSyCCpr9FqklSBzkedKGQyNQrTLB30Y-AhJI",
                    authDomain: "gestionparroquial-2fabc.firebaseapp.com",
                    projectId: "gestionparroquial-2fabc",
                    storageBucket: "gestionparroquial-2fabc.appspot.com",
                    messagingSenderId: "710289559218",
                    appId: "1:710289559218:web:26bf19a750914deb3a83ab"
                };

                let app;
                try {
                    app = initializeApp(firebaseConfig);
                    this.state.db = getFirestore(app);
                    await enableIndexedDbPersistence(this.state.db);
                    console.log("Firebase persistence enabled.");
                } catch (error) {
                    console.warn("Firebase persistence error:", error.code);
                    if (!app) {
                        app = initializeApp(firebaseConfig);
                        this.state.db = getFirestore(app);
                    }
                }

                this.state.auth = getAuth(app);
                this.setupAuthListener();
            },

            setupAuthListener() {
                onAuthStateChanged(this.state.auth, (user) => {
                    this.toggleLoader(false);
                    if (user) {
                        this.state.userId = user.uid;
                        this.state.isAuthenticated = true;
                        console.log("User authenticated with UID:", this.state.userId);
                        
                        this.dom.appContainer.classList.remove('hidden');
                        this.dom.loginView.classList.add('hidden');
                        
                        this.setupRealtimeListeners();
                    } else {
                        this.state.userId = null;
                        this.state.isAuthenticated = false;
                        console.log("User is signed out.");

                        this.dom.appContainer.classList.add('hidden');
                        this.dom.loginView.classList.remove('hidden');
                        this.state.generalTransactions = [];
                        this.state.bancoTransactions = [];
                    }
                });
            },
            
            async setupRealtimeListeners() {
                if (!this.state.isAuthenticated) return;
                this.toggleLoader(true);
                try {
                    await this.checkAndSeedCategories();
                    await this.checkAndSeedEnvioColectas();
                    await this.checkAndSeedAportesData();

                    this.listenToTransactions('general');
                    this.listenToTransactions('banco');
                    this.listenToEnvioColectas();
                    this.listenToAportesData();
                    this.listenToCategories();
                    this.listenToReminders();
                    
                    const lastView = localStorage.getItem('currentParishView');
                    if (lastView && document.getElementById(lastView)) {
                        this.switchView(lastView);
                    } else {
                        this.showMainView();
                    }

                } catch(error) {
                    console.error("Error setting up listeners:", error);
                    this.showToast("No se pudieron cargar los datos en tiempo real.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            // --- EVENT BINDING ---
            bindEvents() {
                this.dom.loginBtn.addEventListener('click', this.handleLogin);
                this.dom.passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleLogin();
                });
                this.dom.logoutBtn.addEventListener('click', this.handleLogout);
                
                this.dom.backToPanelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showMainView();
                });

                this.dom.mainView.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    
                    const { action, block, date, page } = button.dataset;

                    if (action === 'load-data') this.showDatePromptView(block);
                    else if (action === 'delete-date') this.confirmDeleteDate(date, block);
                    else if (action === 'edit-day') this.showEditDayView(date, block);
                    else if (action === 'paginate') this.handlePagination(block, parseInt(page));
                });
                
                this.dom.enviosColectasBtn.addEventListener('click', this.showEnvioColectasView);
                this.dom.aportesBtn.addEventListener('click', this.showAportesView);
                this.dom.balanceBtn.addEventListener('click', this.showBalanceView);
                this.dom.manageCategoriesBtn.addEventListener('click', this.showCategoryManagementView);
                this.dom.manageRemindersBtn.addEventListener('click', this.showRemindersManagementView);
                this.dom.colectasOnlineBtn.addEventListener('click', this.showColectasOnlineView);
                this.dom.backFromColectasOnlineBtn.addEventListener('click', this.hideColectasOnlineView);
                this.dom.backFromBalanceFilterBtn.addEventListener('click', this.showMainView);
                
                [this.dom.backFromEnviosBtn, this.dom.backFromAportesBtn, this.dom.backFromBalanceBtn, this.dom.backFromFormBtn, this.dom.backFromDatePromptBtn, this.dom.backFromEditDayBtn, this.dom.backFromCategoriesBtn, this.dom.backFromRemindersBtn].forEach(btn => {
                    btn.addEventListener('click', this.showMainView);
                });

                // New bindings for Colectas Calculator
                this.dom.colectasCalculatorBtn.addEventListener('click', this.showColectasCalculatorView);
                this.dom.backFromColectasCalculatorBtn.addEventListener('click', this.hideColectasCalculatorView);

                this.dom.colectasImperadasInput.addEventListener('input', this.calculateColectas);
                this.dom.colectasParroquiaInput.addEventListener('input', this.calculateColectas);


                this.dom.downloadRangePdfBtn.addEventListener('click', this.downloadDateRangePDF);
                this.dom.searchRangeBtn.addEventListener('click', this.showDateRangeResults);
                this.dom.continueToFormBtn.addEventListener('click', this.handleDatePromptContinue);

                this.dom.filterBalanceBtn.addEventListener('click', this.generateAndDisplayBalance);
                this.dom.downloadSummaryPdfBtn.addEventListener('click', this.generateGeneralSummaryPDF);
                this.dom.downloadSummaryExcelBtn.addEventListener('click', this.generateGeneralSummaryExcel);
                this.dom.downloadDetailedPdfBtn.addEventListener('click', this.generateCompleteBalancePDF);
                this.dom.downloadDetailedExcelBtn.addEventListener('click', this.generateCompleteBalanceExcel);

                this.dom.addIngresoBtn.addEventListener('click', () => this.addTransactionToList('ingreso'));
                this.dom.addEgresoBtn.addEventListener('click', () => this.addTransactionToList('egreso'));
                this.dom.saveAllBtn.addEventListener('click', this.handleSaveAll);

                this.dom.searchGeneralInput.addEventListener('input', () => { this.state.generalCurrentPage = 1; this.renderHistory('general'); });
                this.dom.searchBancoInput.addEventListener('input', () => { this.state.bancoCurrentPage = 1; this.renderHistory('banco'); });

                this.dom.modalCloseBtn.addEventListener('click', this.hideModal);
                this.dom.genericModal.addEventListener('click', (e) => {
                    if (e.target === this.dom.genericModal) {
                        this.hideModal();
                    }
                });

                this.dom.editDayList.addEventListener('click', e => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const { action, id, block } = button.dataset;
                    if (action === 'edit-transaction') this.showEditTransactionModal(id, block);
                    else if (action === 'delete-transaction') this.handleDeleteSingleTransaction(id, block);
                });
                
                this.dom.envioColectasList.addEventListener('click', e => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const { action, id } = button.dataset;
                    if (action === 'save-monto') this.saveEnvioMonto(id);
                    else if (action === 'edit-colecta') this.showEditColectaModal(id);
                });

                this.dom.aportesContainer.addEventListener('click', e => {
                    const button = e.target.closest('button[data-key]');
                    if (!button) return;
                    const { key, label } = button.dataset;
                    this.showEditAporteModal(key, label);
                });

                this.dom.categoryManagementView.addEventListener('click', e => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const { action, block, type, id, name } = button.dataset;
                    if (action === 'add-category') this.handleAddCategory(block, type);
                    else if (action === 'edit-category') this.showEditCategoryModal(id, name);
                    else if (action === 'delete-category') this.handleDeleteCategory(id, name);
                });

                this.dom.notificationBellBtn.addEventListener('click', () => {
                    this.dom.remindersPanel.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!this.dom.notificationBellBtn.contains(e.target) && !this.dom.remindersPanel.contains(e.target)) {
                        this.dom.remindersPanel.classList.add('hidden');
                    }
                });

                this.dom.newReminderForm.addEventListener('submit', e => {
                    e.preventDefault();
                    this.handleAddReminder();
                });
                this.dom.remindersListContainer.addEventListener('click', e => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const { action, id } = button.dataset;
                    if (action === 'edit-reminder') this.showEditReminderModal(id);
                    else if (action === 'delete-reminder') this.handleDeleteReminder(id);
                    else if (action === 'toggle-reminder-status') this.handleToggleReminderStatus(id);
                });
                
                this.dom.remindersList.addEventListener('click', e => {
                    const button = e.target.closest('button[data-action="complete-reminder"]');
                    if(button) {
                        this.handleToggleReminderStatus(button.dataset.id, 'completado');
                    }
                });

                this.dom.addedTransactionsList.addEventListener('click', e => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const id = parseFloat(button.dataset.id);
                    if(button.dataset.action === 'delete-temp') this.deleteTransactionFromList(id);
                    else if (button.dataset.action === 'edit-temp') this.showEditTempTransactionModal(id);
                });

                // Add formatting listeners for static inputs
                this.addFormattingListener(this.dom.ingresoMonto);
                this.addFormattingListener(this.dom.egresoMonto);
                // Add formatting for new calculator inputs
                this.addFormattingListener(this.dom.colectasImperadasInput);
                this.addFormattingListener(this.dom.colectasParroquiaInput);
            },

            // --- AUTHENTICATION ---
            handleLogin() {
                const email = this.dom.emailInput.value;
                const password = this.dom.passwordInput.value;
                this.dom.authErrorContainer.textContent = '';
                if (!email || !password) {
                    this.showToast("Por favor, ingrese correo y contraseña.", "error");
                    return;
                }
                this.toggleLoader(true);
                signInWithEmailAndPassword(this.state.auth, email, password)
                    .catch(error => this.handleAuthError(error));
            },

            handleLogout() {
                signOut(this.state.auth).catch(error => {
                    console.error("Error signing out:", error);
                    this.showToast("Error al cerrar sesión.", "error");
                });
            },

            handleAuthError(error) {
                this.toggleLoader(false);
                let message = "Ocurrió un error desconocido.";
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        message = "Correo o contraseña incorrectos.";
                        break;
                    case 'auth/email-already-in-use':
                        message = "El correo electrónico ya está registrado.";
                        break;
                    case 'auth/weak-password':
                        message = "La contraseña debe tener al menos 6 caracteres.";
                        break;
                    case 'auth/invalid-email':
                        message = "El formato del correo electrónico no es válido.";
                        break;
                }
                this.dom.authErrorContainer.textContent = message;
            },

            // --- DATA HANDLING & FIRESTORE ---
            getCollectionRef(name) {
                if (!this.state.isAuthenticated) {
                    console.error("User not authenticated, cannot get collection reference.");
                    return null;
                }
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const path = `artifacts/${appId}/public/data/${name}`;
                return collection(this.state.db, path);
            },
            
            async checkAndSeedEnvioColectas() {
                const collRef = this.getCollectionRef("envio_colectas");
                if (!collRef) return;
                const snapshot = await getDocs(collRef);
                if (snapshot.empty) {
                    const initialData = [
                        { orden: 1, fecha: "4-5 ENERO", descripcion: "MISIONES DEL AFRICA", monto: 141400 },
                        { orden: 2, fecha: "11-12 ENERO", descripcion: "DIOCESIS", monto: 152500 },
                        { orden: 3, fecha: "1-2 FEBRERO", descripcion: "DIOCESIS", monto: 181720 },
                        { orden: 4, fecha: "1-2 MARZO", descripcion: "DIOCESIS", monto: 167300 },
                        { orden: 5, fecha: "5-6 ABRIL", descripcion: "DIOCESIS", monto: 195445 },
                        { orden: 6, fecha: "18 abril", descripcion: "TIERRA SANTA", monto: 118150 },
                        { orden: 7, fecha: "3-4 MAYO", descripcion: "DIOCESIS", monto: 160280 },
                        { orden: 8, fecha: "7-8 JUNIO", descripcion: "DIOCESIS", monto: null },
                        { orden: 9, fecha: "14-15 JUNIO", descripcion: "CARITAS", monto: null },
                        { orden: 10, fecha: "5-6 JULIO", descripcion: "OFRENDA UNIVERSAL", monto: 141865 },
                        { orden: 11, fecha: "12-13 JULIO", descripcion: "DIOCESIS", monto: 96070 },
                        { orden: 12, fecha: "2-3 AGOSTO", descripcion: "DIOCESIS", monto: null },
                        { orden: 13, fecha: "6-7 SEPTIEMBRE", descripcion: "MAS POR MENOS", monto: null },
                        { orden: 14, fecha: "13-14 SEPTIEMBRE", descripcion: "DIOCESIS", monto: null },
                        { orden: 15, fecha: "4-5 OCTUBRE", descripcion: "DIOCESIS", monto: null },
                        { orden: 16, fecha: "11-12 OCTUBRE", descripcion: "JORN. DE LAS MISIONES", monto: null },
                        { orden: 17, fecha: "1-2 NOVIEMBRE", descripcion: "DIOCESIS", monto: null },
                        { orden: 18, fecha: "6-7 DICIEMBRE", descripcion: "DIOCESIS", monto: null },
                        { orden: 19, fecha: "CONFIRMACION", descripcion: "CONFIRMACION", monto: null },
                        { orden: 20, fecha: "CAMPAÑA TAE", descripcion: "CAMPAÑA TAE", monto: null },
                    ];
                    const batch = writeBatch(this.state.db);
                    initialData.forEach(item => {
                        const docRef = doc(collRef);
                        batch.set(docRef, item);
                    });
                    await batch.commit();
                    this.showToast("Datos iniciales de colectas cargados.", "success");
                }
            },

            async checkAndSeedAportesData() {
                const docRef = doc(this.getCollectionRef("configuracion_financiera"), "valores");
                if (!docRef) return;
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    const initialData = {
                        sueldo_camila: 480000,
                        sueldo_julio: 480000,
                        cargas_sociales: 568199.33,
                        asignacion_jorge: 156000,
                        asignacion_adan: 156000,
                        mutual_jorge: 127050,
                        mutual_adan: 127050,
                        aporte_seminaristas_jun25: 73750,
                        aporte_seminaristas_dividido: 295,
                        aporte_seminaristas_jul25: 295,
                    };
                    await setDoc(docRef, initialData);
                    this.showToast("Datos iniciales de aportes cargados.", "success");
                }
            },

            listenToAportesData() {
                const docRef = doc(this.getCollectionRef("configuracion_financiera"), "valores");
                if (!docRef) return;
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.state.aportes = data;
                        if(this.state.currentView === 'aportes-view') {
                            this.renderAportes();
                        }
                    } else {
                        console.log("No such document in configuracion_financiera!");
                    }
                });
            },

            listenToEnvioColectas() {
                const collRef = this.getCollectionRef("envio_colectas");
                if (!collRef) return;
                onSnapshot(collRef, (snapshot) => {
                    let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => a.orden - b.orden);
                    this.state.envioColectas = data;
                    if (this.state.currentView === 'envio-colectas-view') {
                        this.renderEnvioColectas();
                    }
                    this.updateReminders();
                });
            },
            
            listenToTransactions(block) {
                const collectionName = block === 'general' ? 'gestion_general' : 'gestion_banco';
                const collRef = this.getCollectionRef(collectionName);
                if (!collRef) return;

                onSnapshot(collRef, (snapshot) => {
                    let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => b.fecha.localeCompare(a.fecha));
                    
                    if (block === 'general') {
                        this.state.generalTransactions = data;
                    } else {
                        this.state.bancoTransactions = data;
                    }
                    if(this.state.currentView === 'main-view') {
                        this.renderHistory(block);
                    }
                });
            },
            
            async commitTransactions() {
                this.hideModal();
                if (this.state.currentTransactions.length === 0) {
                    this.showToast("No hay registros nuevos para guardar.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const batch = writeBatch(this.state.db);
                    for (const trans of this.state.currentTransactions) {
                        const collectionRef = this.getCollectionRef(trans.block === 'general' ? 'gestion_general' : 'gestion_banco');
                        if (!collectionRef) throw new Error("Collection reference is null");
                        const newDocRef = doc(collectionRef);
                        const data = { ...trans };
                        delete data.id; 
                        delete data.isNew;
                        batch.set(newDocRef, data);
                    }
                    await batch.commit();
                    this.showToast("Operación guardada con éxito.", "success");
                    this.state.currentTransactions = [];
                    this.showMainView();
                } catch (error) {
                    console.error("Error committing transactions:", error);
                    this.showToast("Error al guardar la operación.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            
            async deleteDate(dateString, block) {
                this.toggleLoader(true);
                try {
                    const collectionRef = this.getCollectionRef(block === 'general' ? 'gestion_general' : 'gestion_banco');
                    if (!collectionRef) throw new Error("Collection reference is null");
                    const q = query(collectionRef, where("fecha", "==", dateString));
                    const snapshot = await getDocs(q);
                    
                    const batch = writeBatch(this.state.db);
                    snapshot.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();

                    this.showToast(`Registros del ${this.formatDate(dateString)} eliminados.`, "success");
                } catch (error) {
                    console.error("Error deleting date records:", error);
                    this.showToast("Error al eliminar los registros.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            async saveEnvioMonto(id) {
                const input = document.getElementById(`monto-input-${id}`);
                const monto = this.getNumericValue(input.value);
                if (isNaN(monto) || monto <= 0) {
                    this.showToast("Por favor, ingresa un monto válido.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef("envio_colectas");
                    if (!collRef) throw new Error("Collection reference is null");
                    const docRef = doc(collRef, id);
                    await updateDoc(docRef, { monto: monto });
                    this.showToast("Monto guardado.", "success");
                } catch (error) {
                    console.error("Error saving monto:", error);
                    this.showToast("Error al guardar el monto.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            // --- UI RENDERING ---
            renderHistory(block) {
                const container = block === 'general' ? this.dom.historyGeneralContainer : this.dom.historyBancoContainer;
                
                // Show skeleton loader
                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="h-20 bg-gray-200 rounded-lg skeleton-loader"></div>
                        <div class="h-20 bg-gray-200 rounded-lg skeleton-loader"></div>
                        <div class="h-20 bg-gray-200 rounded-lg skeleton-loader"></div>
                    </div>
                `;

                // Use a small timeout to allow the DOM to update with the skeleton before processing
                setTimeout(() => {
                    let currentPage = block === 'general' ? this.state.generalCurrentPage : this.state.bancoCurrentPage;
                    const transactions = block === 'general' ? this.state.generalTransactions : this.state.bancoTransactions;
                    const searchInput = block === 'general' ? this.dom.searchGeneralInput : this.dom.searchBancoInput;
                    
                    container.innerHTML = ''; // Clear skeleton
                    const searchTerm = searchInput.value;
                    
                    const groupedByDate = transactions.reduce((acc, trans) => {
                        const date = this.formatDate(trans.fecha);
                        if (!acc[date]) acc[date] = { rawDate: trans.fecha, transactions: [] };
                        acc[date].transactions.push(trans);
                        return acc;
                    }, {});

                    const filteredDates = Object.keys(groupedByDate).filter(date => date.includes(searchTerm));

                    const listContainer = document.createElement('div');
                    listContainer.className = 'space-y-4';

                    if (filteredDates.length === 0) {
                        listContainer.innerHTML = '<p class="text-center text-gray-500 py-10">No se encontraron registros.</p>';
                        container.appendChild(listContainer);
                        return;
                    }

                    const totalPages = Math.ceil(filteredDates.length / this.state.recordsPerPage);
                    if (currentPage > totalPages) currentPage = totalPages;
                    
                    const startIndex = (currentPage - 1) * this.state.recordsPerPage;
                    const endIndex = startIndex + this.state.recordsPerPage;
                    const paginatedDates = filteredDates.slice(startIndex, endIndex);

                    paginatedDates.forEach(date => {
                        const { rawDate, transactions: dailyTransactions } = groupedByDate[date];
                        let totalIngresos = 0;
                        let totalEgresos = 0;
                        dailyTransactions.forEach(t => {
                            if (t.type === 'ingreso') totalIngresos += t.monto;
                            else totalEgresos += t.monto;
                        });
                        
                        const dateGroup = document.createElement('div');
                        dateGroup.className = 'bg-gray-50 p-4 rounded-lg';
                        dateGroup.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-lg">${date}</h3>
                                <div class="flex gap-2">
                                    <button data-action="edit-day" data-date="${rawDate}" data-block="${block}" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200 transition-colors">Modificar</button>
                                    <button data-action="delete-date" data-date="${rawDate}" data-block="${block}" class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200 transition-colors">Eliminar</button>
                                </div>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-green-500">Ingresos: ${this.formatCurrency(totalIngresos)}</span>
                                <span class="text-red-500">Egresos: ${this.formatCurrency(totalEgresos)}</span>
                                <span class="font-semibold">Saldo: ${this.formatCurrency(totalIngresos - totalEgresos)}</span>
                            </div>
                        `;
                        listContainer.appendChild(dateGroup);
                    });

                    container.appendChild(listContainer);

                    if (totalPages > 1) {
                        const paginationContainer = document.createElement('div');
                        paginationContainer.className = 'flex justify-between items-center mt-4';
                        
                        const prevDisabled = currentPage === 1 ? 'disabled' : '';
                        const nextDisabled = currentPage === totalPages ? 'disabled' : '';

                        paginationContainer.innerHTML = `
                            <button data-action="paginate" data-block="${block}" data-page="${currentPage - 1}" ${prevDisabled} class="text-sm bg-slate-200 px-3 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors">Anterior</button>
                            <span class="text-sm font-semibold">Página ${currentPage} de ${totalPages}</span>
                            <button data-action="paginate" data-block="${block}" data-page="${currentPage + 1}" ${nextDisabled} class="text-sm bg-slate-200 px-3 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors">Siguiente</button>
                        `;
                        container.appendChild(paginationContainer);
                    }
                }, 10); // A small delay to ensure skeleton renders
            },
            
            renderEnvioColectas() {
                this.dom.envioColectasList.innerHTML = '';
                let subtotal = 0;
                this.state.envioColectas.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-3 bg-gray-50 rounded-lg grid grid-cols-4 gap-4 items-center';
                    
                    let montoHtml = '';
                    if (item.monto !== null) {
                        montoHtml = `<span class="font-semibold">${this.formatCurrency(item.monto)}</span>`;
                        subtotal += item.monto;
                    } else {
                        montoHtml = `
                            <div class="flex gap-2">
                                <input type="text" inputmode="numeric" placeholder="Monto" class="w-full p-1 border border-gray-300 rounded bg-white" id="monto-input-${item.id}">
                                <button data-action="save-monto" data-id="${item.id}" class="text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded">Guardar</button>
                            </div>
                        `;
                    }

                    itemDiv.innerHTML = `
                        <div class="font-semibold">${item.fecha}</div>
                        <div>${item.descripcion}</div>
                        <div class="text-right col-span-1">${montoHtml}</div>
                        <div class="text-right">
                            <button data-action="edit-colecta" data-id="${item.id}" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded">Editar</button>
                        </div>
                    `;
                    this.dom.envioColectasList.appendChild(itemDiv);
                    // Add listener for dynamically created input
                    const dynamicInput = document.getElementById(`monto-input-${item.id}`);
                    if (dynamicInput) {
                        this.addFormattingListener(dynamicInput);
                    }
                });
                this.dom.envioSubtotal.textContent = this.formatCurrency(subtotal);
            },
            
            // --- UI FLOW & VIEWS ---
            switchView(viewId) {
                localStorage.setItem('currentParishView', viewId);
                
                // Hide all fullscreen overlays first
                this.dom.colectasOnlineView.classList.add('hidden');
                this.dom.colectasCalculatorView.classList.add('hidden');

                if (viewId === 'colectas-online-view' || viewId === 'colectas-calculator-view') {
                    document.getElementById(viewId).classList.remove('hidden');
                    return;
                }

                const currentViewEl = document.getElementById(this.state.currentView);
                if (currentViewEl && currentViewEl.classList.contains('view-container')) {
                    currentViewEl.classList.remove('visible');
                }

                setTimeout(() => {
                    document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
                    
                    const newViewEl = document.getElementById(viewId);
                    if (newViewEl) {
                        newViewEl.classList.remove('hidden');
                        setTimeout(() => {
                            newViewEl.classList.add('visible');
                            this.state.currentView = viewId;
                        }, 20);
                    }
                }, 300);
            },

            showMainView() {
                this.switchView('main-view');
                this.state.currentTransactions = [];
                this.state.currentBlock = null;
                this.renderHistory('general');
                this.renderHistory('banco');
            },

            // --- MODAL LOGIC ---
            showModal(config) {
                this.dom.modalTitle.textContent = config.title;
                this.dom.modalBody.innerHTML = config.body;
                this.dom.modalFooter.innerHTML = ''; // Clear previous buttons

                config.buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.textContent = btnConfig.text;
                    button.className = btnConfig.class;
                    button.addEventListener('click', btnConfig.action);
                    this.dom.modalFooter.appendChild(button);
                });

                this.dom.genericModal.classList.remove('hidden');
            },

            hideModal() {
                this.dom.genericModal.classList.add('hidden');
                this.state.pendingAction = null;
            },

            handleSaveAll() {
                if (this.state.currentTransactions.length === 0) {
                    this.showToast("No hay registros nuevos para guardar.", "error");
                    return;
                }
                const ingresosCount = this.state.currentTransactions.filter(t => t.type === 'ingreso').length;
                const egresosCount = this.state.currentTransactions.filter(t => t.type === 'egreso').length;

                this.showModal({
                    title: "Confirmar Guardado",
                    body: `<p>Se guardarán ${ingresosCount} ingreso(s) y ${egresosCount} egreso(s). ¿Desea continuar?</p>`,
                    buttons: [
                        { text: 'Cancelar', class: 'bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg transition-all', action: this.hideModal },
                        { text: 'Sí, Guardar', class: 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-all', action: this.commitTransactions }
                    ]
                });
            },

            confirmDeleteDate(dateString, block) {
                this.state.pendingAction = () => this.deleteDate(dateString, block);
                this.showModal({
                    title: "Confirmar Eliminación",
                    body: `<p>¿Estás seguro de que quieres eliminar todos los registros del día <strong>${this.formatDate(dateString)}</strong>? Esta acción no se puede deshacer.</p>`,
                    buttons: [
                        { text: 'Cancelar', class: 'bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg transition-all', action: this.hideModal },
                        { text: 'Confirmar', class: 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-all', action: () => { this.state.pendingAction(); this.hideModal(); } }
                    ]
                });
            },

            // --- UI HELPERS ---
            toggleLoader(isLoading) {
                this.dom.loader.classList.toggle('hidden', !isLoading);
            },

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                this.dom.toastContainer.appendChild(toast);
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 5000);
            },
            
            handlePagination(block, page) {
                if (block === 'general') {
                    this.state.generalCurrentPage = page;
                } else {
                    this.state.bancoCurrentPage = page;
                }
                this.renderHistory(block);
            },

            formatCurrency(amount) {
                if (typeof amount !== 'number') return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(0);
                return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
            },

            formatDate(dateString) {
                if (!dateString || !dateString.includes('-')) return dateString;
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            },

            // --- NUMBER FORMATTING HELPERS ---
            formatNumberWithThousands(n) {
                if (n === null || n === undefined) return '';
                const numStr = String(n).replace(/\D/g, '');
                return numStr.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            },

            getNumericValue(formattedValue) {
                if (typeof formattedValue !== 'string') {
                    return parseFloat(formattedValue) || 0;
                }
                return parseFloat(formattedValue.replace(/\./g, '').replace(',', '.')) || 0;
            },
            
            addFormattingListener(element) {
                if (!element) return;
                element.addEventListener('input', (e) => {
                    const originalValue = e.target.value;
                    const formattedValue = this.formatNumberWithThousands(originalValue);
                    if (originalValue !== formattedValue) {
                       e.target.value = formattedValue;
                    }
                });
            },

            // --- BALANCE & CHART LOGIC ---
            generateAndDisplayBalance() {
                const startDate = this.dom.balanceStartDate.value;
                const endDate = this.dom.balanceEndDate.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, selecciona un rango de fechas para el balance.", "error");
                    return;
                }
                this.dom.balanceDateRange.textContent = `del ${this.formatDate(startDate)} al ${this.formatDate(endDate)}`;

                this.renderDetailedBalance(startDate, endDate);
                this.renderSummaryBalance(startDate, endDate);
                
                this.dom.backFromBalanceFilterBtn.classList.remove('hidden');
                this.dom.backFromBalanceBtn.classList.add('hidden');
            },

            renderSummaryBalance(startDate, endDate) {
                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                this.dom.summaryBalanceContainer.innerHTML = '';
                
                if (generalInRange.length === 0) {
                    this.dom.summaryBalanceContainer.innerHTML = '<p class="text-center text-gray-500">No se encontraron registros generales en el rango seleccionado.</p>';
                    this.renderSummaryChart(0, 0);
                    return;
                }

                const summary = this.summarizeTransactionsByCategory(generalInRange);
                const totalIngresos = summary.ingresos.reduce((sum, item) => sum + item.monto, 0);
                const totalEgresos = summary.egresos.reduce((sum, item) => sum + item.monto, 0);
                const saldoFinal = totalIngresos - totalEgresos;

                this.renderSummaryChart(totalIngresos, totalEgresos);

                let html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            ${this.renderBalanceTable('Ingresos Generales (Resumido)', summary.ingresos, totalIngresos, 0, true)}
                        </div>
                        <div>
                            ${this.renderBalanceTable('Egresos Generales (Resumido)', summary.egresos, 0, totalEgresos, true)}
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t-2 border-gray-300 text-right font-bold text-xl">
                        <p class="mb-2">Total Ingresos (General): <span class="text-green-500">${this.formatCurrency(totalIngresos)}</span></p>
                        <p class="mb-2">Total Egresos (General): <span class="text-red-500">${this.formatCurrency(totalEgresos)}</span></p>
                        <p class="text-2xl">Saldo Final (General): <span class="${saldoFinal >= 0 ? 'text-green-600' : 'text-red-600'}">${this.formatCurrency(saldoFinal)}</span></p>
                    </div>
                `;
                this.dom.summaryBalanceContainer.innerHTML = html;
            },

            renderSummaryChart(ingresos, egresos) {
                const chartElement = this.dom.summaryChart;
                if (!chartElement) return;

                if (this.state.summaryChartInstance) {
                    this.state.summaryChartInstance.destroy();
                }

                const data = {
                    labels: ['Ingresos', 'Egresos'],
                    datasets: [{
                        label: 'Balance',
                        data: [ingresos, egresos],
                        backgroundColor: ['rgba(52, 211, 153, 0.7)', 'rgba(239, 68, 68, 0.7)'],
                        borderColor: ['rgba(16, 185, 129, 1)', 'rgba(220, 38, 38, 1)'],
                        borderWidth: 1
                    }]
                };

                const config = {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: '#475569' }
                            }
                        }
                    },
                };

                this.state.summaryChartInstance = new Chart(chartElement, config);
            },

            renderAportes() {
                const container = this.dom.aportesContainer;
                const data = this.state.aportes;
                if (!data) {
                    container.innerHTML = '<p>Cargando datos de aportes...</p>';
                    return;
                }

                const createRow = (key, label) => `
                    <div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded-lg">
                        <span>${label}</span>
                        <div class="flex items-center gap-4">
                            <span class="font-semibold w-32 text-right">${this.formatCurrency(data[key] || 0)}</span>
                            <button data-key="${key}" data-label="${label}" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-md transition-colors">Editar</button>
                        </div>
                    </div>
                `;

                container.innerHTML = `
                    <div>
                        <h3 class="text-xl font-semibold border-b border-gray-300 pb-2 mb-3">SUELDOS</h3>
                        <div class="space-y-2 pl-4">
                            ${createRow('sueldo_camila', 'CAMILA')}
                            ${createRow('sueldo_julio', 'JULIO')}
                            ${createRow('cargas_sociales', 'CARGAS SOCIALES')}
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold border-b border-gray-300 pb-2 mb-3">APORTE SACERDOTES</h3>
                        <h4 class="text-lg font-medium pl-4 mb-2">ASIGNACION</h4>
                        <div class="space-y-2 pl-8">
                            ${createRow('asignacion_jorge', 'P. JORGE')}
                            ${createRow('asignacion_adan', 'P. ADAN')}
                            ${createRow('mutual_jorge', 'MUTUAL P. JORGE')}
                            ${createRow('mutual_adan', 'MUTUAL P. ADAN')}
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold border-b border-gray-300 pb-2 mb-3">APORTE POR SEMINARISTAS</h3>
                        <div class="space-y-2 pl-4">
                            ${createRow('aporte_seminaristas_jun25', 'jun-25')}
                            ${createRow('aporte_seminaristas_dividido', 'DIVIDIDO POR 4 PARROQUIAS')}
                            ${createRow('aporte_seminaristas_jul25', 'jul-25')}
                        </div>
                    </div>
                `;
            },
            
            // --- ALL OTHER FUNCTIONS RESTORED HERE ---
            // The following is a large block of the previously missing functions.

            renderDetailedBalance(startDate, endDate) {
                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                
                this.dom.balanceDetailsContainer.innerHTML = ''; 

                if (generalInRange.length === 0 && bancoInRange.length === 0) {
                    this.dom.balanceDetailsContainer.innerHTML = '<p class="text-center text-gray-500">No se encontraron registros detallados en el rango seleccionado.</p>';
                    return;
                }

                const balanceData = {
                    general: { ingresos: 0, egresos: 0, transacciones: generalInRange },
                    banco: { ingresos: 0, egresos: 0, transacciones: bancoInRange },
                };

                generalInRange.forEach(t => {
                    if (t.type === 'ingreso') balanceData.general.ingresos += t.monto;
                    else balanceData.general.egresos += t.monto;
                });

                bancoInRange.forEach(t => {
                    if (t.type === 'ingreso') balanceData.banco.ingresos += t.monto;
                    else balanceData.banco.egresos += t.monto;
                });
                
                const totalIngresos = balanceData.general.ingresos + balanceData.banco.ingresos;
                const totalEgresos = balanceData.general.egresos + balanceData.banco.egresos;
                const saldoFinal = totalIngresos - totalEgresos;

                let html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            ${this.renderBalanceTable('Ingresos y Egresos Generales (Detallado)', balanceData.general.transacciones, balanceData.general.ingresos, balanceData.general.egresos)}
                        </div>
                        <div>
                            ${this.renderBalanceTable('Movimientos de Banco (Detallado)', balanceData.banco.transacciones, balanceData.banco.ingresos, balanceData.banco.egresos)}
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t-2 border-gray-300 text-right font-bold text-xl">
                        <p class="mb-2">Total Ingresos (Completo): <span class="text-green-500">${this.formatCurrency(totalIngresos)}</span></p>
                        <p class="mb-2">Total Egresos (Completo): <span class="text-red-500">${this.formatCurrency(totalEgresos)}</span></p>
                        <p class="text-2xl">Saldo Final (Completo): <span class="${saldoFinal >= 0 ? 'text-green-600' : 'text-red-600'}">${this.formatCurrency(saldoFinal)}</span></p>
                    </div>
                `;

                this.dom.balanceDetailsContainer.innerHTML = html;
            },

            renderBalanceTable(title, transactions, totalIngresos, totalEgresos, isSummary = false) {
                let rowsHtml;
                if (isSummary) {
                    rowsHtml = transactions.length > 0 ? transactions.map(t => `
                        <tr class="border-b border-gray-200">
                            <td class="py-2 px-3">${t.categoria}</td>
                            <td class="py-2 px-3 text-right">${this.formatCurrency(t.monto)}</td>
                        </tr>
                    `).join('') : '<tr><td colspan="2" class="text-center py-4">No hay movimientos</td></tr>';
                } else {
                    rowsHtml = transactions.length > 0 ? transactions.sort((a,b) => a.fecha.localeCompare(b.fecha)).map(t => `
                        <tr class="border-b border-gray-200">
                            <td class="py-2 px-3">${this.formatDate(t.fecha)}</td>
                            <td class="py-2 px-3">${t.categoria}</td>
                            <td class="py-2 px-3 text-right">${t.type === 'ingreso' ? this.formatCurrency(t.monto) : '-'}</td>
                            <td class="py-2 px-3 text-right">${t.type === 'egreso' ? this.formatCurrency(t.monto) : '-'}</td>
                        </tr>
                    `).join('') : '<tr><td colspan="4" class="text-center py-4">No hay movimientos</td></tr>';
                }

                const headerHtml = isSummary
                    ? `<th class="py-2 px-3 text-left">Categoría</th><th class="py-2 px-3 text-right">Monto</th>`
                    : `<th class="py-2 px-3 text-left">Fecha</th><th class="py-2 px-3 text-left">Categoría</th><th class="py-2 px-3 text-right">Ingreso</th><th class="py-2 px-3 text-right">Egreso</th>`;

                const footerHtml = isSummary
                    ? `<div class="mt-4 p-3 bg-gray-100 rounded-lg flex justify-end font-semibold"><span>Subtotal: <span class="${totalIngresos > 0 ? 'text-green-500' : 'text-red-500'}">${this.formatCurrency(totalIngresos || totalEgresos)}</span></span></div>`
                    : `<div class="mt-4 p-3 bg-gray-100 rounded-lg flex justify-between font-semibold"><span>Subtotal Ingresos: <span class="text-green-500">${this.formatCurrency(totalIngresos)}</span></span><span>Subtotal Egresos: <span class="text-red-500">${this.formatCurrency(totalEgresos)}</span></span></div>`;

                return `
                    <h3 class="text-xl font-semibold mb-3">${title}</h3>
                    <div class="overflow-auto max-h-96 rounded-lg shadow">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200 sticky top-0">
                                <tr>${headerHtml}</tr>
                            </thead>
                            <tbody>${rowsHtml}</tbody>
                        </table>
                    </div>
                    ${footerHtml}
                `;
            },

            showDataEntryView(date) {
                const block = this.state.currentBlock;
                this.switchView('data-entry-view');
                
                const title = block === 'general' ? 'Ingresos y Egresos Generales' : 'Banco';
                this.dom.dataEntryTitle.textContent = `Cargar Datos para: ${title}`;
                this.dom.sharedDate.value = date;
                this.state.currentTransactions = [];
                this.renderAddedTransactions();

                this.dom.ingresoCategoria.innerHTML = this.state.categories[block].ingreso.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
                this.dom.egresoCategoria.innerHTML = this.state.categories[block].egreso.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            },

            showEnvioColectasView() { this.switchView('envio-colectas-view'); this.renderEnvioColectas(); },
            showAportesView() { this.switchView('aportes-view'); this.renderAportes(); },
            showBalanceView() {
                this.switchView('balance-view');
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                this.dom.balanceStartDate.value = firstDay;
                this.dom.balanceEndDate.value = lastDay;
                this.generateAndDisplayBalance();
                this.dom.backFromBalanceFilterBtn.classList.add('hidden');
                this.dom.backFromBalanceBtn.classList.remove('hidden');
            },
            showDatePromptView(block) {
                this.state.currentBlock = block;
                this.switchView('date-prompt-view');
                const title = block === 'general' ? 'Ingresos y Egresos Generales' : 'Banco';
                this.dom.datePromptTitle.textContent = `Fecha para: ${title}`;
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                this.dom.entryDateInput.value = `${year}-${month}-${day}`;
            },
            showColectasOnlineView() {
                this.switchView('colectas-online-view');
            },
            hideColectasOnlineView() {
                this.showMainView();
            },
            showColectasCalculatorView() {
                this.switchView('colectas-calculator-view');
            },
            hideColectasCalculatorView() {
                this.showMainView();
            },
            showDateRangeResults() {
                const startDate = this.dom.startDateFilter.value;
                const endDate = this.dom.endDateFilter.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, selecciona un rango de fechas.", "error");
                    return;
                }

                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                
                this.dom.rangeResultsContainer.innerHTML = ''; // Clear previous results

                if (generalInRange.length === 0 && bancoInRange.length === 0) {
                    this.dom.rangeResultsContainer.innerHTML = '<p class="text-center text-gray-500">No se encontraron registros en el rango seleccionado.</p>';
                    this.dom.rangeResultsContainer.classList.remove('hidden');
                    return;
                }

                if (generalInRange.length > 0) {
                    this.renderRangeTable(this.dom.rangeResultsContainer, 'Resultados: Ingresos y Egresos Generales', generalInRange);
                }

                if (bancoInRange.length > 0) {
                    this.renderRangeTable(this.dom.rangeResultsContainer, 'Resultados: Movimientos de Banco', bancoInRange);
                }

                this.dom.rangeResultsContainer.classList.remove('hidden');
            },
            showEditDayView(date, block) {
                this.state.currentEditDay = { date, block };
                this.switchView('edit-day-view');

                const blockTitle = block === 'general' ? 'Generales' : 'Banco';
                this.dom.editDayTitle.textContent = `Editando Registros de ${blockTitle} - ${this.formatDate(date)}`;

                const transactions = block === 'general' ? this.state.generalTransactions : this.state.bancoTransactions;
                const dayTransactions = transactions.filter(t => t.fecha === date);
                
                this.dom.editDayList.innerHTML = '';
                if (dayTransactions.length === 0) {
                    this.dom.editDayList.innerHTML = '<p class="text-center text-gray-500">No hay registros para este día.</p>';
                    return;
                }

                dayTransactions.forEach(t => {
                    const item = document.createElement('div');
                    item.className = `flex justify-between items-center p-3 rounded-lg ${t.type === 'ingreso' ? 'bg-green-100' : 'bg-red-100'}`;
                    item.innerHTML = `
                        <div class="flex-1">
                            <p class="font-bold">${t.categoria}</p>
                            <p class="text-sm text-gray-600">${t.descripcion || 'Sin descripción'}</p>
                        </div>
                        <div class="font-semibold mx-4">${this.formatCurrency(t.monto)}</div>
                        <div class="flex gap-2">
                            <button data-action="edit-transaction" data-id="${t.id}" data-block="${block}" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-md transition-colors">Editar</button>
                            <button data-action="delete-transaction" data-id="${t.id}" data-block="${block}" class="text-xs bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md transition-colors">Eliminar</button>
                        </div>
                    `;
                    this.dom.editDayList.appendChild(item);
                });
            },
            showEditTransactionModal(id, block) {
                const transactions = block === 'general' ? this.state.generalTransactions : this.state.bancoTransactions;
                const transaction = transactions.find(t => t.id === id);

                if (!transaction) {
                    this.showToast("No se encontró la transacción.", "error");
                    return;
                }
                
                const categories = this.state.categories[block][transaction.type];
                const categoryOptions = categories.map(cat => `<option value="${cat.name}" ${cat.name === transaction.categoria ? 'selected' : ''}>${cat.name}</option>`).join('');

                this.state.pendingAction = () => this.handleUpdateTransaction();

                this.showModal({
                    title: `Editar ${transaction.type === 'ingreso' ? 'Ingreso' : 'Egreso'}`,
                    body: `
                        <form id="edit-transaction-form" class="space-y-4">
                            <input type="hidden" id="edit-transaction-id" value="${id}">
                            <input type="hidden" id="edit-transaction-block" value="${block}">
                            <div>
                                <label for="edit-transaction-categoria" class="block text-sm font-medium">Categoría</label>
                                <select id="edit-transaction-categoria" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">${categoryOptions}</select>
                            </div>
                            <div>
                                <label for="edit-transaction-descripcion" class="block text-sm font-medium">Descripción</label>
                                <textarea id="edit-transaction-descripcion" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">${transaction.descripcion || ''}</textarea>
                            </div>
                            <div>
                                <label for="edit-transaction-monto" class="block text-sm font-medium">Monto</label>
                                <input type="text" inputmode="numeric" id="edit-transaction-monto" required value="${transaction.monto}" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                            </div>
                        </form>
                    `,
                    buttons: [
                         { text: 'Cancelar', class: 'bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg transition-all', action: this.hideModal },
                         { text: 'Guardar Cambios', class: 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-all', action: () => { this.state.pendingAction(); } }
                    ]
                });
                
                const montoInput = document.getElementById('edit-transaction-monto');
                this.addFormattingListener(montoInput);
                montoInput.value = this.formatNumberWithThousands(montoInput.value);
            },
            addTransactionToList(type) {
                const form = type === 'ingreso' ? this.dom.ingresoForm : this.dom.egresoForm;
                const categoria = document.getElementById(`${type}-categoria`).value;
                const descripcion = document.getElementById(`${type}-descripcion`).value;
                const montoInput = document.getElementById(`${type}-monto`);
                const monto = this.getNumericValue(montoInput.value);
                const fecha = this.dom.sharedDate.value;

                if (!fecha || !categoria || isNaN(monto) || monto <= 0) {
                    this.showToast("Por favor, complete la fecha, categoría y un monto válido.", "error");
                    return;
                }

                const transaction = {
                    id: Date.now() + Math.random(), // Temporary unique ID
                    isNew: true,
                    type: type,
                    block: this.state.currentBlock,
                    fecha: fecha,
                    categoria: categoria,
                    descripcion: descripcion,
                    monto: monto,
                };

                this.state.currentTransactions.push(transaction);
                this.renderAddedTransactions();
                form.reset();
                this.showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} añadido a la lista.`, "success");
            },
            deleteTransactionFromList(id) {
                this.state.currentTransactions = this.state.currentTransactions.filter(t => t.id !== id);
                this.renderAddedTransactions();
                this.showToast("Registro eliminado de la lista.", "success");
            },
            renderAddedTransactions() {
                const list = this.dom.addedTransactionsList;
                list.innerHTML = '';
                if (this.state.currentTransactions.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-500">Aún no hay registros para guardar.</p>';
                    return;
                }
                this.state.currentTransactions.forEach(t => {
                    const item = document.createElement('div');
                    const bgColor = t.type === 'ingreso' ? 'bg-green-100' : 'bg-red-100';
                    const animationClass = t.isNew ? (t.type === 'ingreso' ? 'new-ingreso' : 'new-egreso') : '';
                    
                    item.className = `flex justify-between items-center p-2 rounded-lg ${bgColor} ${animationClass}`;
                    item.innerHTML = `
                        <div class="flex-1">
                            <span class="font-bold">${t.categoria}</span>
                            <span class="text-sm text-gray-600">${t.descripcion ? ' - ' + t.descripcion : ''}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-semibold">${this.formatCurrency(t.monto)}</span>
                            <button data-action="edit-temp" data-id="${t.id}" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded-md transition-colors">Editar</button>
                            <button data-action="delete-temp" data-id="${t.id}" class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-md transition-colors">Eliminar</button>
                        </div>
                    `;
                    list.appendChild(item);

                    if (t.isNew) {
                        setTimeout(() => {
                            const transactionInState = this.state.currentTransactions.find(trans => trans.id === t.id);
                            if (transactionInState) {
                                delete transactionInState.isNew;
                            }
                            item.classList.remove('new-ingreso', 'new-egreso');
                        }, 1500);
                    }
                });
            },
            handleDatePromptContinue() {
                const selectedDate = this.dom.entryDateInput.value;
                if (!selectedDate) {
                    this.showToast('Por favor, selecciona una fecha.', 'error');
                    return;
                }
                this.showDataEntryView(selectedDate);
            },
            showEditColectaModal(id) {
                const colecta = this.state.envioColectas.find(c => c.id === id);
                if (!colecta) return;

                this.state.pendingAction = () => this.handleUpdateColecta(id);

                this.showModal({
                    title: "Editar Colecta",
                    body: `
                        <form id="edit-colecta-form" class="space-y-4">
                            <div>
                                <label for="edit-colecta-fecha" class="block text-sm font-medium">Fecha</label>
                                <input type="text" id="edit-colecta-fecha" value="${colecta.fecha}" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                            </div>
                            <div>
                                <label for="edit-colecta-desc" class="block text-sm font-medium">Descripción</label>
                                <input type="text" id="edit-colecta-desc" value="${colecta.descripcion}" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                            </div>
                             <div>
                                <label for="edit-colecta-monto" class="block text-sm font-medium">Monto</label>
                                <input type="text" inputmode="numeric" id="edit-colecta-monto" value="${colecta.monto || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                            </div>
                        </form>
                    `,
                    buttons: [
                         { text: 'Cancelar', class: 'bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg transition-all', action: this.hideModal },
                         { text: 'Guardar', class: 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-all', action: () => { this.state.pendingAction(); } }
                    ]
                });
                const montoInput = document.getElementById('edit-colecta-monto');
                this.addFormattingListener(montoInput);
                montoInput.value = this.formatNumberWithThousands(montoInput.value);
            },
            async handleUpdateColecta(id) {
                const fecha = document.getElementById('edit-colecta-fecha').value;
                const descripcion = document.getElementById('edit-colecta-desc').value;
                const montoValue = document.getElementById('edit-colecta-monto').value;
                const monto = montoValue ? this.getNumericValue(montoValue) : null;

                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("envio_colectas"), id);
                    await updateDoc(docRef, { fecha, descripcion, monto });
                    this.hideModal();
                    this.showToast("Colecta actualizada.", "success");
                } catch (error) {
                    console.error("Error updating colecta:", error);
                    this.showToast("Error al actualizar la colecta.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            async handleUpdateAporte() {
                const key = document.getElementById('edit-aporte-key').value;
                const newValue = this.getNumericValue(document.getElementById('edit-aporte-value').value);

                if (isNaN(newValue)) {
                    this.showToast("Por favor, ingrese un valor numérico válido.", "error");
                    return;
                }

                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("configuracion_financiera"), "valores");
                    await updateDoc(docRef, { [key]: newValue });
                    this.hideModal();
                    this.showToast("Valor actualizado.", "success");
                } catch (error) {
                    console.error("Error updating aporte:", error);
                    this.showToast("Error al actualizar el valor.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            showEditAporteModal(key, label) {
                const currentValue = this.state.aportes[key] || 0;
                this.state.pendingAction = () => this.handleUpdateAporte();

                this.showModal({
                    title: `Editar: ${label}`,
                    body: `
                        <form id="edit-aporte-form">
                            <input type="hidden" id="edit-aporte-key" value="${key}">
                            <label for="edit-aporte-value" class="block text-sm font-medium">Nuevo Valor</label>
                            <input type="text" inputmode="numeric" id="edit-aporte-value" value="${currentValue}" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                        </form>
                    `,
                    buttons: [
                        { text: 'Cancelar', class: 'bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg transition-all', action: this.hideModal },
                        { text: 'Guardar', class: 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-all', action: () => { this.state.pendingAction(); } }
                    ]
                });
                const valueInput = document.getElementById('edit-aporte-value');
                this.addFormattingListener(valueInput);
                valueInput.value = this.formatNumberWithThousands(valueInput.value);
            },
            async handleUpdateTransaction() {
                const id = document.getElementById('edit-transaction-id').value;
                const block = document.getElementById('edit-transaction-block').value;
                const categoria = document.getElementById('edit-transaction-categoria').value;
                const descripcion = document.getElementById('edit-transaction-descripcion').value;
                const monto = this.getNumericValue(document.getElementById('edit-transaction-monto').value);

                if (!id || !block || !categoria || isNaN(monto) || monto <= 0) {
                    this.showToast("Por favor, complete todos los campos con valores válidos.", "error");
                    return;
                }

                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef(block === 'general' ? 'gestion_general' : 'gestion_banco');
                    const docRef = doc(collRef, id);
                    await updateDoc(docRef, { categoria, descripcion, monto });
                    
                    this.hideModal();
                    this.showToast("Transacción actualizada.", "success");
                    
                    this.showEditDayView(this.state.currentEditDay.date, this.state.currentEditDay.block);

                } catch (error) {
                    console.error("Error updating transaction:", error);
                    this.showToast("Error al actualizar la transacción.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            handleDeleteSingleTransaction(id, block) {
                this.state.pendingAction = () => this.deleteSingleTransaction(id, block);
                this.showModal({
                    title: "Confirmar Eliminación",
                    body: `<p>¿Estás seguro de que quieres eliminar esta transacción? Esta acción no se puede deshacer.</p>`,
                    buttons: [
                        { text: 'Cancelar', class: 'bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg transition-all', action: this.hideModal },
                        { text: 'Confirmar', class: 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-all', action: () => { this.state.pendingAction(); this.hideModal(); } }
                    ]
                });
            },
            async deleteSingleTransaction(id, block) {
                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef(block === 'general' ? 'gestion_general' : 'gestion_banco');
                    const docRef = doc(collRef, id);
                    await deleteDoc(docRef);

                    this.showToast("Transacción eliminada.", "success");

                    const transactions = block === 'general' ? this.state.generalTransactions : this.state.bancoTransactions;
                    const remaining = transactions.filter(t => t.fecha === this.state.currentEditDay.date && t.id !== id);
                    if (remaining.length > 0) {
                        this.showEditDayView(this.state.currentEditDay.date, this.state.currentEditDay.block);
                    } else {
                        this.showMainView();
                    }
                } catch (error) {
                    console.error("Error deleting transaction:", error);
                    this.showToast("Error al eliminar la transacción.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            showEditTempTransactionModal(id) {
                const transaction = this.state.currentTransactions.find(t => t.id === id);
                if (!transaction) return;

                const categories = this.state.categories[transaction.block][transaction.type];
                const categoryOptions = categories.map(cat => `<option value="${cat.name}" ${cat.name === transaction.categoria ? 'selected' : ''}>${cat.name}</option>`).join('');

                this.state.pendingAction = () => this.handleUpdateTempTransaction(id);

                this.showModal({
                    title: `Editar ${transaction.type === 'ingreso' ? 'Ingreso' : 'Egreso'} Temporal`,
                    body: `
                        <form id="edit-temp-transaction-form" class="space-y-4">
                            <div>
                                <label for="edit-temp-categoria" class="block text-sm font-medium">Categoría</label>
                                <select id="edit-temp-categoria" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">${categoryOptions}</select>
                            </div>
                            <div>
                                <label for="edit-temp-descripcion" class="block text-sm font-medium">Descripción</label>
                                <textarea id="edit-temp-descripcion" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">${transaction.descripcion || ''}</textarea>
                            </div>
                            <div>
                                <label for="edit-temp-monto" class="block text-sm font-medium">Monto</label>
                                <input type="text" inputmode="numeric" id="edit-temp-monto" required value="${transaction.monto}" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                            </div>
                        </form>
                    `,
                    buttons: [
                         { text: 'Cancelar', class: 'bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg transition-all', action: this.hideModal },
                         { text: 'Guardar Cambios', class: 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-all', action: () => { this.state.pendingAction(); } }
                    ]
                });
                const montoInput = document.getElementById('edit-temp-monto');
                this.addFormattingListener(montoInput);
                montoInput.value = this.formatNumberWithThousands(montoInput.value);
            },
            handleUpdateTempTransaction(id) {
                const index = this.state.currentTransactions.findIndex(t => t.id === id);
                if (index === -1) return;

                const categoria = document.getElementById('edit-temp-categoria').value;
                const descripcion = document.getElementById('edit-temp-descripcion').value;
                const monto = this.getNumericValue(document.getElementById('edit-temp-monto').value);

                if (!categoria || isNaN(monto) || monto <= 0) {
                    this.showToast("Por favor, complete los campos con valores válidos.", "error");
                    return;
                }

                this.state.currentTransactions[index] = {
                    ...this.state.currentTransactions[index],
                    categoria,
                    descripcion,
                    monto
                };

                this.renderAddedTransactions();
                this.hideModal();
                this.showToast("Registro temporal actualizado.", "success");
            },
            summarizeTransactionsByCategory(transactions) {
                const summary = { ingreso: {}, egreso: {} };
                transactions.forEach(t => {
                    const type = t.type;
                    const category = t.categoria;
                    if (!summary[type][category]) {
                        summary[type][category] = 0;
                    }
                    summary[type][category] += t.monto;
                });
                const toArray = (summaryObj) => Object.keys(summaryObj)
                    .map(key => ({ categoria: key, monto: summaryObj[key] }))
                    .sort((a, b) => b.monto - a.monto);
                return {
                    ingresos: toArray(summary.ingreso),
                    egresos: toArray(summary.egreso)
                };
            },
            generateCompleteBalancePDF() {
                const startDate = this.dom.balanceStartDate.value;
                const endDate = this.dom.balanceEndDate.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, selecciona un rango de fechas.", "error");
                    return;
                }
                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);

                if (generalInRange.length === 0 && bancoInRange.length === 0) {
                    this.showToast("No hay datos para generar el PDF detallado.", "error");
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(18);
                doc.text("Balance Completo Detallado", 14, 22);
                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`Período: ${this.formatDate(startDate)} al ${this.formatDate(endDate)}`, 14, 30);

                let totalIngresosGeneral = 0;
                let totalEgresosGeneral = 0;
                let totalIngresosBanco = 0;
                let totalEgresosBanco = 0;

                const generalBody = generalInRange.sort((a,b) => a.fecha.localeCompare(b.fecha)).map(t => {
                    if(t.type === 'ingreso') totalIngresosGeneral += t.monto;
                    else totalEgresosGeneral += t.monto;
                    return [
                        this.formatDate(t.fecha),
                        t.categoria,
                        t.descripcion || '',
                        t.type === 'ingreso' ? this.formatCurrency(t.monto) : '',
                        t.type === 'egreso' ? this.formatCurrency(t.monto) : ''
                    ];
                });

                const bancoBody = bancoInRange.sort((a,b) => a.fecha.localeCompare(b.fecha)).map(t => {
                    if(t.type === 'ingreso') totalIngresosBanco += t.monto;
                    else totalEgresosBanco += t.monto;
                    return [
                        this.formatDate(t.fecha),
                        t.categoria,
                        t.descripcion || '',
                        t.type === 'ingreso' ? this.formatCurrency(t.monto) : '',
                        t.type === 'egreso' ? this.formatCurrency(t.monto) : ''
                    ];
                });

                if (generalInRange.length > 0) {
                    doc.setFontSize(14);
                    doc.text("Movimientos Generales", 14, 40);
                    doc.autoTable({
                        startY: 45,
                        head: [['Fecha', 'Categoría', 'Descripción', 'Ingreso', 'Egreso']],
                        body: generalBody,
                        foot: [['', '', 'Subtotales', this.formatCurrency(totalIngresosGeneral), this.formatCurrency(totalEgresosGeneral)]],
                        theme: 'grid',
                        headStyles: { fillColor: [67, 56, 202] }, // indigo-600
                        footStyles: { fillColor: [209, 213, 219], textColor: [0,0,0], fontStyle: 'bold' },
                    });
                }

                if (bancoInRange.length > 0) {
                    const startY = doc.autoTable.previous ? doc.autoTable.previous.finalY + 15 : 40;
                    doc.setFontSize(14);
                    doc.text("Movimientos de Banco", 14, startY - 5);
                    doc.autoTable({
                        startY: startY,
                        head: [['Fecha', 'Categoría', 'Descripción', 'Ingreso', 'Egreso']],
                        body: bancoBody,
                        foot: [['', '', 'Subtotales', this.formatCurrency(totalIngresosBanco), this.formatCurrency(totalEgresosBanco)]],
                        theme: 'grid',
                        headStyles: { fillColor: [22, 163, 74] }, // green-600
                        footStyles: { fillColor: [209, 213, 219], textColor: [0,0,0], fontStyle: 'bold' },
                    });
                }

                const finalY = doc.autoTable.previous.finalY + 15;
                const totalIngresos = totalIngresosGeneral + totalIngresosBanco;
                const totalEgresos = totalEgresosGeneral + totalEgresosBanco;
                const saldoFinal = totalIngresos - totalEgresos;

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`Total Ingresos: ${this.formatCurrency(totalIngresos)}`, 14, finalY);
                doc.text(`Total Egresos: ${this.formatCurrency(totalEgresos)}`, 14, finalY + 7);
                doc.text(`Saldo Final: ${this.formatCurrency(saldoFinal)}`, 14, finalY + 14);

                doc.save(`Balance_Detallado_${startDate}_${endDate}.pdf`);
            },
            generateCompleteBalanceExcel() {
                const startDate = this.dom.balanceStartDate.value;
                const endDate = this.dom.balanceEndDate.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, selecciona un rango de fechas.", "error");
                    return;
                }
                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                const bancoInRange = this.state.bancoTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);

                if (generalInRange.length === 0 && bancoInRange.length === 0) {
                    this.showToast("No hay datos para generar el Excel detallado.", "error");
                    return;
                }

                const workbook = XLSX.utils.book_new();

                if (generalInRange.length > 0) {
                    const generalData = generalInRange.sort((a,b) => a.fecha.localeCompare(b.fecha)).map(t => ({
                        Fecha: this.formatDate(t.fecha),
                        Categoría: t.categoria,
                        Descripción: t.descripcion || '',
                        Ingreso: t.type === 'ingreso' ? t.monto : '',
                        Egreso: t.type === 'egreso' ? t.monto : ''
                    }));
                    const generalSheet = XLSX.utils.json_to_sheet(generalData);
                    XLSX.utils.book_append_sheet(workbook, generalSheet, 'General');
                }

                if (bancoInRange.length > 0) {
                    const bancoData = bancoInRange.sort((a,b) => a.fecha.localeCompare(b.fecha)).map(t => ({
                        Fecha: this.formatDate(t.fecha),
                        Categoría: t.categoria,
                        Descripción: t.descripcion || '',
                        Ingreso: t.type === 'ingreso' ? t.monto : '',
                        Egreso: t.type === 'egreso' ? t.monto : ''
                    }));
                    const bancoSheet = XLSX.utils.json_to_sheet(bancoData);
                    XLSX.utils.book_append_sheet(workbook, bancoSheet, 'Banco');
                }

                XLSX.writeFile(workbook, `Balance_Detallado_${startDate}_${endDate}.xlsx`);
            },
            generateGeneralSummaryPDF() {
                const startDate = this.dom.balanceStartDate.value;
                const endDate = this.dom.balanceEndDate.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, selecciona un rango de fechas.", "error");
                    return;
                }
                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                if (generalInRange.length === 0) {
                    this.showToast("No hay datos generales para generar el PDF.", "error");
                    return;
                }

                const summary = this.summarizeTransactionsByCategory(generalInRange);
                const totalIngresos = summary.ingresos.reduce((sum, item) => sum + item.monto, 0);
                const totalEgresos = summary.egresos.reduce((sum, item) => sum + item.monto, 0);
                const saldoFinal = totalIngresos - totalEgresos;

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(18);
                doc.text("Balance General Resumido", 14, 22);
                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`Período: ${this.formatDate(startDate)} al ${this.formatDate(endDate)}`, 14, 30);

                if (summary.ingresos.length > 0) {
                    doc.autoTable({
                        startY: 40,
                        head: [['Ingresos por Categoría', 'Monto']],
                        body: summary.ingresos.map(item => [item.categoria, this.formatCurrency(item.monto)]),
                        foot: [['Total Ingresos', this.formatCurrency(totalIngresos)]],
                        theme: 'striped',
                        headStyles: { fillColor: [22, 163, 74] }, // green-600
                        footStyles: { fillColor: [209, 213, 219], textColor: [0,0,0], fontStyle: 'bold' },
                    });
                }

                if (summary.egresos.length > 0) {
                    doc.autoTable({
                        startY: doc.autoTable.previous.finalY + 10,
                        head: [['Egresos por Categoría', 'Monto']],
                        body: summary.egresos.map(item => [item.categoria, this.formatCurrency(item.monto)]),
                        foot: [['Total Egresos', this.formatCurrency(totalEgresos)]],
                        theme: 'striped',
                        headStyles: { fillColor: [220, 38, 38] }, // red-600
                        footStyles: { fillColor: [209, 213, 219], textColor: [0,0,0], fontStyle: 'bold' },
                    });
                }

                const finalY = doc.autoTable.previous.finalY + 15;
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`Saldo Final (General): ${this.formatCurrency(saldoFinal)}`, 14, finalY);

                doc.save(`Balance_General_Resumido_${startDate}_${endDate}.pdf`);
            },
            generateGeneralSummaryExcel() {
                const startDate = this.dom.balanceStartDate.value;
                const endDate = this.dom.balanceEndDate.value;
                if (!startDate || !endDate) {
                    this.showToast("Por favor, selecciona un rango de fechas.", "error");
                    return;
                }
                const generalInRange = this.state.generalTransactions.filter(t => t.fecha >= startDate && t.fecha <= endDate);
                if (generalInRange.length === 0) {
                    this.showToast("No hay datos generales para generar el Excel.", "error");
                    return;
                }

                const summary = this.summarizeTransactionsByCategory(generalInRange);
                const totalIngresos = summary.ingresos.reduce((sum, item) => sum + item.monto, 0);
                const totalEgresos = summary.egresos.reduce((sum, item) => sum + item.monto, 0);
                const saldoFinal = totalIngresos - totalEgresos;

                const worksheetData = [
                    ["Balance General Resumido"],
                    [`Período: ${this.formatDate(startDate)} al ${this.formatDate(endDate)}`],
                    [], // Spacer row
                    ["Ingresos por Categoría", "Monto"],
                    ...summary.ingresos.map(item => [item.categoria, item.monto]),
                    ["Total Ingresos", totalIngresos],
                    [], // Spacer row
                    ["Egresos por Categoría", "Monto"],
                    ...summary.egresos.map(item => [item.categoria, item.monto]),
                    ["Total Egresos", totalEgresos],
                    [], // Spacer row
                    ["Saldo Final", saldoFinal]
                ];

                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Resumen General');
                XLSX.writeFile(workbook, `Balance_General_Resumido_${startDate}_${endDate}.xlsx`);
            },
            downloadDateRangePDF() { /* ... */ },

            // --- CATEGORY MANAGEMENT ---
            async checkAndSeedCategories() {
                const collRef = this.getCollectionRef("categorias");
                if (!collRef) return;
                const snapshot = await getDocs(collRef);
                if (snapshot.empty) {
                    console.log("Seeding default categories...");
                    const defaultCategories = {
                        general: {
                            ingreso: ["COLECTAS IMPERADAS", "COLECTAS PARROQUIA", "DONACIONES", "BENEFICIOS", "ESTIPENDOS", "OTRO"],
                            egreso: ["DEUDA OBISPADO", "SUELDO CAMILA", "SUELDO JULIO", "CARGAS SOCIALES EMPLEADOS", "ASIGNACION P.ADAN", "ASIGNACION P.JORGE", "MUTUAL DE LOS SACERDOTES", "COMBUSTIBLE", "LITURGIA", "EMPLEADA DE LA CASA PARROQUIAL", "SEGUROS DE LOS AUTOS", "APORTE PARA SEMINARIO", "MANTEMIENTO VEHICULOS", "MANTENIMIENTO DE LA CASA", "COMESTIBLE CASA PARROQUIAL", "SERVICIOS DE INTERNET", "OTRO"]
                        },
                        banco: {
                            ingreso: ["DEPOSITO CAPILLA BONPLAND", "DEPOSITO DE COLECTAS", "OTRO"],
                            egreso: ["DEBITO AUTOMATICO", "EXTRACCION", "OTRO"]
                        }
                    };
                    const batch = writeBatch(this.state.db);
                    for (const block in defaultCategories) {
                        for (const type in defaultCategories[block]) {
                            defaultCategories[block][type].forEach(name => {
                                const newDocRef = doc(collRef);
                                batch.set(newDocRef, { name, block, type });
                            });
                        }
                    }
                    await batch.commit();
                }
            },
            listenToCategories() {
                const collRef = this.getCollectionRef("categorias");
                if (!collRef) return;
                onSnapshot(collRef, (snapshot) => {
                    const loadedCategories = {
                        general: { ingreso: [], egreso: [] },
                        banco: { ingreso: [], egreso: [] }
                    };
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        loadedCategories[data.block][data.type].push({ id: doc.id, ...data });
                    });
                    for (const block in loadedCategories) {
                        for (const type in loadedCategories[block]) {
                            loadedCategories[block][type].sort((a, b) => a.name.localeCompare(b.name));
                        }
                    }
                    this.state.categories = loadedCategories;
                    if (this.state.currentView === 'category-management-view') {
                        this.renderCategoryLists();
                    }
                });
            },
            showCategoryManagementView() {
                this.switchView('category-management-view');
                this.renderCategoryLists();
            },
            renderCategoryLists() {
                this.dom.categoryGeneralIngresoContainer.innerHTML = this.createCategorySectionHTML('general', 'ingreso', 'Ingresos', 'green');
                this.dom.categoryGeneralEgresoContainer.innerHTML = this.createCategorySectionHTML('general', 'egreso', 'Egresos', 'red');
                this.dom.categoryBancoIngresoContainer.innerHTML = this.createCategorySectionHTML('banco', 'ingreso', 'Ingresos', 'green');
                this.dom.categoryBancoEgresoContainer.innerHTML = this.createCategorySectionHTML('banco', 'egreso', 'Egresos', 'red');
            },
            createCategorySectionHTML(block, type, title, color) {
                const categories = this.state.categories[block][type];
                let listItems = categories.map(cat => `
                    <li class="flex justify-between items-center p-2 hover:bg-gray-100 rounded-md">
                        <span>${cat.name}</span>
                        <div class="flex gap-2">
                            <button data-action="edit-category" data-id="${cat.id}" data-name="${cat.name}" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-md transition-colors">Editar</button>
                            <button data-action="delete-category" data-id="${cat.id}" data-name="${cat.name}" class="text-xs bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md transition-colors">Eliminar</button>
                        </div>
                    </li>
                `).join('');

                return `
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <h4 class="text-xl font-semibold mb-3 text-${color}-500">${title}</h4>
                        <ul class="space-y-2 mb-4 h-48 overflow-y-auto pr-2">${listItems}</ul>
                        <div class="flex gap-2">
                            <input type="text" id="new-category-${block}-${type}" placeholder="Nueva categoría..." class="flex-grow p-2 border border-gray-300 rounded-lg bg-white">
                            <button data-action="add-category" data-block="${block}" data-type="${type}" class="bg-${color}-500 hover:bg-${color}-600 text-white font-semibold px-4 py-2 rounded-lg transition-colors">Añadir</button>
                        </div>
                    </div>
                `;
            },
            async handleAddCategory(block, type) {
                const input = document.getElementById(`new-category-${block}-${type}`);
                const name = input.value.trim();
                if (!name) {
                    this.showToast("El nombre de la categoría no puede estar vacío.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef("categorias");
                    await addDoc(collRef, { name, block, type });
                    input.value = '';
                    this.showToast("Categoría añadida.", "success");
                } catch (error) {
                    console.error("Error adding category:", error);
                    this.showToast("No se pudo añadir la categoría.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            showEditCategoryModal(id, currentName) {
                this.state.pendingAction = () => this.handleUpdateCategory(id);
                this.showModal({
                    title: "Editar Categoría",
                    body: `
                        <form id="edit-category-form">
                            <label for="edit-category-name" class="block text-sm font-medium">Nuevo Nombre</label>
                            <input type="text" id="edit-category-name" value="${currentName}" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                        </form>
                    `,
                    buttons: [
                        { text: 'Cancelar', class: 'bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg transition-all', action: this.hideModal },
                        { text: 'Guardar', class: 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-all', action: () => { this.state.pendingAction(); } }
                    ]
                });
            },
            async handleUpdateCategory(id) {
                const newName = document.getElementById('edit-category-name').value.trim();
                if (!newName) {
                    this.showToast("El nombre no puede estar vacío.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("categorias"), id);
                    await updateDoc(docRef, { name: newName });
                    this.hideModal();
                    this.showToast("Categoría actualizada.", "success");
                } catch (error) {
                    console.error("Error updating category:", error);
                    this.showToast("Error al actualizar la categoría.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            handleDeleteCategory(id, name) {
                this.state.pendingAction = () => this.deleteCategory(id);
                this.showModal({
                    title: "Confirmar Eliminación",
                    body: `<p>¿Estás seguro de que quieres eliminar la categoría "<strong>${name}</strong>"?</p>`,
                    buttons: [
                        { text: 'Cancelar', class: 'bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg transition-all', action: this.hideModal },
                        { text: 'Eliminar', class: 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-all', action: () => { this.state.pendingAction(); this.hideModal(); } }
                    ]
                });
            },
            async deleteCategory(id) {
                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("categorias"), id);
                    await deleteDoc(docRef);
                    this.showToast("Categoría eliminada.", "success");
                } catch(error) {
                    console.error("Error deleting category:", error);
                    this.showToast("Error al eliminar la categoría.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            // --- REMINDERS MANAGEMENT ---
            showRemindersManagementView() {
                this.switchView('reminders-management-view');
                this.renderRemindersList();
            },
            listenToReminders() {
                const collRef = this.getCollectionRef("recordatorios");
                if (!collRef) return;
                onSnapshot(collRef, (snapshot) => {
                    this.state.reminders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(this.state.currentView === 'reminders-management-view') {
                        this.renderRemindersList();
                    }
                    this.updateReminders();
                });
            },
            renderRemindersList() {
                const container = this.dom.remindersListContainer;
                container.innerHTML = '';
                if (this.state.reminders.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">No hay alertas personalizadas.</p>';
                    return;
                }
                const sortedReminders = [...this.state.reminders].sort((a,b) => a.fecha.localeCompare(b.fecha));

                sortedReminders.forEach(reminder => {
                    const item = document.createElement('div');
                    const isCompleted = reminder.estado === 'completado';
                    item.className = `p-3 rounded-lg ${isCompleted ? 'bg-gray-200 opacity-60' : 'bg-gray-100'}`;
                    item.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-bold ${isCompleted ? 'line-through' : ''}">${reminder.titulo}</p>
                                <p class="text-sm text-gray-600">${reminder.descripcion || 'Sin descripción'}</p>
                                <p class="text-xs text-gray-500 mt-1">${this.formatDate(reminder.fecha)} - <span class="font-semibold">${isCompleted ? 'Completado' : 'Pendiente'}</span></p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 items-end">
                                <button data-action="toggle-reminder-status" data-id="${reminder.id}" class="text-xs ${isCompleted ? 'bg-blue-500 hover:bg-blue-600' : 'bg-green-500 hover:bg-green-600'} text-white px-3 py-1 rounded-md transition-colors">${isCompleted ? 'Marcar Pendiente' : 'Completar'}</button>
                                <button data-action="edit-reminder" data-id="${reminder.id}" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-md transition-colors">Editar</button>
                                <button data-action="delete-reminder" data-id="${reminder.id}" class="text-xs bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md transition-colors">Eliminar</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            },
            async handleAddReminder() {
                const title = this.dom.reminderTitle.value.trim();
                const date = this.dom.reminderDate.value;
                const description = this.dom.reminderDescription.value.trim();
                if (!title || !date) {
                    this.showToast("El título y la fecha son obligatorios.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const collRef = this.getCollectionRef("recordatorios");
                    await addDoc(collRef, { 
                        titulo: title, 
                        fecha: date,
                        descripcion: description,
                        estado: 'pendiente' // Default status
                    });
                    this.dom.newReminderForm.reset();
                    this.showToast("Alerta añadida.", "success");
                } catch (error) {
                    console.error("Error adding reminder:", error);
                    this.showToast("No se pudo añadir la alerta.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            showEditReminderModal(id) {
                const reminder = this.state.reminders.find(r => r.id === id);
                if (!reminder) return;

                this.state.pendingAction = () => this.handleUpdateReminder(id);

                this.showModal({
                    title: "Editar Alerta",
                    body: `
                        <form id="edit-reminder-form" class="space-y-4">
                            <div>
                                <label for="edit-reminder-title" class="block text-sm font-medium">Título</label>
                                <input type="text" id="edit-reminder-title" value="${reminder.titulo}" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                            </div>
                            <div>
                                <label for="edit-reminder-date" class="block text-sm font-medium">Fecha</label>
                                <input type="date" id="edit-reminder-date" value="${reminder.fecha}" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">
                            </div>
                            <div>
                                <label for="edit-reminder-description" class="block text-sm font-medium">Descripción</label>
                                <textarea id="edit-reminder-description" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white">${reminder.descripcion || ''}</textarea>
                            </div>
                        </form>
                    `,
                    buttons: [
                        { text: 'Cancelar', class: 'bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg transition-all', action: this.hideModal },
                        { text: 'Guardar', class: 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-all', action: () => { this.state.pendingAction(); } }
                    ]
                });
            },
            async handleUpdateReminder(id) {
                const title = document.getElementById('edit-reminder-title').value.trim();
                const date = document.getElementById('edit-reminder-date').value;
                const description = document.getElementById('edit-reminder-description').value.trim();
                if (!title || !date) {
                    this.showToast("El título y la fecha no pueden estar vacíos.", "error");
                    return;
                }
                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("recordatorios"), id);
                    await updateDoc(docRef, { titulo: title, fecha: date, descripcion: description });
                    this.hideModal();
                    this.showToast("Alerta actualizada.", "success");
                } catch(error) {
                    console.error("Error updating reminder:", error);
                    this.showToast("Error al actualizar la alerta.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            handleDeleteReminder(id) {
                this.state.pendingAction = () => this.deleteReminder(id);
                this.showModal({
                    title: "Confirmar Eliminación",
                    body: `<p>¿Estás seguro de que quieres eliminar esta alerta?</p>`,
                    buttons: [
                        { text: 'Cancelar', class: 'bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg transition-all', action: this.hideModal },
                        { text: 'Eliminar', class: 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-all', action: () => { this.state.pendingAction(); this.hideModal(); } }
                    ]
                });
            },
            async deleteReminder(id) {
                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("recordatorios"), id);
                    await deleteDoc(docRef);
                    this.showToast("Alerta eliminada.", "success");
                } catch(error) {
                    console.error("Error deleting reminder:", error);
                    this.showToast("Error al eliminar la alerta.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },
            async handleToggleReminderStatus(id, forceState = null) {
                const reminder = this.state.reminders.find(r => r.id === id);
                if (!reminder) return;
                
                const newStatus = forceState ? forceState : (reminder.estado === 'pendiente' ? 'completado' : 'pendiente');

                this.toggleLoader(true);
                try {
                    const docRef = doc(this.getCollectionRef("recordatorios"), id);
                    await updateDoc(docRef, { estado: newStatus });
                    this.showToast(`Alerta marcada como ${newStatus}.`, "success");
                } catch(error) {
                    console.error("Error updating reminder status:", error);
                    this.showToast("Error al actualizar el estado.", "error");
                } finally {
                    this.toggleLoader(false);
                }
            },

            // --- NOTIFICATIONS ---
            updateReminders() {
                const notifications = this.getUpcomingNotifications();
                const pendingNotifications = notifications.filter(n => n.estado === 'pendiente');

                this.dom.notificationBadge.classList.toggle('hidden', pendingNotifications.length === 0);
                this.updateNotificationTicker(pendingNotifications);
                
                if (pendingNotifications.length > 0) {
                    this.dom.remindersList.innerHTML = pendingNotifications.map(n => `
                        <li class="border-b border-gray-200 pb-3 last:border-b-0">
                            <p class="font-semibold">${n.title}</p>
                            <p class="text-slate-600 text-xs my-1">${n.descripcion || 'Sin descripción'}</p>
                            <div class="flex justify-between items-center mt-2">
                                <p class="text-slate-500 text-xs">${n.dateText} (${n.daysAway === 0 ? 'Hoy' : `en ${n.daysAway} día(s)`})</p>
                                <button data-action="complete-reminder" data-id="${n.id}" class="text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded-md transition-colors">Completado</button>
                            </div>
                        </li>
                    `).join('');
                } else {
                    this.dom.remindersList.innerHTML = '<li><p class="text-slate-500">No hay alertas pendientes.</p></li>';
                }
            },

            updateNotificationTicker(pendingNotifications) {
                clearInterval(this.state.tickerInterval);
                this.state.tickerInterval = null;
                const container = this.dom.notificationTickerContainer;
                const ticker = this.dom.notificationTicker;

                if (pendingNotifications.length === 0) {
                    container.classList.add('hidden');
                    return;
                }

                container.classList.remove('hidden');
                this.state.currentTickerIndex = 0;

                const showNextItem = () => {
                    const currentNotifications = this.getUpcomingNotifications().filter(n => n.estado === 'pendiente');
                    if (currentNotifications.length === 0) {
                        container.classList.add('hidden');
                        clearInterval(this.state.tickerInterval);
                        return;
                    }

                    const notification = currentNotifications[this.state.currentTickerIndex];
                    
                    ticker.style.opacity = 0;

                    setTimeout(() => {
                        ticker.innerHTML = `
                            <span class="font-semibold truncate">${notification.title}:</span>
                            <span class="ml-2 truncate">${notification.descripcion || 'Próximamente...'}</span>
                        `;
                        ticker.style.opacity = 1;
                    }, 500);

                    this.state.currentTickerIndex = (this.state.currentTickerIndex + 1) % currentNotifications.length;
                };

                showNextItem();
                if (pendingNotifications.length > 1) {
                    this.state.tickerInterval = setInterval(showNextItem, 5000);
                }
            },

            getUpcomingNotifications() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const upcoming = [];
                const reminderDays = 15;
                
                // Process dynamic reminders
                this.state.reminders.forEach(reminder => {
                    const [year, month, day] = reminder.fecha.split('-').map(Number);
                    const reminderDate = new Date(year, month - 1, day);
                    const timeDiff = reminderDate.getTime() - today.getTime();
                    const daysAway = Math.ceil(timeDiff / (1000 * 3600 * 24));

                    if (daysAway >= 0 && daysAway <= reminderDays) {
                        upcoming.push({ 
                            id: reminder.id,
                            title: reminder.titulo, 
                            descripcion: reminder.descripcion,
                            dateText: this.formatDate(reminder.fecha), 
                            daysAway,
                            estado: reminder.estado
                        });
                    }
                });

                return upcoming.sort((a,b) => a.daysAway - b.daysAway);
            },

            // --- NEW: COLECTAS CALCULATOR LOGIC ---
            calculateColectas() {
                const imperadas = this.getNumericValue(this.dom.colectasImperadasInput.value);
                const parroquia = this.getNumericValue(this.dom.colectasParroquiaInput.value);

                const resultado = imperadas * 0.5;
                const total = resultado + parroquia;

                this.dom.colectasImperadasResult.value = this.formatCurrency(resultado);
                this.dom.colectasTotal.value = this.formatCurrency(total);
            },
        };

        // Start the application
        App.init();

    </script>
</body>
</html>
